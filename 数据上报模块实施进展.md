# 数据上报模块实施进展

## 已完成工作

### ✅ 阶段一：数据库设计和基础架构（已完成）

#### 1. Device 表扩展
**文件**: `backend/src/main/java/com/cdutetc/ems/entity/Device.java`

**新增字段（辐射设备上报专用）**:
- `nuclide` VARCHAR(50) - 核素（如 Cs-137）
- `inspection_machine_number` VARCHAR(50) - 探伤机编号（山东协议 Ma字段）
- `source_number` VARCHAR(12) - 放射源编号（山东协议 Rno字段）
- `source_type` VARCHAR(2) - 放射源类型（山东协议 Xtype字段）
- `original_activity` VARCHAR(20) - 放射源原始活度（山东协议 LastAct字段）
- `current_activity` VARCHAR(20) - 放射源当前活度（山东协议 NowAct字段）
- `source_production_date` DATE - 放射源出厂日期（山东协议 SourceTime字段）

**已存在的上报配置字段**:
- `data_report_enabled` BOOLEAN - 是否启用数据上报
- `report_protocol` VARCHAR(20) - 上报协议（SICHUAN/SHANDONG）
- `gps_priority` VARCHAR(20) - GPS优先级（BDS/LBS/BDS_THEN_LBS）
- `last_report_time` DATETIME - 最后上报时间
- `last_report_status` VARCHAR(20) - 最后上报状态（SUCCESS/FAILED）
- `last_report_error` TEXT - 最后上报错误信息
- `total_report_count` INT - 总上报次数
- `success_report_count` INT - 成功上报次数

#### 2. DTO 更新
**文件**:
- `backend/src/main/java/com/cdutetc/ems/dto/response/DeviceResponse.java`
- `backend/src/main/java/com/cdutetc/ems/dto/request/DeviceUpdateRequest.java`

**更新内容**:
- 添加辐射设备上报专用字段映射
- 更新 `fromDevice()` 方法包含所有新字段

#### 3. Redis 缓存服务
**文件**: `backend/src/main/java/com/cdutetc/ems/service/DeviceReportConfigCacheService.java`

**功能**:
- Cache Aside 模式缓存设备上报配置
- 缓存Key: `device:report:config:{deviceCode}`
- TTL: 3600秒（1小时）
- 提供缓存预热、清除、批量操作
- 降级处理：Redis异常时自动降级到MySQL

**方法**:
```java
DeviceReportConfig getReportConfig(String deviceCode)  // 获取配置
void evictReportConfig(String deviceCode)              // 清除缓存
void evictReportConfigBatch(List<String> deviceCodes) // 批量清除
void warmUpCache()                                     // 预热缓存
```

#### 4. DeviceReportConfig DTO
**文件**: `backend/src/main/java/com/cdutetc/ems/dto/DeviceReportConfig.java`

**用途**: Redis 缓存专用DTO，只包含必要字段，减少缓存占用

#### 5. DeviceService 更新
**文件**: `backend/src/main/java/com/cdutetc/ems/service/DeviceService.java`

**更新内容**:
- 注入 `DeviceReportConfigCacheService`
- `updateDevice()` 方法支持更新辐射设备字段
- 设备更新后自动清除Redis缓存

#### 6. DataReportLog 实体和Repository
**文件**:
- `backend/src/main/java/com/cdutetc/ems/entity/DataReportLog.java`
- `backend/src/main/java/com/cdutetc/ems/repository/DataReportLogRepository.java`

**表结构**: `ems_data_report_log`
- 记录每次上报的详细信息
- 索引: (device_id, report_time), status, report_protocol
- 支持分页查询、统计、失败日志查询

#### 7. 依赖配置
**文件**: `backend/pom.xml`

**新增依赖**:
```xml
<!-- BouncyCastle SM2加密（国密算法） -->
<dependency>
    <groupId>org.bouncycastle</groupId>
    <artifactId>bcprov-jdk15to18</artifactId>
    <version>1.76</version>
</dependency>
<dependency>
    <groupId>org.bouncycastle</groupId>
    <artifactId>bcpkix-jdk15to18</artifactId>
    <version>1.76</version>
</dependency>
```

#### 8. 配置类
**文件**:
- `backend/src/main/java/com/cdutetc/ems/config/DataReportProperties.java`
- `backend/src/main/java/com/cdutetc/ems/config/DataReportAsyncConfig.java`

**配置项**（application.yaml）:
```yaml
app:
  data-report:
    sichuan:
      url: http://59.225.208.12:18085/access/data/report
      api-key: AK-9lKIK7RZrHxPsxq9eYzb2BWBCq8WeSwIPC2e
      enabled: true
      connect-timeout: 10000
      read-timeout: 30000
      max-retries: 3

    shandong:
      host: 117.73.252.128
      port: 8091
      enabled: true
      password: 123456
      connect-timeout: 10000
      so-timeout: 30000

    async:
      core-pool-size: 5
      max-pool-size: 10
      queue-capacity: 100
```

---

## 待实施工作

### ⏳ 阶段二：核心服务实现（进行中）

#### 1. SM2 加密服务（⏳ 下一步）
**文件**: `backend/src/main/java/com/cdutetc/ems/service/Sm2EncryptionService.java`

**功能**:
- SM2 公钥加密
- 签名生成和验证
- 密钥管理

#### 2. HJ/T212 协议服务
**文件**: `backend/src/main/java/com/cdutetc/ems/service/HJT212ProtocolService.java`

**功能**:
- 构建3051实时数据上报包
- 构建3052补传数据包
- CRC16校验
- ASCII编码
- 包头包尾处理

#### 3. 四川上报服务
**文件**: `backend/src/main/java/com/cdutetc/ems/service/report/SichuanDataReportService.java`

**功能**:
- HTTP POST上报
- SM2加密
- JSON payload构建
- 错误重试

#### 4. 山东上报服务
**文件**: `backend/src/main/java/com/cdutetc/ems/service/report/ShandongDataReportService.java`

**功能**:
- TCP连接管理
- HJ/T212协议发送
- 接收应答
- 自动重连

#### 5. 协议路由服务
**文件**: `backend/src/main/java/com/cdutetc/ems/service/report/DataReportRouterService.java`

**功能**:
- 根据设备配置路由到对应协议
- 异步上报
- 设备状态更新
- 日志记录

#### 6. 事件监听器
**文件**: `backend/src/main/java/com/cdutetc/ems/listener/DataReportEventListener.java`

**功能**:
- 监听 `DeviceDataReceivedEvent`
- 异步触发上报
- 不阻塞主流程

---

## 数据库表结构

### ems_device（已扩展）
```sql
-- 辐射设备上报专用字段（新增）
nuclide VARCHAR(50) DEFAULT 'Cs-137'
inspection_machine_number VARCHAR(50)
source_number VARCHAR(12)
source_type VARCHAR(2) DEFAULT '01'
original_activity VARCHAR(20)
current_activity VARCHAR(20)
source_production_date DATE

-- 上报配置（已存在）
data_report_enabled BOOLEAN DEFAULT FALSE
report_protocol VARCHAR(20) DEFAULT 'SICHUAN'
gps_priority VARCHAR(20) DEFAULT 'BDS'
last_report_time DATETIME
last_report_status VARCHAR(20)
last_report_error TEXT
total_report_count INT DEFAULT 0
success_report_count INT DEFAULT 0
```

### ems_data_report_log（新增）
```sql
CREATE TABLE ems_data_report_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    device_id BIGINT NOT NULL,
    device_code VARCHAR(50),
    report_protocol VARCHAR(20) NOT NULL,
    report_time DATETIME NOT NULL,
    request_payload TEXT,
    response_body TEXT,
    status VARCHAR(20) NOT NULL,
    http_status INT,
    error_message TEXT,
    duration_ms BIGINT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_device_time (device_id, report_time),
    INDEX idx_status (status),
    INDEX idx_protocol (report_protocol),
    FOREIGN KEY (device_id) REFERENCES ems_device(id) ON DELETE CASCADE
);
```

---

## 缓存策略

### Redis 缓存
**Key**: `device:report:config:{deviceCode}`
**Value**: DeviceReportConfig (JSON)
**TTL**: 3600秒（1小时）

**更新时机**:
- 设备配置更新时：删除缓存
- 缓存未命中：从MySQL加载并写入Redis
- 启动时：预热启用上报的设备配置

**降级策略**:
- Redis读取失败 → 降级到MySQL
- Redis写入失败 → 不影响主流程，记录日志

---

## 当前状态

✅ **已完成**: 数据库设计、实体类、DTO、Repository、Redis缓存服务、配置类
⏳ **进行中**: 编译检查（Maven下载依赖中）
⏳ **待实施**: SM2加密、HJ/T212协议、上报服务、事件监听器、前端界面

---

## 下一步计划

1. ✅ 等待编译完成
2. 实现SM2加密服务
3. 实现HJ/T212协议服务
4. 实现四川和山东上报服务
5. 实现协议路由和事件监听器
6. 前端配置界面开发
7. 集成测试

**预计剩余时间**: 2-3天
