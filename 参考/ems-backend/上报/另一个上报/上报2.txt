关键是他们人又少# 放射源监控设备与平台通信协议（2019.9.6）文档内容识别
该文档围绕放射源监控设备与数据中心平台的数据传输需求，参考HJ/T212-2005标准制定通信协议，明确通信方式、编码规则、数据上报/提取流程等核心内容，以下是完整梳理：


## 一、文档基础信息
- **文档目的**：实现放射源监控设备（固定/移动）与数据中心平台的规范化数据传输
- **参考标准**：HJ/T212-2005


## 二、通信方式与协议结构
### 1. 核心通信参数
- **通信协议**：TCP协议
- **平台监听信息**：IP地址为117.73.252.128，端口号为8091
- **数据编码格式**：所有通讯包均由ASCII码字符组成

### 2. 通讯包组成（含图片内容转文字）
文档中首张图片展示了通讯包的核心组成要素，包含两类关键信息：
- **基础包结构组件**：SIM卡号、包头、数据段长度、数据段、CRC校验、包尾
- **数据段核心字段**：请求编号、系统编号、命令编号、设备唯一标识、密码、标志位（请求/应答）、指令、数据、总包号、包号

### 3. 通讯包与数据段详细结构
#### （1）通讯包结构（对应文档“6.3.1”内容）
| 名称       | 类型         | 长度       | 描述                                                                 |
|------------|--------------|------------|----------------------------------------------------------------------|
| 包头       | 字符         | 2          | 固定为“##”                                                           |
| 数据段长度 | 十进制整数   | 4          | 表示数据段的ASCII字符数，示例：长度为255时，写为“0255”               |
| 数据段     | 字符         | 0≤l≤1024   | 变长数据（短信场景下最大长度为140字符），具体格式见“数据段结构”       |
| CRC校验    | 十六进制整数 | -          | 数据段的校验结果，若CRC校验错误，则执行超时逻辑                       |
| 包尾       | 字符         | 2          | 固定为“<CR><LF>”（即回车+换行）                                      |

#### （2）数据段结构（对应文档“6.3.2”内容）
| 名称         | 类型   | 长度 | 描述                                                                 |
|--------------|--------|------|----------------------------------------------------------------------|
| 请求编号QN   | 字符   | 20   | 精确到毫秒的时间戳，格式为“QN=YYYYMMDDHHMMSSZZZ”，唯一标识1个命令请求（适用于请求/通知命令） |
| 总包号PNUM   | 字符   | 4    | 指示本次通讯总共包含的数据包数量                                     |
| 包号PNO      | 字符   | -    | 指示当前数据包在总通讯包中的序号                                     |
| 系统编号ST   | 字符   | 5    | 格式为“ST=系统编号”，具体编号参考文档“6.5系统编码表”（文档未附具体编码表） |
| 命令编号CN   | 字符   | 7    | 格式为“CN=命令编号”，具体编号参考文档“6.5命令列表”（文档未附具体列表）   |
| 访问密码PW   | 字符   | 6    | 格式为“PW=访问密码”，用于设备与平台的身份验证                         |


## 三、核心编码规则
文档通过表格明确放射源监控相关数据的编码标准，涵盖设备标识、放射源属性、时间位置、设备状态4大类数据，具体如下：

| 数据类别       | 类型         | 编码因子 | 最大长度（位） | 备注                                                                 |
|----------------|--------------|----------|----------------|----------------------------------------------------------------------|
| 设备标识       | 设备编号     | MN       | 14             | 唯一标识现场监控设备                                                 |
|                | 探伤机编号   | Ma       | 6              | 标识与放射源配套的探伤设备                                           |
|                | 放射源编号   | Rno      | 12             | 唯一标识单个放射源                                                   |
| 放射源属性     | 放射源类型   | Xtype    | 2              | 编码含义：01=Ⅰ类、02=Ⅱ类、03=Ⅲ类、04=Ⅳ类、05=Ⅴ类                     |
|                | 放射源原始活度 | LastAct  | 9              | 格式示例：LastAct=2.700E004                                          |
|                | 放射源当前活度 | NowAct   | 9              | 格式示例：NowAct=1.300E004                                           |
|                | 放射源出厂时间 | SourceTime | 8          | 日期格式：YYYYMMDD（示例：20120101代表2012年1月1日）                 |
| 时间与位置     | 设备当前时间 | DateTime | 14             | 时间格式：YYYYMMDDHHMISS（示例：20101201010501代表2010年12月1日1时5分1秒） |
|                | GPS经度      | LONG     | 10             | 格式示例：LONG=11700.5398                                            |
|                | GPS纬度      | LAT      | 9              | 格式示例：LAT=3637.2522                                             |
|                | GPS标志      | -        | 1              | 编码含义：A=GPS提供位置、V=基站提供位置                               |
| 设备状态       | 剂量率       | Xvalue   | 10             | 格式示例：Xvalue=1000000.000                                         |
|                | 报警类型     | AlertType | 2             | 编码含义：01=源丢失、02=计数阻塞、03=欠压报警、04=低计数、05=通信故障 |
|                | 电源电量     | BattChar | 6              | 格式示例：BattChar=4.1234                                            |
|                | 源状态       | Sta      | 1              | 编码含义：1=源丢失、2=源工作、3=源到位                               |


## 四、关键数据交互流程
文档详细规定3种核心数据交互场景的指令格式、执行过程及备注，均通过表格呈现，具体如下：

### 1. 实时数据上报（命令编号：3051）
| 类别       | 项目         | 示例/说明                                                                                                                                                                                                 |
|------------|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 现场机     | 上传实时数据 | ST=61;CN=3051;PW=123456;CP=&&MN=01010101010101;Ma=000001;Rno=010101010101;Xtype=01;LastAct=2.700E004;NowAct=1.300E004;SourceTime=20120101;DataTime=20101201010501;LONG=11225.1333;LAT=3705.4300;Xvalue=1000000.000;Thres=100000.000;AlertType=01;BattChar=1000.0;Sig=1;&& |
| 上位机     | 通知（应答） | ST=91;CN=3051;PW=123456;CP=&&MN=01010101010101;Ma=000001;Rno=010101010101;DataTime=20101201010501;&&                                                                                                      |
| 执行过程   | -            | 现场机发送实时数据包→上位机接收后立即发回应答包                                                                                                                                                           |
| 备注       | -            | 1. 数据长度：下行（上位机→现场机）100字节，上行（现场机→上位机）267字节；<br>2. 发送频率：设备报警/故障时10~20秒1条，正常工作时5分钟1条                                                                 |

### 2. GPRS断开时数据补传（命令编号：3052）
| 类别       | 项目         | 示例/说明                                                                                                                                                                                                 |
|------------|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 现场机     | 上传补传数据 | ST=61;CN=3052;PW=123456;CP=&&MN=01010101010101;Ma=000001;Rno=010101010101;Xtype=01;LastAct=2.700E004;NowAct=1.300E004;SourceTime=20120101;DataTime=20101201010501;LONG=11225.1333;LAT=3705.4300;Xvalue=1000000.000;Thres=100000.000;AlertType=01;BattChar=1000.0;Sig=1;&& |
| 上位机     | 通知（应答） | ST=91;CN=3052;PW=123456;CP=&&MN=01010101010101;Ma=000001;Rno=010101010101;DataTime=20101201010501;&&                                                                                                      |
| 执行过程   | -            | 现场机在空闲时，从存储器中读取GPRS断开期间未发送的历史数据→逐条上传至上位机→上位机每接收1条数据，立即回发应答包                                                                                             |
| 备注       | -            | 1. 数据长度：与3051命令一致（下行100字节、上行267字节）；<br>2. 存储清空：所有补传数据发送完成后，设备自动清空存储器                                                                                       |

### 3. 历史数据主动提取（命令编号：2011）
| 类别       | 项目         | 示例/说明                                                                                                                                                                                                 |
|------------|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 使用命令   | 上位机-取历史数据 | QN=20101201010101001;ST=61;CN=2011;PW=123456;CP=&&MN=01010101010101;Ma=000001;Rno=010101010101;StartDataTime=20101201010101;EndDataTime=20101201021001;&&                                                  |
|            | 现场机-请求应答 | ST=91;CN=9011;PW=123456;CP=&&MN=01010101010101;Ma=000001;Rno=010101010101;QN=20101201010101001;QnRtn=1;&&                                                                                                |
|            | 现场机-上传历史数据 | ST=61;CN=2011;PW=123456;CP=&&MN=01010101010101;Ma=000001;Rno=010101010101;Xtype=01;LastAct=2.700E004;NowAct=1.300E004;SourceTime=20120101;DataTime=20101201010501;LONG=11225.1333;LAT=3705.4300;Xvalue=1000000.000;Thres=100000.000;AlertType=01;BattChar=1000.0;Sig=1;&& |
|            | 上位机-停止查看历史数据 | QN=20101201010101001;ST=61;CN=2012;PW=123456;CP=&&MN=01010101010101;Ma=000001;Rno=010101010101;&&                                                                                                      |
|            | 现场机-通知应答 | ST=91;CN=9013;PW=123456;CP=&&MN=01010101010101;Ma=000001;Rno=010101010101;QN=20101201010101001&&                                                                                                      |
| 使用字段   | QN           | 请求编号，用于关联命令与应答                                                                                                                                                                             |
|            | DataTime     | 数据时间，精确到秒                                                                                                                                                                                       |
|            | QnRtn        | 请求返回结果，指示历史数据提取请求的处理状态                                                                                                                                                             |
| 执行过程   | -            | 1. 上位机发送取历史数据命令→等待现场机应答；<br>2. 上位机通过应答中的QnRtn判断是否接收数据；<br>3. 接收所需数据后，上位机发送停止查看命令；<br>4. 收到现场机应答后，流程结束；<br>注：设备仅存储最近1周历史数据 |
| 备注       | -            | 1. 数据长度：取数命令（下行）155字节，请求应答（上行）106字节，历史数据（上行）267字节，停止命令（下行）97字节，通知应答（上行）97字节；<br>2. 数据存储：仅保留最近7天数据                                                                 |

