# EMS企业级MQTT设备管理云平台 - 生产环境配置

spring:
  # 数据库配置（生产环境，使用环境变量）
  datasource:
    url: ${DATABASE_URL:jdbc:mysql://mysql:3306/ems_db?useUnicode=true&characterEncoding=utf8&useSSL=true&serverTimezone=Asia/Shanghai}
    username: ${DATABASE_USERNAME:ems_user}
    password: ${DATABASE_PASSWORD:ems_password}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      pool-name: EMSHikariCP-Prod
      maximum-pool-size: 50
      minimum-idle: 10
      idle-timeout: 600000
      connection-timeout: 30000
      max-lifetime: 1800000
      leak-detection-threshold: 120000

  # JPA配置（生产环境）
  jpa:
    hibernate:
      ddl-auto: validate  # 生产环境使用validate，不自动更新表结构
    show-sql: false  # 生产环境不显示SQL
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQLDialect
        format_sql: false
        use_sql_comments: false
        jdbc:
          batch-size: 50
        order_inserts: true
        order_updates: true

  # Redis配置（生产环境，使用环境变量）
  data:
    redis:
      host: ${REDIS_HOST:redis}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DATABASE:0}
      timeout: 5000ms
      lettuce:
        pool:
          max-active: 20
          max-wait: -1ms
          max-idle: 10
          min-idle: 5

  
# 业务配置（生产环境）
ems:
  # MQTT配置（生产环境，使用环境变量）
  mqtt:
    host: ${MQTT_HOST:mosquitto}
    port: ${MQTT_PORT:1883}
    client-id: ${MQTT_CLIENT_ID:ems-backend-prod}
    username: ${MQTT_USERNAME:}
    password: ${MQTT_PASSWORD:}
    topic-prefix: ems
    qos: 1
    clean-session: true
    auto-reconnect: true
    connection-timeout: 60
    keep-alive-interval: 120

  # JWT配置（生产环境，使用环境变量）
  jwt:
    secret: ${JWT_SECRET:ems-jwt-secret-key-for-enterprise-mqtt-system-production-2024}
    expiration: ${JWT_EXPIRATION:3600000}  # 1小时 (毫秒)
    refresh-expiration: ${JWT_REFRESH_EXPIRATION:2592000000}  # 30天 (毫秒)

  # 文件上传配置（生产环境）
  file:
    upload-path: ${FILE_UPLOAD_PATH:/app/uploads}
    max-file-size: ${FILE_MAX_SIZE:5MB}  # 生产环境限制更小
    allowed-types: ${FILE_ALLOWED_TYPES:jpg,jpeg,png,pdf}  # 生产环境限制文件类型

  # 月度数据导出配置（生产环境）
  data-export:
    enabled: ${DATA_EXPORT_ENABLED:true}
    cron: ${DATA_EXPORT_CRON:"0 0 3 1 * ?"}  # 每月1号凌晨3点执行
    keep-months: ${DATA_EXPORT_KEEP_MONTHS:12}  # 生产环境保留更长时间
    export-path: ${DATA_EXPORT_PATH:/data/ems/exports}
    test-trigger: false  # 生产环境禁用测试触发
    export-format: ${DATA_EXPORT_FORMAT:sql}
    table-name: device_status_records
    mysqldump-path: ${MYSQLDUMP_PATH:/usr/bin/mysqldump}
    max-export-duration: 14400  # 4小时

# 日志配置（生产环境）
logging:
  level:
    root: INFO
    com.ems: INFO
    org.springframework.security: WARN
    org.springframework.web: WARN
    org.hibernate.SQL: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%logger{36}] - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%logger{50}] - %msg%n"
  file:
    name: ${LOG_FILE_PATH:/app/logs/ems-prod.log}
    max-size: 100MB
    max-history: 90
  logback:
    rollingpolicy:
      max-file-size: 100MB
      total-size-cap: 10GB

# 生产环境特定配置
debug: false

# 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  metrics:
    export:
      prometheus:
        enabled: true