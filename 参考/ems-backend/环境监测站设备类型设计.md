# 环境监测站设备类型详细设计

## 设备类型概述

**设备类型代码**: ENVIRONMENT
**显示名称**: 环境监测站
**数据表名**: `environment_device_status`
**MQTT主题模式**: `ems/environment/+/data`

## 数据格式对比分析

### 现有设备1：辐射监测仪（带GPS定位）
```json
{
  "src": 1,
  "msgtype": 1,
  "CPM": 123,
  "Batvolt": 3989,          // 毫伏 (mV)
  "time": "2025/01/15 14:30:45",
  "trigger": 1,
  "multi": 1,
  "way": 1,
  "BDS": { ... },           // GPS定位信息
  "LBS": { ... }            // 基站定位信息
}
```

### 现有设备2：环境监测站（多功能设备）
```json
{
  "src": 1,
  "CPM": 4,                 // 辐射计数值
  "temperature": 10,        // 温度 (°C)
  "wetness": 95,           // 湿度 (%)
  "windspeed": 0.2,        // 风速 (m/s)
  "total": 144.1,          // 综合环境指数
  "battery": 11.9          // 电池电压 (V)
}
```

## 数据模型设计

### 1. 数据库表结构
```sql
CREATE TABLE environment_device_status (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    device_id VARCHAR(50) NOT NULL,
    record_time TIMESTAMP NOT NULL,

    -- 基础信息
    src INTEGER,
    data_source VARCHAR(20) NOT NULL,

    -- 辐射监测功能
    cpm_value INTEGER,

    -- 环境监测功能
    temperature DECIMAL(5,2),        -- 温度 (°C)
    wetness DECIMAL(5,2),           -- 湿度 (%)
    wind_speed DECIMAL(5,2),        -- 风速 (m/s)
    total_environment_index DECIMAL(6,2), -- 综合环境指数

    -- 电池信息（支持两种格式）
    battery_voltage_v DECIMAL(5,2),  -- 电池电压 (V) - 原始格式
    battery_voltage_mv INTEGER,      -- 电池电压 (mV) - 转换后统一格式

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    -- 索引优化
    INDEX idx_device_time (device_id, record_time),
    INDEX idx_record_time (record_time),
    INDEX idx_cpm_value (cpm_value),
    INDEX idx_temperature (temperature),
    INDEX idx_wetness (wetness)
);
```

### 2. 实体类设计
```java
@Entity
@Table(name = "environment_device_status")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EnvironmentDeviceStatus {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "device_id", nullable = false)
    private Device device;

    @Column(name = "record_time", nullable = false)
    private LocalDateTime recordTime;

    // 基础信息
    @Column(name = "src")
    private Integer src;

    @Column(name = "data_source", nullable = false, length = 20)
    private String dataSource;

    // 辐射监测功能
    @Column(name = "cpm_value")
    private Integer cpmValue;

    // 环境监测功能
    @Column(name = "temperature")
    private Double temperature;           // 温度 (°C)

    @Column(name = "wetness")
    private Double wetness;              // 湿度 (%)

    @Column(name = "wind_speed")
    private Double windSpeed;            // 风速 (m/s)

    @Column(name = "total_environment_index")
    private BigDecimal totalEnvironmentIndex; // 综合环境指数

    // 电池信息（双格式支持）
    @Column(name = "battery_voltage_v")
    private BigDecimal batteryVoltageV;  // 原始电压 (V)

    @Column(name = "battery_voltage_mv")
    private Integer batteryVoltageMv;    // 转换后电压 (mV)

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    // 业务方法
    public Double getBatteryVoltageVolts() {
        return batteryVoltageV != null ? batteryVoltageV.doubleValue() :
               (batteryVoltageMv != null ? batteryVoltageMv / 1000.0 : null);
    }

    public boolean isLowBattery() {
        Double voltage = getBatteryVoltageVolts();
        return voltage != null && voltage < 12.0; // 环境监测站电池阈值更低
    }

    public boolean isHighCpm() {
        return cpmValue != null && cpmValue > 50; // 环境监测站CPM阈值
    }

    public String getEnvironmentStatus() {
        if (totalEnvironmentIndex == null) return "未知";

        if (totalEnvironmentIndex.doubleValue() >= 150) return "优秀";
        if (totalEnvironmentIndex.doubleValue() >= 100) return "良好";
        if (totalEnvironmentIndex.doubleValue() >= 50) return "一般";
        return "较差";
    }
}
```

### 3. 数据处理器设计
```java
@Component
@Slf4j
@RequiredArgsConstructor
public class EnvironmentDataProcessor implements DeviceDataProcessor {

    private final EnvironmentDeviceStatusRepository environmentDeviceStatusRepository;
    private final ObjectMapper objectMapper;

    @Override
    public boolean supports(String deviceType) {
        return "ENVIRONMENT".equals(deviceType);
    }

    @Override
    public void processMessage(String deviceId, String topic, String payload) {
        try {
            JsonNode rootNode = objectMapper.readTree(payload);

            EnvironmentDeviceStatus status = EnvironmentDeviceStatus.builder()
                .deviceId(deviceId)
                .recordTime(LocalDateTime.now())
                .dataSource("MQTT")
                .build();

            // 解析基础信息
            status.setSrc(rootNode.has("src") ? rootNode.get("src").asInt() : null);

            // 解析辐射数据
            status.setCpmValue(extractIntValue(rootNode, "CPM"));

            // 解析环境数据
            status.setTemperature(extractDoubleValue(rootNode, "temperature"));
            status.setWetness(extractDoubleValue(rootNode, "wetness"));
            status.setWindSpeed(extractDoubleValue(rootNode, "windspeed"));
            status.setTotalEnvironmentIndex(extractBigDecimalValue(rootNode, "total"));

            // 解析电池电压（支持V格式）
            if (rootNode.has("battery")) {
                BigDecimal batteryVoltage = rootNode.get("battery").decimalValue();
                status.setBatteryVoltageV(batteryVoltage);
                // 转换为毫伏统一格式
                status.setBatteryVoltageMv(batteryVoltage.multiply(new BigDecimal("1000")).intValue());
            }

            // 保存数据
            environmentDeviceStatusRepository.save(status);

            log.debug("✅ 环境监测站数据处理完成: 设备={}, 温度={}°C, 湿度={}%, CPM={}",
                    deviceId, status.getTemperature(), status.getWetness(), status.getCpmValue());

        } catch (Exception e) {
            log.error("❌ 环境监测站数据处理失败: 设备={}, 数据={}", deviceId, payload, e);
        }
    }

    private Integer extractIntValue(JsonNode node, String fieldName) {
        return node.has(fieldName) ? node.get(fieldName).asInt() : null;
    }

    private Double extractDoubleValue(JsonNode node, String fieldName) {
        return node.has(fieldName) ? node.get(fieldName).asDouble() : null;
    }

    private BigDecimal extractBigDecimalValue(JsonNode node, String fieldName) {
        return node.has(fieldName) ? node.get(fieldName).decimalValue() : null;
    }
}
```

### 4. Repository查询接口
```java
@Repository
public interface EnvironmentDeviceStatusRepository
    extends JpaRepository<EnvironmentDeviceStatus, Long> {

    List<EnvironmentDeviceStatus> findByDeviceIdOrderByRecordTimeDesc(String deviceId);

    List<EnvironmentDeviceStatus> findByDeviceIdAndRecordTimeBetween(
        String deviceId, LocalDateTime startTime, LocalDateTime endTime);

    // 查询异常CPM记录
    @Query("SELECT e FROM EnvironmentDeviceStatus e WHERE e.deviceId = :deviceId " +
           "AND e.cpmValue > 50 AND e.recordTime >= :since")
    List<EnvironmentDeviceStatus> findAbnormalCpmRecords(@Param("deviceId") String deviceId,
                                                       @Param("since") LocalDateTime since);

    // 查询温度异常记录
    @Query("SELECT e FROM EnvironmentDeviceStatus e WHERE e.deviceId = :deviceId " +
           "AND (e.temperature < -10 OR e.temperature > 50) AND e.recordTime >= :since")
    List<EnvironmentDeviceStatus> findAbnormalTemperatureRecords(@Param("deviceId") String deviceId,
                                                               @Param("since") LocalDateTime since);

    // 计算平均环境指数
    @Query("SELECT AVG(e.totalEnvironmentIndex) FROM EnvironmentDeviceStatus e " +
           "WHERE e.deviceId = :deviceId AND e.recordTime BETWEEN :startTime AND :endTime")
    Double getAverageEnvironmentIndex(@Param("deviceId") String deviceId,
                                   @Param("startTime") LocalDateTime startTime,
                                   @Param("endTime") LocalDateTime endTime);

    // 获取最新的环境数据
    Optional<EnvironmentDeviceStatus> findTopByDeviceIdOrderByRecordTimeDesc(String deviceId);
}
```

### 5. 前端展示设计

#### 5.1 环境监测综合仪表盘
```vue
<template>
  <div class="environment-dashboard">
    <!-- 实时指标卡片 -->
    <el-row :gutter="20">
      <el-col :span="6" v-for="metric in metrics" :key="metric.key">
        <el-card>
          <div class="metric-card">
            <div class="metric-icon" :style="{color: metric.color}">
              <i :class="metric.icon"></i>
            </div>
            <div class="metric-content">
              <div class="metric-value">{{ latestData[metric.key] }}{{ metric.unit }}</div>
              <div class="metric-label">{{ metric.label }}</div>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>

    <!-- 综合环境指数 -->
    <el-row :gutter="20" style="margin-top: 20px">
      <el-col :span="12">
        <el-card title="综合环境指数">
          <div class="environment-gauge">
            <!-- 环境指数仪表盘组件 -->
            <gauge-chart :value="latestData.total" :max="200" />
          </div>
        </el-card>
      </el-col>
      <el-col :span="12">
        <el-card title="环境状态">
          <div class="environment-status" :class="environmentStatusClass">
            <i class="status-icon"></i>
            <span>{{ environmentStatus }}</span>
          </div>
        </el-card>
      </el-col>
    </el-row>

    <!-- 历史趋势图 -->
    <el-row style="margin-top: 20px">
      <el-col :span="24">
        <el-card title="24小时环境趋势">
          <environment-chart :device-id="deviceId" />
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>

<script>
export default {
  data() {
    return {
      metrics: [
        { key: 'temperature', label: '温度', icon: 'el-icon-sunrise', unit: '°C', color: '#ff6b6b' },
        { key: 'wetness', label: '湿度', icon: 'el-icon-water', unit: '%', color: '#4ecdc4' },
        { key: 'windSpeed', label: '风速', icon: 'el-icon-wind', unit: 'm/s', color: '#45b7d1' },
        { key: 'cpmValue', label: '辐射值', icon: 'el-icon-warning', unit: 'CPM', color: '#f39c12' }
      ],
      latestData: {},
      environmentStatus: '未知'
    }
  },
  computed: {
    environmentStatusClass() {
      const status = this.environmentStatus;
      return {
        'status-excellent': status === '优秀',
        'status-good': status === '良好',
        'status-normal': status === '一般',
        'status-poor': status === '较差'
      }
    }
  }
}
</script>
```

#### 5.2 设备类型标识建议

为了便于区分，建议采用以下设备ID命名规范：
- 辐射监测仪：`RAD-001`, `RAD-002`...
- 环境监测站：`ENV-001`, `ENV-002`...
- 气象站：`WTH-001`, `WTH-002`...
- 水质监测仪：`WTR-001`, `WTR-002`...

### 6. 业务规则设计

#### 6.1 告警规则
```java
// 环境监测站告警规则
- CPM辐射值 > 50 -> 辐射异常告警
- 温度 < -10°C 或 > 50°C -> 温度异常告警
- 湿度 < 20% 或 > 95% -> 湿度异常告警
- 综合环境指数 < 30 -> 环境质量差告警
- 电池电压 < 12V -> 电池电量低告警
```

#### 6.2 数据统计指标
```java
// 环境监测站特有指标
- 平均环境舒适度指数
- 温湿度变化趋势
- 辐射水平统计
- 电池续航时间估算
```

这种设计既保持了与现有系统的兼容性，又充分发挥了环境监测站的多功能特点，为用户提供全面的环境监测服务。