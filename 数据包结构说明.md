# 山东协议数据包结构详解

## 完整数据包示例

```
##0287QN=2025122913442122611;ST=61;CN=3051;PW=123456;CP=&&MN=01010101010101;Ma=000001;Rno=010101010101;Xtype=01;LastAct=2.700E004;NowAct=1.300E004;SourceTime=20240101;DataTime=20251229134421;LONG=11225.1333;LAT=3705.4300;Xvalue=1000000.000;Thres=100000.000;AlertType=01;BattChar=1000.0;Sig=1&&EB35\r\n
```

## 数据包结构分解

### 可视化视图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            完整数据包 (299字节)                              │
├──────┬──────┬────────────────────────────────────────────────┬──────┬─────────┤
│ 包头 │ 长度 │               数据段 (287字符)                │ CRC  │  包尾   │
├──────┼──────┼────────────────────────────────────────────────┼──────┼─────────┤
│  ##  │ 0287 │ QN=2025122913442122611;ST=61;CN=3051;PW=123... │ EB35 │ \r\n    │
│  2B  │  4B  │                      287B                     │  4B  │   2B    │
└──────┴──────┴────────────────────────────────────────────────┴──────┴─────────┘
```

### 各部分详细说明

#### 1. 包头 (Header) - `##`
- **内容**: `##`
- **长度**: 2字节
- **说明**: 固定标识，表示数据包开始

#### 2. 数据段长度 (Length) - `0287`
- **内容**: `0287`
- **长度**: 4字节
- **说明**: 表示数据段有287个ASCII字符
- **计算**: `len(data_segment) = 287`

#### 3. 数据段 (Data Segment) - `QN=...&&`
- **长度**: 287字节
- **内容**: 实际传输的数据
- **结构**:
  ```
  QN=2025122913442122611;          ← 请求编号 (20位)
  ST=61;                          ← 系统编号
  CN=3051;                        ← 命令编号
  PW=123456;                      ← 访问密码
  CP=&&                           ← 数据内容开始
    MN=01010101010101;            ← 设备编号
    Ma=000001;                    ← 探伤机编号
    Rno=010101010101;             ← 放射源编号
    Xtype=01;                     ← 放射源类型
    LastAct=2.700E004;            ← 原始活度
    NowAct=1.300E004;             ← 当前活度
    SourceTime=20240101;          ← 出厂日期
    DataTime=20251229134421;      ← 数据时间
    LONG=11225.1333;              ← GPS经度
    LAT=3705.4300;                ← GPS纬度
    Xvalue=1000000.000;           ← 剂量率
    Thres=100000.000;             ← 阈值
    AlertType=01;                 ← 报警类型
    BattChar=1000.0;              ← 电源电量
    Sig=1                         ← GPS标志
  &&                              ← 数据内容结束
  ```

#### 4. CRC16校验码 - `EB35`
- **内容**: `EB35`
- **长度**: 4字节（十六进制）
- **说明**: 数据段的CRC16校验码，用于验证数据完整性
- **计算方法**:
  ```
  对数据段进行CRC16-CCITT算法计算
  多项式: 0xA001
  初始值: 0xFFFF
  ```

**⚠️ 重要**: CRC只校验数据段部分，不包括包头、长度、CRC本身和包尾

#### 5. 包尾 (Tail) - `\r\n`
- **内容**: 回车换行符
- **长度**: 2字节
- **说明**: 表示数据包结束

## 长度验证

```
数据段: QN=2025122913442122611;ST=61;CN=3051;PW=123456;CP=&&MN=01010101010101;Ma=000001;Rno=010101010101;Xtype=01;LastAct=2.700E004;NowAct=1.300E004;SourceTime=20240101;DataTime=20251229134421;LONG=11225.1333;LAT=3705.4300;Xvalue=1000000.000;Thres=100000.000;AlertType=01;BattChar=1000.0;Sig=1&&

实际长度: 287 字符 ✓
声明长度: 0287 ✓
```

## 常见问题

### Q1: 为什么需要数据段长度字段？
**A**: 让服务器能够快速定位数据段的结束位置，提高解析效率。

### Q2: CRC校验失败会怎样？
**A**: 服务器会拒绝该数据包，不会处理其中的数据。

### Q3: 数据段长度包括哪些内容？
**A**: 从QN字段开始，到CP的结束符&&为止，不包括包头##、长度字段本身、CRC和包尾。

### Q4: 长度字段为什么要用4位？
**A**: 4位可以表示0-9999的长度，足够容纳协议允许的最大数据段（1024字节）。

## 参考代码

```python
# 计算数据段长度
data_segment = "QN=...;ST=61;CN=3051;...&&"
length = f"{len(data_segment):04d}"  # 输出: '0287'

# 计算CRC16
def calculate_crc16(data):
    crc = 0xFFFF
    for byte in data.encode('ascii'):
        crc ^= (byte & 0xFF)
        for _ in range(8):
            if (crc & 0x0001) != 0:
                crc >>= 1
                crc ^= 0xA001
            else:
                crc >>= 1
    return f"{crc:04X}"  # 输出: 'EB35'

# 构建完整数据包
packet = f"##{length}{data_segment}{calculate_crc16(data_segment)}\r\n"
```

---

**文档版本**: v1.0
**更新日期**: 2024-12-29
