# EMS测试环境Docker配置 - MQTT broker 和设备模拟器

services:
  # Mosquitto MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: ems-mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"      # MQTT协议端口
      - "9001:9001"      # WebSocket协议端口
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
      - ./mosquitto-config/config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    networks:
      - ems-network
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_pub -h localhost -t test -m 'health-check' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # Node-RED - 设备模拟器
  nodered:
    image: nodered/node-red:latest
    container_name: ems-nodered
    restart: unless-stopped
    ports:
      - "1880:1880"
    environment:
      - NODE_RED_ENABLE_PROJECTS=false
      - NODE_RED_NAME=EMS-Device-Simulator
      - NODE_RED_LOG_LEVEL=info
      - NODE_OPTIONS=--max-old-space-size=512
    volumes:
      - nodered_data:/data
      # 使用本地Node-RED流配置
      - ./nodered/flows/ems-device-test-corrected.json:/data/flows.json:ro
    networks:
      - ems-network
    depends_on:
      mosquitto:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1880/"]
      interval: 30s
      timeout: 15s
      retries: 5
      start_period: 45s

  # MySQL 8.0 数据库
  mysql:
    image: mysql:8.0
    container_name: ems-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ems_root_pass
      MYSQL_DATABASE: ems_db
      MYSQL_USER: ems_user
      MYSQL_PASSWORD: ems_pass
      # MySQL 配置优化
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - ems-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-pems_root_pass"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password

  # Redis 缓存服务
  redis:
    image: redis:latest
    container_name: ems-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --requirepass ems_redis_pass
    volumes:
      - redis_data:/data
    networks:
      - ems-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

# 数据卷定义
volumes:
  nodered_data:
    driver: local
  mosquitto_data:
    driver: local
  mosquitto_log:
    driver: local
  mysql_data:
    driver: local
  redis_data:
    driver: local

# 网络定义
networks:
  ems-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.22.0.0/16