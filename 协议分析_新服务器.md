# 新服务器响应分析报告

## 测试配置
- 服务器：221.214.62.118:20050
- 设备编号：53386530019073
- 放射源编号：000025006722（纯数字）

## 服务器响应分析

### 1. 连接阶段响应
```
十六进制: 43 4D
ASCII: CM
```

### 2. 数据上报后响应
```
十六进制: 43 4D 03 02 02 00 00 00 00 43 4D 01 02 02 00 00 00 00 43 4D 8D 02 02 00 00 00 00 43 4D 87 02 02 00 00 00 00
长度: 36字节
```

**响应结构分解：**
```
┌────┬──────────────────┬──────────────────┬──────────────────┬──────────────────┐
│标识│   数据块1        │   数据块2        │   数据块3        │   数据块4        │
│CM  │ CM 03 02 02 ...  │ CM 01 02 02 ...  │ CM 8D 02 02 ...  │ CM 87 02 02 ...  │
│2B  │      8B         │      8B         │      8B         │      8B         │
└────┴──────────────────┴──────────────────┴──────────────────┴──────────────────┘
```

**每个数据块的结构：**
```
┌────┬────┬────┬──────────────┬──────────────┐
│CM  │03  │02  │02            │00000000      │
│标识│?   │?   │?             │填充/数据      │
│2B  │1B  │1B  │1B            │4B            │
└────┴────┴────┴──────────────┴──────────────┘
```

## 协议对比分析

### 我们发送的数据包
```
##0287QN=2025122915481844681;ST=61;CN=3051;PW=123456;CP=&&MN=53386530019073;Ma=002162;Rno=000025006722;...&&CRC\r\n
```

### 标准HJ/T212-2005协议格式（上报2.txt）
```
##长度数据段CRC\r\n
```

### 文档提到的"基础包结构组件"
```
SIM卡号、包头、数据段长度、数据段、CRC校验、包尾
```

## 关键问题

### 问题1：SIM卡号是否需要？

**文档明确提到**（上报2.txt 第18行）：
> 基础包结构组件：**SIM卡号**、包头、数据段长度、数据段、CRC校验、包尾

**但在详细的数据段结构表（第23-29行）中没有列出SIM卡号**

**可能的理解：**
1. SIM卡号是可选字段，仅在特定场景使用（如短信传输）
2. SIM卡号位于包头之前
3. SIM卡号可能是服务器识别设备的关键

**格式可能是：**
```
SIM卡号(变长)##长度数据段CRC\r\n
```

### 问题2：服务器期望的握手流程？

服务器在TCP连接后立即发送"CM"，这可能意味着：
1. **Connect Message** - 要求客户端回应
2. **Command Mode** - 要求进入命令模式
3. **Connection Manager** - 连接管理器消息

**可能的握手流程：**
```
Client                      Server
   |                           |
   |-------- TCP CONNECT ----->|
   |<------- CM (初始消息) ----|
   |------ CM (应答) --------->|  ← 缺少这一步！
   |                           |
   |---- 数据包 (##...) ------>|
   |<------- 响应 -------------|
```

### 问题3：数据包格式差异

**Python脚本格式（有长度）：**
```
##0287QN=...;ST=61;CN=3051;...&&CRC\r\n
```

**Java实现格式（无长度）：**
```java
"##" + packet + crc + "\r\n"
// 输出: ##QN=...;ST=61;CN=3051;...&&CRC\r\n
```

**哪个是正确的？**

根据协议文档表格（上报2.txt 第26行）：
- 数据段长度是**必需字段**，4位十进制整数

因此Python脚本格式是正确的！

## 建议的测试方案

### 方案1：添加SIM卡号（如果有的话）
```
SIM号码##长度数据段CRC\r\n
```

### 方案2：响应服务器的CM消息
```
Client                      Server
   |                           |
   |-------- TCP CONNECT ----->|
   |<------- CM ----------------|
   |------ CM (应答) --------->|  ← 添加这一步
   |---- 数据包 (##...) ------>|
```

### 方案3：使用Java实现格式（无长度字段）
```
##QN=...;ST=61;CN=3051;...&&CRC\r\n
```

### 方案4：查看Java后端实际发送的数据
建议启动Java后端，抓包查看实际发送的数据格式

## 待确认事项

1. ✅ SIM卡号是否需要？（文档提到但未详细说明）
2. ✅ "CM"消息的含义和正确的响应方式？
3. ✅ 服务器是否真的期望数据段长度字段？
4. ✅ 是否有其他成功的数据包可以参考？

---
**分析时间**: 2024-12-29
**服务器**: 221.214.62.118:20050
