# æ•°æ®ä¸ŠæŠ¥æ¨¡å—å®æ–½è®¡åˆ’

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

åŸºäºV2è®¾è®¡æ–¹æ¡ˆï¼Œå®ç°GPSè¾å°„æ•°æ®è‡ªåŠ¨ä¸ŠæŠ¥åˆ°ç›‘ç®¡æœºæ„çš„åŠŸèƒ½ã€‚

**æ ¸å¿ƒç›®æ ‡**:
1. å®šæ—¶é‡‡é›†è¾å°„è®¾å¤‡æ•°æ®
2. ä½¿ç”¨SM2å›½å¯†åŠ å¯†
3. ä¸ŠæŠ¥åˆ°å›ºå®šç›‘ç®¡æ¥å£
4. æä¾›ç®¡ç†å‘˜é…ç½®ç•Œé¢
5. æ”¯æŒä¼ä¸šçº§éš”ç¦»

## ğŸ¯ å®æ–½é˜¶æ®µ

### é˜¶æ®µä¸€ï¼šåŸºç¡€è®¾æ–½æ­å»ºï¼ˆç¬¬1-2å¤©ï¼‰

#### 1.1 ä¾èµ–é›†æˆ
- [ ] æ·»åŠ SM2åŠ å¯†åº“ä¾èµ–ï¼ˆBouncyCastle SM2ï¼‰
- [ ] æ·»åŠ HTTPå®¢æˆ·ç«¯ä¾èµ–ï¼ˆApache HttpClientæˆ–OkHttpï¼‰
- [ ] æ·»åŠ å®šæ—¶ä»»åŠ¡è°ƒåº¦ä¾èµ–ï¼ˆSpring @Scheduledï¼‰

#### 1.2 æ•°æ®åº“è¡¨åˆ›å»º
- [ ] åˆ›å»º`ems_data_report_config`è¡¨ï¼ˆä¸ŠæŠ¥é…ç½®è¡¨ï¼‰
- [ ] åˆ›å»º`ems_data_report_log`è¡¨ï¼ˆä¸ŠæŠ¥æ—¥å¿—è¡¨ï¼‰
- [ ] ä¸ºCompanyè¡¨æ·»åŠ ä¸ŠæŠ¥é…ç½®å­—æ®µï¼ˆç®€åŒ–è®¾è®¡ï¼Œä»…æ·»åŠ 7ä¸ªå­—æ®µï¼‰

**ç®€åŒ–æ–¹æ¡ˆï¼ˆæ¨èï¼‰**:
```sql
ALTER TABLE ems_company ADD COLUMN data_report_enabled BOOLEAN DEFAULT FALSE;
ALTER TABLE ems_company ADD COLUMN report_granularity VARCHAR(20) DEFAULT 'HOUR';
ALTER TABLE ems_company ADD COLUMN gps_priority VARCHAR(20) DEFAULT 'BDS';
ALTER TABLE ems_company ADD COLUMN report_interval INT DEFAULT 1;
ALTER TABLE ems_company ADD COLUMN last_report_time DATETIME;
ALTER TABLE ems_company ADD COLUMN last_report_status VARCHAR(20);
ALTER TABLE ems_company ADD COLUMN total_report_count INT DEFAULT 0;
```

### é˜¶æ®µäºŒï¼šæ ¸å¿ƒåŠŸèƒ½å®ç°ï¼ˆç¬¬3-5å¤©ï¼‰

#### 2.1 SM2åŠ å¯†æœåŠ¡
**æ–‡ä»¶**: `backend/src/main/java/com/cdutetc/ems/service/Sm2EncryptionService.java`

åŠŸèƒ½:
- [ ] è·å–SM2å…¬é’¥ï¼ˆä»ç›‘ç®¡æœåŠ¡å™¨ï¼‰
- [ ] SM2æ•°æ®åŠ å¯†
- [ ] ç­¾åç”Ÿæˆ

#### 2.2 æ•°æ®é‡‡é›†æœåŠ¡
**æ–‡ä»¶**: `backend/src/main/java/com/cdutetc/ems/service/DataCollectionService.java`

åŠŸèƒ½:
- [ ] æ ¹æ®ç²’åº¦ï¼ˆMIN/HOUR/DAYï¼‰é‡‡é›†è¾å°„è®¾å¤‡æ•°æ®
- [ ] æ•°æ®æ ¼å¼è½¬æ¢ï¼ˆEMSæ•°æ® â†’ ç›‘ç®¡æ¥å£æ ¼å¼ï¼‰
- [ ] GPSä¼˜å…ˆçº§å¤„ç†ï¼ˆBDS/LBS/BDS_THEN_LBSï¼‰
- [ ] æ•°æ®èšåˆå’Œç»Ÿè®¡

#### 2.3 æ•°æ®ä¸ŠæŠ¥æœåŠ¡
**æ–‡ä»¶**: `backend/src/main/java/com/cdutetc/ems/service/DataReportService.java`

åŠŸèƒ½:
- [ ] æ„å»ºä¸ŠæŠ¥JSON
- [ ] è°ƒç”¨SM2åŠ å¯†
- [ ] HTTP POSTåˆ°ç›‘ç®¡æ¥å£
- [ ] å¤„ç†å“åº”ç»“æœ
- [ ] è®°å½•ä¸ŠæŠ¥æ—¥å¿—
- [ ] é”™è¯¯é‡è¯•æœºåˆ¶

#### 2.4 å®šæ—¶ä»»åŠ¡è°ƒåº¦
**æ–‡ä»¶**: `backend/src/main/java/com/cdutetc/ems/scheduler/DataReportScheduler.java`

åŠŸèƒ½:
- [ ] æ ¹æ®é…ç½®ç²’åº¦å®šæ—¶è§¦å‘ä¸ŠæŠ¥
- [ ] MIN: æ¯åˆ†é’Ÿæ‰§è¡Œ
- [ ] HOUR: æ¯å°æ—¶æ‰§è¡Œ
- [ ] DAY: æ¯å¤©æ‰§è¡Œ
- [ ] æ”¯æŒåŠ¨æ€è°ƒæ•´cronè¡¨è¾¾å¼

### é˜¶æ®µä¸‰ï¼šç®¡ç†æ¥å£å¼€å‘ï¼ˆç¬¬6-7å¤©ï¼‰

#### 3.1 åç«¯API
**æ–‡ä»¶**: `backend/src/main/java/com/cdutetc/ems/controller/DataReportController.java`

æ¥å£:
- [ ] `GET /api/data-report/config/{companyId}` - è·å–ä¸ŠæŠ¥é…ç½®
- [ ] `PUT /api/data-report/config/{companyId}` - æ›´æ–°ä¸ŠæŠ¥é…ç½®
- [ ] `POST /api/data-report/config/{companyId}/test` - æµ‹è¯•ä¸ŠæŠ¥
- [ ] `GET /api/data-report/logs/{companyId}` - è·å–ä¸ŠæŠ¥æ—¥å¿—
- [ ] `POST /api/data-report/config/{companyId}/enable` - å¯ç”¨ä¸ŠæŠ¥
- [ ] `POST /api/data-report/config/{companyId}/disable` - ç¦ç”¨ä¸ŠæŠ¥

#### 3.2 å‰ç«¯é¡µé¢
**æ–‡ä»¶**: `frontend/src/views/data-report/DataReportConfig.vue`

åŠŸèƒ½:
- [ ] é…ç½®è¡¨å•ï¼ˆç²’åº¦ã€GPSä¼˜å…ˆçº§ã€ä¸ŠæŠ¥é—´éš”ï¼‰
- [ ] å¯ç”¨/ç¦ç”¨å¼€å…³
- [ ] æ‰‹åŠ¨è§¦å‘æµ‹è¯•ä¸ŠæŠ¥
- [ ] æŸ¥çœ‹ä¸ŠæŠ¥æ—¥å¿—ï¼ˆåˆ†é¡µã€ç­›é€‰ï¼‰
- [ ] å®æ—¶çŠ¶æ€æ˜¾ç¤º

### é˜¶æ®µå››ï¼šæµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆç¬¬8å¤©ï¼‰

#### 4.1 å•å…ƒæµ‹è¯•
- [ ] SM2åŠ å¯†æµ‹è¯•
- [ ] æ•°æ®é‡‡é›†æµ‹è¯•
- [ ] æ•°æ®ä¸ŠæŠ¥æµ‹è¯•
- [ ] é”™è¯¯å¤„ç†æµ‹è¯•

#### 4.2 é›†æˆæµ‹è¯•
- [ ] å®Œæ•´ä¸ŠæŠ¥æµç¨‹æµ‹è¯•
- [ ] å®šæ—¶ä»»åŠ¡æµ‹è¯•
- [ ] å¤šä¼ä¸šéš”ç¦»æµ‹è¯•
- [ ] å¹¶å‘ä¸ŠæŠ¥æµ‹è¯•

#### 4.3 æ€§èƒ½ä¼˜åŒ–
- [ ] æ‰¹é‡ä¸ŠæŠ¥ä¼˜åŒ–
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] HTTPè¿æ¥æ± é…ç½®
- [ ] å¼‚æ­¥ä¸ŠæŠ¥å¤„ç†

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

#### åç«¯
```
backend/src/main/java/com/cdutetc/ems/
â”œâ”€â”€ config/
â”‚   â””â”€â”€ DataReportProperties.java           # ä¸ŠæŠ¥é…ç½®å±æ€§
â”œâ”€â”€ service/
â”‚   â”œâ”€â”€ Sm2EncryptionService.java           # SM2åŠ å¯†æœåŠ¡
â”‚   â”œâ”€â”€ DataCollectionService.java          # æ•°æ®é‡‡é›†æœåŠ¡
â”‚   â”œâ”€â”€ DataReportService.java              # æ•°æ®ä¸ŠæŠ¥æœåŠ¡
â”‚   â””â”€â”€ DataReportLogService.java           # ä¸ŠæŠ¥æ—¥å¿—æœåŠ¡
â”œâ”€â”€ scheduler/
â”‚   â””â”€â”€ DataReportScheduler.java            # å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨
â”œâ”€â”€ controller/
â”‚   â””â”€â”€ DataReportController.java           # ä¸ŠæŠ¥ç®¡ç†API
â”œâ”€â”€ dto/
â”‚   â”œâ”€â”€ request/
â”‚   â”‚   â””â”€â”€ DataReportConfigRequest.java    # é…ç½®æ›´æ–°è¯·æ±‚
â”‚   â””â”€â”€ response/
â”‚       â”œâ”€â”€ DataReportConfigResponse.java   # é…ç½®å“åº”
â”‚       â””â”€â”€ DataReportLogResponse.java      # æ—¥å¿—å“åº”
â””â”€â”€ entity/
    â”œâ”€â”€ DataReportConfig.java               # ä¸ŠæŠ¥é…ç½®å®ä½“ï¼ˆå¯é€‰ï¼‰
    â””â”€â”€ DataReportLog.java                  # ä¸ŠæŠ¥æ—¥å¿—å®ä½“
```

#### å‰ç«¯
```
frontend/src/
â”œâ”€â”€ views/data-report/
â”‚   â”œâ”€â”€ DataReportConfig.vue                # é…ç½®ç®¡ç†é¡µé¢
â”‚   â””â”€â”€ DataReportLogs.vue                  # æ—¥å¿—æŸ¥çœ‹é¡µé¢
â”œâ”€â”€ api/
â”‚   â””â”€â”€ dataReport.js                       # ä¸ŠæŠ¥APIå°è£…
â””â”€â”€ router/
    â””â”€â”€ routes.js                           # æ·»åŠ è·¯ç”±
```

### ä¿®æ”¹æ–‡ä»¶

#### åç«¯
```
backend/src/main/java/com/cdutetc/ems/
â”œâ”€â”€ entity/
â”‚   â””â”€â”€ Company.java                        # æ·»åŠ ä¸ŠæŠ¥é…ç½®å­—æ®µ
â”œâ”€â”€ service/
â”‚   â””â”€â”€ CompanyService.java                 # æ·»åŠ ä¸ŠæŠ¥é…ç½®å¤„ç†
â””â”€â”€ resources/
    â””â”€â”€ application.yaml                    # æ·»åŠ ä¸ŠæŠ¥é…ç½®
```

#### å‰ç«¯
```
frontend/src/
â”œâ”€â”€ router/
â”‚   â””â”€â”€ routes.js                           # æ·»åŠ æ•°æ®ä¸ŠæŠ¥è·¯ç”±
â””â”€â”€ components/Layout/
    â””â”€â”€ AppSidebar.vue                      # æ·»åŠ æ•°æ®ä¸ŠæŠ¥èœå•
```

## ğŸ”§ æŠ€æœ¯è¦ç‚¹

### SM2åŠ å¯†é›†æˆ
```java
// ä½¿ç”¨BouncyCastleåº“
dependencies {
    implementation 'org.bouncycastle:bcprov-jdk15to18:1.76'
    implementation 'org.bouncycastle:bcpkix-jdk15to18:1.76'
}
```

### æ•°æ®æ ¼å¼æ˜ å°„
```java
// EMSæ•°æ® â†’ ç›‘ç®¡æ¥å£æ ¼å¼
Map<String, Object> dataStr = new HashMap<>();
dataStr.put("CODE", device.getDeviceCode());
dataStr.put("Nuclide", device.getDescription());
dataStr.put("GPS", (bdsUseful || lbsUseful) ? 1 : 0);
dataStr.put("Vbat", String.format("%.1fV", batvolt));
dataStr.put("LNG", longitude);  // æ ¹æ®GPSä¼˜å…ˆçº§é€‰æ‹©
dataStr.put("LAT", latitude);
dataStr.put("FSY", cpm);
```

### å®šæ—¶ä»»åŠ¡é…ç½®
```java
@Scheduled(cron = "0 0 * * * ?")  // æ¯å°æ—¶æ‰§è¡Œ
public void hourlyReport() {
    // æŸ¥è¯¢å¯ç”¨HOURç²’åº¦çš„ä¼ä¸š
    // æ‰§è¡Œæ•°æ®ä¸ŠæŠ¥
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å®‰å…¨æ€§**
   - API Keyä¸è¦ç¡¬ç¼–ç ï¼Œä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡
   - SM2ç§é’¥å¦¥å–„ä¿ç®¡
   - æ—¥å¿—ä¸­ä¸è¦æ•æ„Ÿä¿¡æ¯

2. **å¯é æ€§**
   - å®ç°é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š3æ¬¡ï¼‰
   - è®°å½•è¯¦ç»†çš„ä¸ŠæŠ¥æ—¥å¿—
   - é”™è¯¯å‘Šè­¦é€šçŸ¥

3. **æ€§èƒ½**
   - æ‰¹é‡ä¸ŠæŠ¥ï¼Œé¿å…é¢‘ç¹HTTPè°ƒç”¨
   - å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹
   - æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

4. **å¯ç»´æŠ¤æ€§**
   - é…ç½®åŒ–ç®¡ç†
   - è¯¦ç»†çš„æ—¥å¿—è®°å½•
   - ç›‘æ§æŒ‡æ ‡æ”¶é›†

## ğŸ“… æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|------|------|---------|
| é˜¶æ®µä¸€ | åŸºç¡€è®¾æ–½æ­å»º | 1-2å¤© |
| é˜¶æ®µäºŒ | æ ¸å¿ƒåŠŸèƒ½å®ç° | 3-5å¤© |
| é˜¶æ®µä¸‰ | ç®¡ç†æ¥å£å¼€å‘ | 1-2å¤© |
| é˜¶æ®µå›› | æµ‹è¯•ä¸ä¼˜åŒ– | 1å¤© |
| **æ€»è®¡** | | **6-10å¤©** |

## ğŸš€ å®æ–½é¡ºåºå»ºè®®

### ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆMVPï¼‰
1. æ•°æ®åº“è¡¨åˆ›å»º
2. SM2åŠ å¯†æœåŠ¡
3. æ•°æ®é‡‡é›†æœåŠ¡
4. æ•°æ®ä¸ŠæŠ¥æœåŠ¡
5. åŸºæœ¬å®šæ—¶ä»»åŠ¡

### ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆç®¡ç†åŠŸèƒ½ï¼‰
6. åç«¯API
7. å‰ç«¯é…ç½®é¡µé¢
8. æ—¥å¿—æŸ¥çœ‹åŠŸèƒ½

### ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–å¢å¼ºï¼‰
9. æµ‹è¯•è¦†ç›–
10. æ€§èƒ½ä¼˜åŒ–
11. ç›‘æ§å‘Šè­¦
12. æ–‡æ¡£å®Œå–„

## âœ… éªŒæ”¶æ ‡å‡†

1. âœ… èƒ½å¤ŸæˆåŠŸé‡‡é›†è¾å°„è®¾å¤‡æ•°æ®
2. âœ… èƒ½å¤Ÿä½¿ç”¨SM2åŠ å¯†æ•°æ®
3. âœ… èƒ½å¤ŸæˆåŠŸä¸ŠæŠ¥åˆ°ç›‘ç®¡æ¥å£
4. âœ… ç®¡ç†å‘˜å¯ä»¥é…ç½®ä¸ŠæŠ¥å‚æ•°
5. âœ… å¯ä»¥æŸ¥çœ‹ä¸ŠæŠ¥å†å²æ—¥å¿—
6. âœ… å®šæ—¶ä»»åŠ¡æ­£å¸¸è¿è¡Œ
7. âœ… é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶æœ‰æ•ˆ
8. âœ… å¤šä¼ä¸šæ•°æ®éš”ç¦»æ­£ç¡®
