# 前端数据上报配置设计方案

## 📋 核心原则

### 配置权限划分
1. **管理员（ADMIN）**：可以配置所有上报参数
2. **普通用户（USER）**：只能查看上报状态，不能修改配置

### 设备类型差异
1. **辐射设备（RADIATION_MONITOR）**：完整的上报配置
2. **环境设备（ENVIRONMENT_STATION）**：仅基础配置

---

## 🎯 配置项分类

### 1. 基础上报配置（所有设备）

| 配置项 | 字段名 | 类型 | 说明 | 修改权限 |
|--------|--------|------|------|----------|
| 启用数据上报 | `dataReportEnabled` | Boolean | 开关 | 管理员 |
| 上报协议 | `reportProtocol` | Enum | SICHUAN/SHANDONG | 管理员 |

### 2. 辐射设备专用配置

| 配置项 | 字段名 | 类型 | 说明 | 协议 | 修改权限 |
|--------|--------|------|------|------|----------|
| 核素类型 | `nuclide` | String | 如 Cs-137 | 四川+山东 | 管理员 |
| 探伤机编号 | `inspectionMachineNumber` | String | 6位数字 | 山东 | 管理员 |
| 放射源编号 | `sourceNumber` | String | 12位数字 | 山东 | 管理员 |
| 放射源类别 | `sourceType` | String | 01-05 | 山东 | 管理员 |
| 原始活度 | `originalActivity` | String | 科学计数法 | 山东 | 管理员 |
| 当前活度 | `currentActivity` | String | 科学计数法 | 山东 | 管理员 |
| 出厂日期 | `sourceProductionDate` | Date | YYYY-MM-DD | 山东 | 管理员 |

### 3. 只读统计字段（所有角色可查看）

| 字段名 | 说明 | 数据来源 |
|--------|------|----------|
| `lastReportTime` | 最后上报时间 | 系统自动记录 |
| `lastReportStatus` | 最后上报状态 | 系统自动记录 |
| `lastReportError` | 最后上报错误 | 系统自动记录 |
| `totalReportCount` | 总上报次数 | 系统自动计数 |
| `successReportCount` | 成功次数 | 系统自动计数 |

---

## 🎨 前端页面设计

### 页面1：管理员 - 设备管理（含上报配置）

**路径**：`/admin/devices`
**组件**：`DeviceManagement.vue`

#### 设备列表表格

```vue
<el-table :data="devices">
  <el-table-column prop="deviceCode" label="设备编码" width="120" />
  <el-table-column prop="deviceName" label="设备名称" width="150" />
  <el-table-column prop="deviceType" label="设备类型" width="120">
    <template #default="{ row }">
      <el-tag :type="row.deviceType === 'RADIATION_MONITOR' ? 'danger' : 'success'">
        {{ row.deviceType === 'RADIATION_MONITOR' ? '辐射设备' : '环境设备' }}
      </el-tag>
    </template>
  </el-table-column>

  <!-- 上报状态列 -->
  <el-table-column label="上报状态" width="100">
    <template #default="{ row }">
      <el-switch
        v-model="row.dataReportEnabled"
        @change="handleToggleReport(row)"
        :loading="row.updating"
      />
    </template>
  </el-table-column>

  <el-table-column prop="reportProtocol" label="协议" width="100">
    <template #default="{ row }">
      <el-tag>{{ row.reportProtocol === 'SICHUAN' ? '四川' : '山东' }}</el-tag>
    </template>
  </el-table-column>

  <el-table-column prop="lastReportTime" label="最后上报" width="160">
    <template #default="{ row }">
      {{ row.lastReportTime || '未上报' }}
    </template>
  </el-table-column>

  <el-table-column label="成功率" width="100">
    <template #default="{ row }">
      {{ calculateSuccessRate(row) }}%
    </template>
  </el-table-column>

  <el-table-column label="操作" width="200" fixed="right">
    <template #default="{ row }">
      <el-button size="small" @click="handleConfigReport(row)">
        配置上报
      </el-button>
      <el-button size="small" @click="handleViewLog(row)">
        查看日志
      </el-button>
    </template>
  </el-table-column>
</el-table>
```

---

### 页面2：管理员 - 设备上报配置对话框

**触发**：点击"配置上报"按钮
**组件**：`DeviceReportConfigDialog.vue`

#### 对话框结构

```vue
<el-dialog
  v-model="visible"
  :title="`配置设备上报 - ${device.deviceName}`"
  width="700px"
>
  <el-form :model="form" :rules="rules" ref="formRef" label-width="140px">

    <!-- ====== 基础配置部分 ====== -->
    <el-divider content-position="left">基础上报配置</el-divider>

    <el-form-item label="启用数据上报" prop="dataReportEnabled">
      <el-switch v-model="form.dataReportEnabled" />
      <span class="ml-2 text-gray-500">
        开启后将按选定协议自动上报数据
      </span>
    </el-form-item>

    <el-form-item label="上报协议" prop="reportProtocol">
      <el-radio-group v-model="form.reportProtocol" :disabled="!form.dataReportEnabled">
        <el-radio value="SICHUAN">
          <strong>四川协议</strong>
          <span class="ml-2 text-gray-500">
            （HTTP + SM2加密，需配置核素类型）
          </span>
        </el-radio>
        <el-radio value="SHANDONG">
          <strong>山东协议</strong>
          <span class="ml-2 text-gray-500">
            （TCP + HJ/T212-2005，需配置完整放射源信息）
          </span>
        </el-radio>
      </el-radio-group>
    </el-form-item>

    <!-- GPS信息说明 -->
    <el-alert
      type="info"
      :closable="false"
      show-icon
      class="mb-4"
    >
      <template #title>
        <span>📍 GPS自动选择</span>
      </template>
      <p>系统将根据设备上报的 <code>useful</code> 字段自动选择最优GPS：</p>
      <ul class="ml-4">
        <li>北斗GPS可用（useful=1）→ 使用北斗GPS</li>
        <li>北斗GPS不可用 → 使用基站GPS</li>
      </ul>
      <p class="mt-2 text-sm text-gray-500">
        无需手动配置GPS优先级，系统会自动处理。
      </p>
    </el-alert>

    <!-- ====== 辐射设备专用配置 ====== -->
    <div v-if="device.deviceType === 'RADIATION_MONITOR'">
      <el-divider content-position="left">
        辐射设备专用配置
        <span class="ml-2 text-sm text-gray-500">
          （根据所选协议动态显示）
        </span>
      </el-divider>

      <!-- 四川协议专用字段 -->
      <div v-if="form.reportProtocol === 'SICHUAN'">
        <el-form-item label="核素类型" prop="nuclide">
          <el-input
            v-model="form.nuclide"
            placeholder="请输入核素类型，如 Cs-137"
            :disabled="!form.dataReportEnabled"
          >
            <template #prepend>🧪</template>
          </el-input>
          <span class="ml-2 text-sm text-gray-500">
            示例：Cs-137、Co-60
          </span>
        </el-form-item>
      </div>

      <!-- 山东协议专用字段 -->
      <div v-if="form.reportProtocol === 'SHANDONG'">
        <el-form-item label="探伤机编号" prop="inspectionMachineNumber">
          <el-input
            v-model="form.inspectionMachineNumber"
            placeholder="6位数字"
            maxlength="6"
            :disabled="!form.dataReportEnabled"
          >
            <template #prepend>🔧</template>
          </el-input>
          <span class="ml-2 text-sm text-gray-500">
            对应协议 Ma 字段
          </span>
        </el-form-item>

        <el-form-item label="放射源编号" prop="sourceNumber">
          <el-input
            v-model="form.sourceNumber"
            placeholder="12位数字"
            maxlength="12"
            :disabled="!form.dataReportEnabled"
          >
            <template #prepend>☢️</template>
          </el-input>
          <span class="ml-2 text-sm text-gray-500">
            对应协议 Rno 字段
          </span>
        </el-form-item>

        <el-form-item label="放射源类别" prop="sourceType">
          <el-select
            v-model="form.sourceType"
            placeholder="请选择放射源类别"
            :disabled="!form.dataReportEnabled"
            style="width: 100%"
          >
            <el-option label="Ⅰ类" value="01" />
            <el-option label="Ⅱ类" value="02" />
            <el-option label="Ⅲ类" value="03" />
            <el-option label="Ⅳ类" value="04" />
            <el-option label="Ⅴ类" value="05" />
          </el-select>
          <span class="ml-2 text-sm text-gray-500">
            对应协议 Xtype 字段
          </span>
        </el-form-item>

        <el-form-item label="原始活度" prop="originalActivity">
          <el-input
            v-model="form.originalActivity"
            placeholder="如 2.700E004"
            :disabled="!form.dataReportEnabled"
          >
            <template #prepend>📊</template>
          </el-input>
          <span class="ml-2 text-sm text-gray-500">
            科学计数法，对应协议 LastAct 字段
          </span>
        </el-form-item>

        <el-form-item label="当前活度" prop="currentActivity">
          <el-input
            v-model="form.currentActivity"
            placeholder="如 1.300E004"
            :disabled="!form.dataReportEnabled"
          >
            <template #prepend>📈</template>
          </el-input>
          <span class="ml-2 text-sm text-gray-500">
            科学计数法，对应协议 NowAct 字段
          </span>
        </el-form-item>

        <el-form-item label="出厂日期" prop="sourceProductionDate">
          <el-date-picker
            v-model="form.sourceProductionDate"
            type="date"
            placeholder="选择出厂日期"
            :disabled="!form.dataReportEnabled"
            format="YYYY-MM-DD"
            value-format="YYYY-MM-DD"
            style="width: 100%"
          />
          <span class="ml-2 text-sm text-gray-500">
            对应协议 SourceTime 字段
          </span>
        </el-form-item>
      </div>
    </div>

    <!-- 环境设备提示 -->
    <div v-else>
      <el-alert
        type="success"
        :closable="false"
        show-icon
      >
        <p>环境设备仅需配置基础上报参数即可</p>
      </el-alert>
    </div>

  </el-form>

  <template #footer>
    <el-button @click="visible = false">取消</el-button>
    <el-button type="primary" @click="handleSubmit" :loading="submitting">
      保存配置
    </el-button>
  </template>
</el-dialog>
```

#### 表单验证规则

```javascript
const rules = {
  dataReportEnabled: [
    { type: 'boolean', required: true, message: '请选择是否启用上报' }
  ],
  reportProtocol: [
    { required: true, message: '请选择上报协议', trigger: 'change' }
  ],

  // 四川协议验证
  nuclide: [
    {
      validator: (rule, value, callback) => {
        if (form.reportProtocol === 'SICHUAN' && !value) {
          callback(new Error('请输入核素类型'))
        } else {
          callback()
        }
      },
      trigger: 'blur'
    }
  ],

  // 山东协议验证
  inspectionMachineNumber: [
    {
      validator: (rule, value, callback) => {
        if (form.reportProtocol === 'SHANDONG') {
          if (!value) {
            callback(new Error('请输入探伤机编号'))
          } else if (!/^\d{6}$/.test(value)) {
            callback(new Error('探伤机编号必须为6位数字'))
          } else {
            callback()
          }
        } else {
          callback()
        }
      },
      trigger: 'blur'
    }
  ],

  sourceNumber: [
    {
      validator: (rule, value, callback) => {
        if (form.reportProtocol === 'SHANDONG') {
          if (!value) {
            callback(new Error('请输入放射源编号'))
          } else if (!/^\d{12}$/.test(value)) {
            callback(new Error('放射源编号必须为12位数字'))
          } else {
            callback()
          }
        } else {
          callback()
        }
      },
      trigger: 'blur'
    }
  ],

  sourceType: [
    {
      validator: (rule, value, callback) => {
        if (form.reportProtocol === 'SHANDONG' && !value) {
          callback(new Error('请选择放射源类别'))
        } else {
          callback()
        }
      },
      trigger: 'change'
    }
  ],

  originalActivity: [
    {
      validator: (rule, value, callback) => {
        if (form.reportProtocol === 'SHANDONG') {
          if (!value) {
            callback(new Error('请输入原始活度'))
          } else if (!/^\d+\.\d+E[+-]?\d+$/.test(value)) {
            callback(new Error('请输入正确的科学计数法格式，如 2.700E004'))
          } else {
            callback()
          }
        } else {
          callback()
        }
      },
      trigger: 'blur'
    }
  ],

  currentActivity: [
    {
      validator: (rule, value, callback) => {
        if (form.reportProtocol === 'SHANDONG') {
          if (!value) {
            callback(new Error('请输入当前活度'))
          } else if (!/^\d+\.\d+E[+-]?\d+$/.test(value)) {
            callback(new Error('请输入正确的科学计数法格式，如 1.300E004'))
          } else {
            callback()
          }
        } else {
          callback()
        }
      },
      trigger: 'blur'
    }
  ],

  sourceProductionDate: [
    {
      validator: (rule, value, callback) => {
        if (form.reportProtocol === 'SHANDONG' && !value) {
          callback(new Error('请选择出厂日期'))
        } else {
          callback()
        }
      },
      trigger: 'change'
    }
  ]
}
```

---

### 页面3：普通用户 - 设备列表（只读）

**路径**：`/devices`
**组件**：`DeviceList.vue`

#### 设备列表表格

```vue
<el-table :data="devices">
  <el-table-column prop="deviceCode" label="设备编码" />
  <el-table-column prop="deviceName" label="设备名称" />
  <el-table-column prop="deviceType" label="设备类型" />

  <!-- 上报状态（只读） -->
  <el-table-column label="上报状态" width="100">
    <template #default="{ row }">
      <el-tag :type="row.dataReportEnabled ? 'success' : 'info'">
        {{ row.dataReportEnabled ? '已启用' : '未启用' }}
      </el-tag>
    </template>
  </el-table-column>

  <el-table-column prop="reportProtocol" label="上报协议" width="100">
    <template #default="{ row }">
      {{ row.reportProtocol === 'SICHUAN' ? '四川协议' : '山东协议' }}
    </template>
  </el-table-column>

  <el-table-column prop="lastReportTime" label="最后上报">
    <template #default="{ row }">
      {{ row.lastReportTime || '从未上报' }}
    </template>
  </el-table-column>

  <el-table-column label="成功率" width="120">
    <template #default="{ row }">
      <el-progress
        :percentage="calculateSuccessRate(row)"
        :color="getSuccessRateColor(calculateSuccessRate(row))"
      />
    </template>
  </el-table-column>

  <el-table-column label="操作" width="150">
    <template #default="{ row }">
      <el-button size="small" @click="handleViewDetail(row)">
        查看详情
      </el-button>
      <el-button
        size="small"
        @click="handleViewLog(row)"
        :disabled="!row.dataReportEnabled"
      >
        查看日志
      </el-button>
    </template>
  </el-table-column>
</el-table>
```

---

### 页面4：普通用户 - 设备详情（只读）

**路径**：`/devices/:id`
**组件**：`DeviceDetail.vue`

#### 详情页面结构

```vue
<el-descriptions :column="2" border>
  <!-- 基础信息 -->
  <el-descriptions-item label="设备编码">
    {{ device.deviceCode }}
  </el-descriptions-item>
  <el-descriptions-item label="设备名称">
    {{ device.deviceName }}
  </el-descriptions-item>
  <el-descriptions-item label="设备类型">
    <el-tag :type="device.deviceType === 'RADIATION_MONITOR' ? 'danger' : 'success'">
      {{ device.deviceType === 'RADIATION_MONITOR' ? '辐射设备' : '环境设备' }}
    </el-tag>
  </el-descriptions-item>

  <!-- 上报配置（只读显示） -->
  <el-descriptions-item label="上报状态">
    <el-tag :type="device.dataReportEnabled ? 'success' : 'info'">
      {{ device.dataReportEnabled ? '已启用' : '未启用' }}
    </el-tag>
    <el-text v-if="!device.dataReportEnabled" type="info" class="ml-2">
      (请联系管理员启用)
    </el-text>
  </el-descriptions-item>

  <el-descriptions-item label="上报协议">
    {{ device.reportProtocol === 'SICHUAN' ? '四川协议' : '山东协议' }}
  </el-descriptions-item>

  <!-- 辐射设备专用配置（只读） -->
  <template v-if="device.deviceType === 'RADIATION_MONITOR'">
    <el-descriptions-item label="核素类型">
      {{ device.nuclide || '-' }}
    </el-descriptions-item>

    <template v-if="device.reportProtocol === 'SHANDONG'">
      <el-descriptions-item label="探伤机编号">
        {{ device.inspectionMachineNumber || '-' }}
      </el-descriptions-item>
      <el-descriptions-item label="放射源编号">
        {{ device.sourceNumber || '-' }}
      </el-descriptions-item>
      <el-descriptions-item label="放射源类别">
        {{ getSourceTypeLabel(device.sourceType) }}
      </el-descriptions-item>
      <el-descriptions-item label="原始活度">
        {{ device.originalActivity || '-' }}
      </el-descriptions-item>
      <el-descriptions-item label="当前活度">
        {{ device.currentActivity || '-' }}
      </el-descriptions-item>
      <el-descriptions-item label="出厂日期">
        {{ device.sourceProductionDate || '-' }}
      </el-descriptions-item>
    </template>
  </template>

  <!-- 上报统计 -->
  <el-descriptions-item label="最后上报时间">
    {{ device.lastReportTime || '从未上报' }}
  </el-descriptions-item>
  <el-descriptions-item label="最后上报状态">
    <el-tag :type="device.lastReportStatus === 'SUCCESS' ? 'success' : 'danger'">
      {{ device.lastReportStatus === 'SUCCESS' ? '成功' : '失败' }}
    </el-tag>
  </el-descriptions-item>
  <el-descriptions-item label="总上报次数" :span="2">
    {{ device.totalReportCount || 0 }} 次
  </el-descriptions-item>
  <el-descriptions-item label="成功次数">
    {{ device.successReportCount || 0 }} 次
  </el-descriptions-item>
  <el-descriptions-item label="成功率">
    <el-progress
      :percentage="calculateSuccessRate(device)"
      :color="getSuccessRateColor(calculateSuccessRate(device))"
    />
  </el-descriptions-item>

  <el-descriptions-item label="最后错误" :span="2" v-if="device.lastReportError">
    <el-text type="danger">{{ device.lastReportError }}</el-text>
  </el-descriptions-item>
</el-descriptions>
```

---

## 🔌 API接口需求

### 1. 更新设备上报配置（管理员）

```javascript
// 更新设备（包含上报配置）
// PUT /api/admin/devices/{id}
// 或 PUT /api/devices/{id} （已有接口，扩展支持上报配置字段）

Request Body:
{
  // 基础字段
  "deviceName": "设备名称",
  "location": "位置",

  // 上报配置
  "dataReportEnabled": true,
  "reportProtocol": "SICHUAN",

  // 辐射设备专用（按协议类型动态传参）
  "nuclide": "Cs-137",                    // 四川协议
  "inspectionMachineNumber": "123456",     // 山东协议
  "sourceNumber": "123456789012",          // 山东协议
  "sourceType": "01",                      // 山东协议
  "originalActivity": "2.700E004",         // 山东协议
  "currentActivity": "1.300E004",          // 山东协议
  "sourceProductionDate": "2022-01-01"      // 山东协议
}
```

### 2. 获取设备详情（所有角色）

```javascript
// GET /api/devices/{id}
// 已有接口，返回结构需包含上报配置字段

Response:
{
  "id": 1,
  "deviceCode": "RAD001",
  "deviceName": "辐射设备1",
  "deviceType": "RADIATION_MONITOR",

  // 上报配置
  "dataReportEnabled": true,
  "reportProtocol": "SICHUAN",

  // 辐射设备专用
  "nuclide": "Cs-137",
  "inspectionMachineNumber": "123456",
  "sourceNumber": "123456789012",
  "sourceType": "01",
  "originalActivity": "2.700E004",
  "currentActivity": "1.300E004",
  "sourceProductionDate": "2022-01-01",

  // 上报统计（只读）
  "lastReportTime": "2025-12-29 10:00:00",
  "lastReportStatus": "SUCCESS",
  "lastReportError": null,
  "totalReportCount": 100,
  "successReportCount": 95
}
```

### 3. 切换上报开关（快捷操作）

```javascript
// PATCH /api/devices/{id}/report-toggle
// 或使用现有的 updateDevice 接口

Request Body:
{
  "dataReportEnabled": true
}
```

---

## 🎯 配置项显示逻辑

### 协议切换时字段显示规则

```javascript
const showSichuanFields = computed(() => {
  return device.deviceType === 'RADIATION_MONITOR' &&
         form.reportProtocol === 'SICHUAN' &&
         form.dataReportEnabled
})

const showShandongFields = computed(() => {
  return device.deviceType === 'RADIATION_MONITOR' &&
         form.reportProtocol === 'SHANDONG' &&
         form.dataReportEnabled
})
```

### 协议切换时的默认值处理

```javascript
const handleProtocolChange = (newProtocol) => {
  if (newProtocol === 'SICHUAN') {
    // 四川协议默认值
    form.nuclide = form.nuclide || 'Cs-137'
    // 清空山东协议字段
    form.inspectionMachineNumber = null
    form.sourceNumber = null
    form.sourceType = null
    form.originalActivity = null
    form.currentActivity = null
    form.sourceProductionDate = null
  } else if (newProtocol === 'SHANDONG') {
    // 山东协议默认值
    form.sourceType = form.sourceType || '01'
    // 清空四川协议字段
    form.nuclide = null
  }
}
```

---

## 📱 响应式设计建议

### 移动端适配

```vue
<!-- 在小屏幕上调整表单布局 -->
<el-form-item label="启用数据上报" prop="dataReportEnabled">
  <el-switch v-model="form.dataReportEnabled" />
</el-form-item>

<!-- 协议选择使用卡片式单选按钮（移动端友好） -->
<el-form-item label="上报协议" prop="reportProtocol">
  <el-radio-group
    v-model="form.reportProtocol"
    :disabled="!form.dataReportEnabled"
    class="protocol-radio-group"
  >
    <el-radio-button value="SICHUAN">
      <div class="protocol-option">
        <div class="protocol-title">四川协议</div>
        <div class="protocol-desc">HTTP + SM2加密</div>
      </div>
    </el-radio-button>
    <el-radio-button value="SHANDONG">
      <div class="protocol-option">
        <div class="protocol-title">山东协议</div>
        <div class="protocol-desc">TCP + HJ/T212-2005</div>
      </div>
    </el-radio-button>
  </el-radio-group>
</el-form-item>
```

---

## ⚠️ 注意事项

### 1. 设备没有上报功能的情况

**现状**：所有设备都支持上报功能，但有些设备可能未启用。

**处理方式**：
- 表格中显示开关状态（未启用显示为灰色）
- 未启用设备不显示"查看日志"按钮
- 详情页显示提示信息："该设备未启用数据上报功能"

### 2. 环境设备配置

**特点**：环境设备只需要基础配置，无需辐射设备专用字段。

**处理方式**：
- 在配置对话框中根据`deviceType`动态显示字段
- 环境设备显示提示信息："环境设备仅需配置基础上报参数"

### 3. GPS字段说明

**重要**：GPS已自动选择，无需用户配置，但需要在前端界面说明。

**显示位置**：
- 配置对话框顶部显示提示信息（使用 el-alert）
- 说明系统自动选择GPS的逻辑
- 避免用户误以为需要手动配置GPS优先级

### 4. 数据验证

**前端验证**：
- 必填字段验证（根据协议类型动态调整）
- 格式验证（数字位数、科学计数法等）
- 提交前完整验证

**后端验证**：
- 已实现，无需额外修改

---

## 🚀 实施建议

### 第一步：API接口验证
1. 确认后端返回数据包含所有上报配置字段
2. 测试更新接口支持上报配置参数
3. 验证权限控制（ADMIN才能修改）

### 第二步：前端开发
1. 创建 `DeviceReportConfigDialog.vue` 组件
2. 在 `DeviceManagement.vue` 中集成配置对话框
3. 在 `DeviceDetail.vue` 中添加只读显示
4. 更新 `DeviceList.vue` 显示上报状态

### 第三步：测试验证
1. 管理员配置辐射设备（四川协议）
2. 管理员配置辐射设备（山东协议）
3. 管理员配置环境设备
4. 普通用户查看设备详情（只读）
5. 验证权限控制（普通用户无法修改）

### 第四步：文档更新
1. 更新用户操作手册
2. 添加截图说明
3. 标注注意事项

---

## 📚 相关文档

- [GPS数据处理优化方案.md](./GPS数据处理优化方案.md)
- [数据上报模块设计方案V3-极简版.md](./数据上报模块设计方案V3-极简版.md)
- [双上报模式综合设计方案V2-极简版.md](./双上报模式综合设计方案V2-极简版.md)

---

**文档版本**：1.0
**创建日期**：2025-12-29
**最后更新**：2025-12-29
**作者**：Claude Code
**状态**：✅ 待实施
