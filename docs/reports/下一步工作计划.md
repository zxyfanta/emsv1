# 下一步工作计划

## 📊 当前状态总结

### ✅ 已完成的工作

1. **Python测试脚本** - 验证协议可行性
   - ✅ 数据包格式正确（包含长度字段）
   - ✅ SIM卡号 = 设备编号(MN) = `865229085145869`
   - ✅ 放射源编号可含字母 = `DE25IR006722`
   - ✅ 握手策略：忽略服务器初始CM消息
   - ✅ 测试通过：服务器返回0x01（成功）

2. **Java后端协议服务** - HJT212ProtocolService
   - ✅ 修复数据包格式（添加数据段长度字段）
   - ✅ 支持二进制响应解析
   - ✅ 支持文本响应解析（兼容旧服务器）
   - ✅ 编译通过

3. **数据流程理解**
   - ✅ MQTT: `ems/device/{SIM卡号}/data/RADIATION`
   - ✅ DeviceDataEvent事件发布
   - ✅ ShandongDataReportService监听并上报

### ⚠️ 待完成的工作

---

## 🎯 优先级1：修复ShandongDataReportService

### 问题
当前实现没有处理服务器的初始CM消息，可能导致数据上报失败。

### 解决方案
更新 `ShandongDataReportService.report()` 方法：

```java
// 3. 建立 TCP 连接
socket = new Socket(
    properties.getShandong().getHost(),
    properties.getShandong().getPort()
);

socket.setSoTimeout(properties.getShandong().getSoTimeout());

// ⭐ 新增：清除服务器的初始CM消息（不响应）
socket.setSoTimeout(1000); // 短超时读取初始消息
try {
    byte[] initialBuffer = new byte[1024];
    int initialRead = socket.getInputStream().read(initialBuffer);
    if (initialRead > 0) {
        log.debug("📥 收到服务器初始消息: {} 字节 (已忽略)",
            initialRead);
    }
} catch (java.net.SocketTimeoutException e) {
    log.debug("ℹ️ 无初始消息（正常情况）");
} finally {
    socket.setSoTimeout(properties.getShandong().getSoTimeout()); // 恢复原超时
}
```

### 测试计划
1. 修改ShandongDataReportService
2. 运行后端，触发数据上报
3. 查看日志确认：
   - 初始CM消息被正确接收并忽略
   - 数据包成功发送
   - 服务器返回0x01成功状态

---

## 🎯 优先级2：更新配置文件

### 更新 application.yaml
添加新服务器地址配置：

```yaml
app:
  ems:
    data-report:
      shandong:
        host: 221.214.62.118  # 新服务器地址
        port: 20050            # 新端口
        password: 123456
        so-timeout: 10000      # 10秒超时
        enabled: true          # 启用山东上报
```

### 验证配置
- 确认配置属性正确加载
- 测试连接性
- 验证数据包格式

---

## 🎯 优先级3：完善错误处理和日志

### 改进响应解析
在ShandongDataReportService中：

```java
// 5. 接收应答
BufferedReader in = new BufferedReader(
    new InputStreamReader(socket.getInputStream())
);

String response = in.readLine();

// ⭐ 新增：详细记录响应信息
log.info("📥 服务器响应: length={}, hex={}, ascii={}",
    response != null ? response.length() : 0,
    response != null ? bytesToHex(response.getBytes(StandardCharsets.ISO_8859_1)) : "null",
    response);

// 6. 处理应答
boolean success = protocolService.parseResponse(response);

if (success) {
    log.info("✅ [山东] 上报成功: deviceCode={}, 耗时={}ms",
        deviceCode, duration);
} else {
    log.warn("⚠️ [山东] 上报失败: deviceCode={}, 耗时={}ms, 响应={}",
        deviceCode, duration, response);
}
```

### 添加辅助方法
```java
private String bytesToHex(byte[] bytes) {
    StringBuilder sb = new StringBuilder();
    for (byte b : bytes) {
        sb.append(String.format("%02X ", b));
    }
    return sb.toString().trim();
}
```

---

## 🎯 优先级4：集成测试

### 测试场景
1. **端到端测试**
   - MQTT设备 → 数据库 → ShandongDataReportService → 山东服务器
   - 验证完整数据流程

2. **错误恢复测试**
   - 网络中断后重连
   - 服务器无响应处理
   - 数据包发送失败重试

3. **性能测试**
   - 并发多设备上报
   - 长时间运行稳定性

### 测试工具
- 使用Python脚本模拟设备发送MQTT消息
- 使用Wireshark抓包验证TCP通信
- 查看后端日志分析数据流程

---

## 🎯 优先级5：监控和告警

### 添加监控指标
1. **上报成功率**
   - 成功次数/总次数
   - 失败原因统计
   - 平均响应时间

2. **数据质量**
   - 数据包格式正确率
   - CRC校验失败率
   - 设备离线率

3. **告警规则**
   - 上报失败率 > 10%
   - 服务器无响应 > 1分钟
   - 数据格式错误率 > 5%

---

## 📝 任务清单

### 立即执行（今天）
- [ ] 修复ShandongDataReportService握手逻辑
- [ ] 更新application.yaml配置
- [ ] 本地测试数据上报

### 短期任务（本周）
- [ ] 完善错误处理和日志
- [ ] 端到端集成测试
- [ ] 更新文档

### 中期任务（下周）
- [ ] 添加监控指标
- [ ] 配置告警规则
- [ ] 性能优化

---

## 🔧 技术细节

### MQTT订阅主题中的SIM卡号

**当前主题格式**:
```
ems/device/{SIM卡号}/data/RADIATION
ems/device/865229085145869/data/RADIATION
```

**解析逻辑**（MqttMessageListener.java:109）:
```java
String deviceCode = topicParts[2]; // 提取SIM卡号
```

**数据流程**:
1. 设备通过MQTT发送数据到 `ems/device/865229085145869/data/RADIATION`
2. MqttMessageListener接收并解析SIM卡号
3. 保存数据到数据库
4. 发布DeviceDataEvent事件（包含SIM卡号）
5. ShandongDataReportService监听事件
6. 使用SIM卡号作为MN字段构建HJ/T212数据包
7. 上报到山东服务器 `221.214.62.118:20050`

### 数据包格式示例

**完整数据包**:
```
##0288QN=2025122916542617321;ST=61;CN=3051;PW=123456;CP=&&MN=865229085145869;Ma=002162;Rno=DE25IR006722;Xtype=02;LastAct=5.530E012;NowAct=3.270E012;SourceTime=20250703;DataTime=20251229165426;LONG=12102.1465;LAT=3740.5073;Xvalue=1000000.000;Thres=100000.000;AlertType=01;BattChar=1000.0;Sig=A&&5F00\r\n
```

**结构分解**:
- `##` - 包头
- `0288` - 数据段长度（4位十进制）
- `QN=...` - 数据段（288字节）
- `5F00` - CRC16校验码
- `\r\n` - 包尾

---

## 📞 联系和配置

**服务器信息**:
- 地址: 221.214.62.118
- 端口: 20050
- 协议: TCP + HJ/T212-2005
- 密码: 123456

**SIM卡号**: 865229085145869

**放射源编号**: DE25IR006722

---

## ✅ 验收标准

### 功能验收
1. ✅ 数据能从MQTT接收并保存到数据库
2. ✅ ShandongDataReportService能正确构建数据包
3. ✅ 数据能成功上报到山东服务器
4. ✅ 服务器返回0x01成功状态

### 性能验收
1. ✅ 单次上报响应时间 < 500ms
2. ✅ 上报成功率 > 95%
3. ✅ 系统能稳定运行24小时

### 日志验收
1. ✅ 能看到初始CM消息的接收和忽略
2. ✅ 能看到数据包的十六进制内容
3. ✅ 能看到服务器的响应状态码

---

**计划版本**: v1.0
**创建日期**: 2024-12-29
**状态**: 待执行
