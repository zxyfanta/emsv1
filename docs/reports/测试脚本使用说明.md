# 山东协议测试脚本使用说明

本目录包含两个 Python 测试脚本，用于验证山东协议（HJ/T212-2005）服务器的连接和功能。

## 📁 文件说明

### 1. `test_shandong_protocol.py` - 完整测试脚本
功能完整的测试脚本，包含详细的测试流程和结果分析。

**功能：**
- TCP 连接测试
- 实时数据上报（命令 3051）
- 正常数据测试
- 报警数据测试
- 批量连续数据测试（5次）
- CRC16 校验计算
- 应答包解析
- 详细的测试报告

**适用场景：**
- 完整的功能验证
- 问题诊断和分析
- 性能测试

### 2. `test_shandong_quick.py` - 快速测试脚本
简化版的快速测试脚本，用于快速验证服务器状态。

**功能：**
- TCP 连接测试
- 延迟测试
- 基本数据发送测试
- 应答解析
- 简洁的测试报告

**适用场景：**
- 快速验证服务器是否可用
- 日常巡检
- 快速故障排查

## 🚀 快速开始

### 1. 安装依赖
```bash
# 确保已安装 Python 3.6+
python3 --version

# 无需额外依赖，只使用 Python 标准库
```

### 2. 配置参数
在脚本中修改以下配置：

```python
# 服务器配置
SERVER_HOST = "103.203.219.138"  # 服务器地址
SERVER_PORT = 18086                # 服务器端口

# 设备配置
DEVICE_MN = "01010101010101"       # 设备编号（14位）
PASSWORD = "123456"                # 访问密码（6位）
```

### 3. 运行测试

#### 快速测试（推荐）
```bash
# 赋予执行权限
chmod +x test_shandong_quick.py

# 运行快速测试
python3 test_shandong_quick.py
```

#### 完整测试
```bash
# 赋予执行权限
chmod +x test_shandong_protocol.py

# 运行完整测试
python3 test_shandong_protocol.py
```

## 📊 测试内容

### 测试场景1：正常数据上报
- 包含完整的设备信息
- 正常的剂量率数据
- GPS 定位信息
- 验证服务器接收和处理

### 测试场景2：报警数据上报
- 高剂量率触发报警
- 报警类型字段
- 验证报警处理逻辑

### 测试场景3：连续数据上报
- 连续发送 5 条数据
- 验证服务器稳定性
- 测试数据处理能力

## 📋 协议格式

### 数据包结构
```
##QN=YYYYMMDDHHMMSSZZZZS;ST=61;CN=3051;PW=123456;CP=&&MN=01010101010101;...&&CRC\r\n
```

### 字段说明

| 字段 | 说明 | 示例 | 长度 |
|-----|------|------|------|
| 包头 | 固定标识 | ## | 2 |
| QN | 请求编号 | 2024122914302500011 | 20 |
| ST | 系统编号 | 61（现场机） | 变长 |
| CN | 命令编号 | 3051（实时数据） | 变长 |
| PW | 访问密码 | 123456 | 变长 |
| CP | 数据内容 | MN=...;Xvalue=...; | 变长 |
| CRC | 校验码 | A1B2 | 4 |
| 包尾 | 回车换行 | \r\n | 2 |

### 关键字段（CP部分）

| 字段 | 说明 | 格式 |
|-----|------|------|
| MN | 设备编号 | 14位数字 |
| Ma | 探伤机编号 | 6位数字 |
| Rno | 放射源编号 | 12位数字 |
| Xtype | 放射源类型 | 01-05 |
| LastAct | 原始活度 | 科学计数法 |
| NowAct | 当前活度 | 科学计数法 |
| DataTime | 数据时间 | YYYYMMDDHHmmss |
| Xvalue | 剂量率 | 浮点数 |
| LONG | GPS经度 | 度分格式 |
| LAT | GPS纬度 | 度分格式 |
| Sig | GPS标志 | A/V |

## ✅ 测试结果判断

### 成功标志
- TCP 连接成功
- 数据包发送成功
- 收到服务器应答
- 应答中包含 `ST=91`（成功）

### 失败标志
- 连接被拒绝（Connection Refused）
- 连接超时（Timeout）
- 未收到应答
- 应答中包含 `ST=92`（失败）

## 🔧 故障排查

### 1. 连接失败
```
❌ 连接被拒绝
```
**可能原因：**
- 服务器地址或端口错误
- 服务器未运行
- 防火墙阻止连接

**解决方法：**
- 检查服务器地址和端口配置
- 确认服务器是否正在运行
- 检查网络连接和防火墙设置

### 2. 连接超时
```
❌ 连接超时（5秒）
```
**可能原因：**
- 网络延迟过高
- 服务器响应慢
- 网络不稳定

**解决方法：**
- 检查网络连接
- 增加超时时间
- 尝试使用其他网络

### 3. 发送失败
```
❌ 数据发送失败
```
**可能原因：**
- 连接中断
- 数据包格式错误
- 权限问题

**解决方法：**
- 检查连接状态
- 验证数据包格式
- 确认设备编号和密码

### 4. 未收到应答
```
❌ 未收到应答
```
**可能原因：**
- 服务器未处理请求
- 数据包内容不符合协议
- 服务器繁忙

**解决方法：**
- 检查服务器日志
- 验证数据包格式和内容
- 联系服务器管理员

## 📞 技术支持

如需帮助，请提供以下信息：
1. 服务器地址和端口
2. 错误信息截图
3. 网络环境描述
4. 服务器日志（如有）

## 📝 更新日志

### v1.0.0 (2024-12-29)
- 初始版本
- 实现基本连接测试
- 实现数据上报功能
- 实现 CRC16 校验
- 实现应答解析

## 📚 参考资料

- 《放射源监控设备与平台通信协议（2019.9.6）》
- 《HJ/T212-2005 环境污染源自动监控信息传输、交换技术规范》
- 山东省生态环境监测平台对接文档
