# 数据上报功能 - 用户角色操作说明

## 📋 角色定义

### 1. ADMIN (管理员)
- 系统管理员
- 可以管理所有企业的配置
- 负责系统级别的配置和监控

### 2. USER (普通用户)
- 企业用户
- 只能管理自己企业的上报
- 可以查看和触发上报

---

## 🔧 ADMIN管理员功能

### 功能1: 查看所有企业的上报配置
```
路径: /data-submission/admin/configs
权限: @PreAuthorize("hasRole('ADMIN')")

可以看到:
✅ 所有企业的上报配置列表
✅ 每个企业的启用/禁用状态
✅ 最后上报时间
✅ 成功率统计
✅ 失败次数
```

**界面示例:**
```
┌─────────────────────────────────────────────────────────┐
│ 数据上报配置管理                    [新增配置] [批量操作] │
├─────────────────────────────────────────────────────────┤
│ 企业名称 │ 配置名称 │ 状态 │ 粒度 │ 成功率 │ 操作    │
├─────────────────────────────────────────────────────────┤
│ 默认测试企业 │ 辐射数据上报 │ ✅启用 │ HOUR │ 98% │[详情]│
│ XX环保公司  │ 环境数据上报 │ ❌禁用 │ DAY  │ --  │[编辑]│
│ YY监测站   │ 辐射数据上报 │ ✅启用 │ MIN  │ 95% │[日志]│
└─────────────────────────────────────────────────────────┘
```

---

### 功能2: 创建/编辑/删除上报配置
```
路径:
- POST /data-submission/admin/configs (创建)
- PUT /data-submission/admin/configs/{id} (编辑)
- DELETE /data-submission/admin/configs/{id} (删除)

权限: @PreAuthorize("hasRole('ADMIN')")

可以配置:
✅ 为哪个企业配置
✅ 上报粒度 (MIN/HOUR/DAY)
✅ GPS优先级 (BDS/LBS/BDS_THEN_LBS)
✅ 上报间隔
✅ 是否包含离线设备
✅ 每批上报数量
✅ 设备过滤条件
```

**配置表单示例:**
```
┌─────────────────────────────────────────┐
│ 新增/编辑数据上报配置                   │
├─────────────────────────────────────────┤
│ 企业 *: [默认测试企业 ▼]               │
│                                         │
│ 配置名称 *: [辐射数据GPS上报____]      │
│                                         │
│ 是否启用: [✓] 启用自动上报              │
│                                         │
│ 上报粒度: ○分钟 ○小时 ●天              │
│                                         │
│ 上报间隔: [1] 天                        │
│                                         │
│ GPS优先级: ●BDS优先 ○LBS ○BDS然后LBS   │
│                                         │
│ 包含离线设备: [ ]                       │
│                                         │
│ 每批数量: [100] 条                      │
│                                         │
│ 设备过滤: [所有设备____]               │
│                                         │
│          [保存] [取消]                  │
└─────────────────────────────────────────┘
```

---

### 功能3: 查看所有上报日志
```
路径: /data-submission/admin/logs
权限: @PreAuthorize("hasRole('ADMIN')")

可以看到:
✅ 所有企业的上报历史
✅ 成功/失败状态
✅ 错误信息
✅ HTTP状态码
✅ 响应内容
✅ 性能指标(耗时)
```

**日志列表示例:**
```
┌────────────────────────────────────────────────────────────┐
│ 上报日志                           [筛选] [导出]           │
├────────────────────────────────────────────────────────────┤
│ 企业   │ 设备  │ 时间  │ 状态  │ 记录数 │ 耗时 │ 操作   │
├────────────────────────────────────────────────────────────┤
│ 默认测试│ DEV001│14:30 │✅成功│ 100  │ 234ms│[详情] │
│ 默认测试│ DEV002│14:25 │❌失败│ 0    │ --   │[详情] │
│ XX环保 │ DEV003│14:20 │✅成功│ 50   │ 156ms│[详情] │
└────────────────────────────────────────────────────────────┘
```

**日志详情示例:**
```
┌─────────────────────────────────────────┐
│ 上报日志详情                             │
├─────────────────────────────────────────┤
│ 企业: 默认测试企业                       │
│ 设备: DEV001                            │
│ 上报时间: 2025-12-27 14:30:45           │
│ 状态: ✅ 成功                            │
│ 记录数: 100                             │
│ 耗时: 234ms                             │
│                                         │
│ 请求信息:                               │
│ URL: http://59.225.208.12:18085/...    │
│ Method: POST                            │
│ Headers:                                │
│   X-Key-ID: AK-9lKIK7RZ...              │
│   Content-Type: application/json        │
│                                         │
│ 响应信息:                               │
│ HTTP Status: 200 OK                     │
│ Body:                                   │
│   {                                     │
│     "success": true,                    │
│     "statusCode": 0,                    │
│     "message": "数据接收成功"            │
│   }                                     │
│                                         │
│          [关闭]                         │
└─────────────────────────────────────────┘
```

---

### 功能4: 全局统计监控
```
路径: /data-submission/admin/stats
权限: @PreAuthorize("hasRole('ADMIN')")

可以看到:
✅ 所有企业的上报统计
✅ 成功率排行
✅ 失败原因分析
✅ 性能指标
✅ 趋势图表
```

**统计报表示例:**
```
┌─────────────────────────────────────────────┐
│ 上报统计报表                                 │
├─────────────────────────────────────────────┤
│                                             │
│ 总体概况:                                    │
│ - 配置企业数: 15                            │
│ - 启用配置数: 12                            │
│ - 今日上报次数: 288                         │
│ - 平均成功率: 97.5%                         │
│                                             │
│ 成功率TOP5:                                  │
│ 1. 默认测试企业: 99.2%                      │
│ 2. XX环保公司: 98.5%                        │
│ 3. YY监测站: 97.8%                          │
│ ...                                        │
│                                             │
│ 失败原因分析:                                │
│ - 网络超时: 5次 (45%)                      │
│ - 设备离线: 3次 (27%)                       │
│ - 加密失败: 2次 (18%)                       │
│ - 其他: 1次 (9%)                            │
│                                             │
│ [导出报表] [刷新数据]                       │
└─────────────────────────────────────────────┘
```

---

## 👤 USER普通用户功能

### 功能1: 查看自己企业的上报配置
```
路径: /data-submission/my-config
权限: 已登录即可

可以看到:
✅ 自己企业的配置信息
✅ 启用/禁用状态
✅ 最后上报时间
✅ 成功率统计
✅ 下次上报时间

❌ 不能修改配置(需要管理员操作)
```

**界面示例:**
```
┌─────────────────────────────────────────┐
│ 我的数据上报配置                         │
├─────────────────────────────────────────┤
│                                         │
│ 📊 配置状态                              │
│ 状态: ✅ 已启用                          │
│ 配置名称: 辐射数据GPS上报                 │
│                                         │
│ 📋 上报设置                              │
│ 上报粒度: HOUR (小时级)                  │
│ GPS优先级: BDS (北斗定位优先)            │
│ 上报间隔: 每1小时                         │
│ 包含离线设备: 否                          │
│                                         │
│ 📈 统计信息                              │
│ 最后上报: 2025-12-27 14:00:00            │
│ 下次上报: 2025-12-27 15:00:00            │
│ 总上报次数: 156                          │
│ 成功次数: 153                            │
│ 失败次数: 3                              │
│ 成功率: 98.1%                            │
│                                         │
│ [查看日志] [立即上报]                    │
└─────────────────────────────────────────┘
```

---

### 功能2: 查看自己的上报日志
```
路径: /data-submission/my-logs
权限: 已登录即可

可以看到:
✅ 自己企业的上报历史
✅ 成功/失败状态
✅ 基本的错误信息
✅ 记录数、耗时等

❌ 不能看到其他企业的日志
```

**日志列表示例:**
```
┌──────────────────────────────────────────────────┐
│ 我的上报日志                    [刷新] [导出]     │
├──────────────────────────────────────────────────┤
│ 上报时间    │ 设备  │ 状态 │ 记录数 │ 耗时   │ 详情│
├──────────────────────────────────────────────────┤
│ 12-27 14:00 │ DEV001│ ✅成功│ 100   │ 234ms  │[查看]│
│ 12-27 13:00 │ DEV002│ ✅成功│ 98    │ 189ms  │[查看]│
│ 12-27 12:00 │ DEV003│ ❌失败│ 0     │ --     │[查看]│
│ 12-27 11:00 │ DEV001│ ✅成功│ 102   │ 256ms  │[查看]│
└──────────────────────────────────────────────────┘
```

---

### 功能3: 手动触发上报
```
路径: POST /data-submission/trigger
权限: 已登录即可

功能:
✅ 立即执行一次数据上报
✅ 查看上报结果
✅ 不影响定时上报计划
```

**操作示例:**
```
┌─────────────────────────────────────────┐
│ 立即上报                                 │
├─────────────────────────────────────────┤
│                                         │
│ 确认要立即执行数据上报吗?                │
│                                         │
│ 上报范围: 最近1小时的数据                │
│ 预计记录数: ~100条                       │
│                                         │
│ [取消] [确认上报]                       │
└─────────────────────────────────────────┘
         ↓ 点击"确认上报"
┌─────────────────────────────────────────┐
│ 上报中...                                │
├─────────────────────────────────────────┤
│                                         │
│ ⏳ 正在加密数据...                       │
│ ⏳ 正在上报到监管平台...                 │
│ ✅ 上报成功!                             │
│                                         │
│ 记录数: 100                              │
│ 耗时: 234ms                              │
│                                         │
│ [查看详情] [关闭]                        │
└─────────────────────────────────────────┘
```

---

### 功能4: 查看上报统计
```
路径: /data-submission/my-stats
权限: 已登录即可

可以看到:
✅ 自己企业的上报统计
✅ 成功率趋势
✅ 最近7天的上报记录
✅ 基本的性能指标

❌ 不能看到其他企业的统计
```

**统计页面示例:**
```
┌─────────────────────────────────────────────┐
│ 上报统计                                     │
├─────────────────────────────────────────────┤
│                                             │
│ 📊 总体概况                                  │
│ - 总上报次数: 156                           │
│ - 成功率: 98.1%                             │
│ - 平均记录数: 98.5条/次                     │
│ - 平均耗时: 215ms                           │
│                                             │
│ 📈 最近7天成功率趋势                         │
│    100% ┤      *---*---*                    │
│     95% ┤  *---*       *                    │
│     90% ┤                                    │
│         └──────────────────                  │
│           21 22 23 24 25 26 27 (日期)        │
│                                             │
│ ⚠️  失败记录 (3次)                           │
│ - 12-27 12:00: 网络超时                      │
│ - 12-26 18:00: 设备离线                      │
│ - 12-26 03:00: 加密失败                      │
│                                             │
│ [查看详细日志]                              │
└─────────────────────────────────────────────┘
```

---

## 🎯 核心区别总结

| 功能 | ADMIN | USER |
|-----|-------|------|
| **查看配置** | ✅ 所有企业 | ✅ 仅自己的 |
| **创建配置** | ✅ | ❌ |
| **编辑配置** | ✅ | ❌ |
| **删除配置** | ✅ | ❌ |
| **启用/禁用** | ✅ | ❌ |
| **查看日志** | ✅ 所有企业 | ✅ 仅自己的 |
| **查看统计** | ✅ 全局统计 | ✅ 仅自己的 |
| **手动触发** | ✅ 任何企业 | ✅ 仅自己的 |
| **修改上报参数** | ✅ | ❌ |

---

## 💡 实际使用场景

### 场景1: 企业首次配置上报
```
1. ADMIN登录系统
2. 进入"数据管理"→"数据上报配置"
3. 点击"新增配置"
4. 为企业配置上报参数:
   - 选择企业
   - 设置上报粒度(小时/天)
   - 选择GPS优先级
   - 点击"保存"
5. 配置自动启用,系统开始定时上报
```

### 场景2: 企业用户查看上报状态
```
1. USER登录系统
2. 进入"数据管理"→"我的上报"
3. 查看:
   - 上报是否启用
   - 最后上报时间
   - 成功率统计
4. 如需要,点击"立即上报"手动触发
```

### 场景3: 上报失败排查
```
1. USER发现上报失败
2. 查看"我的上报日志"
3. 看到"网络超时"错误
4. 联系ADMIN

或者:

1. ADMIN在全局监控中发现某企业上报失败
2. 查看该企业的日志
3. 发现配置错误或网络问题
4. 修改配置或联系技术支持
```

### 场景4: 临时上报需求
```
1. USER需要立即上报最新数据
2. 点击"立即上报"按钮
3. 系统立即执行上报
4. 查看上报结果
```

---

## 🔐 安全考虑

### ADMIN不能看到的内容
- ❌ 其他企业的API Key (虽然现在是固定的)
- ❌ 加密前的详细数据内容
- ❌ 敏感的设备原始数据

### USER不能做的操作
- ❌ 修改上报配置(防止误操作)
- ❌ 删除上报日志(审计需要)
- ❌ 查看其他企业的数据
- ❌ 修改上报目标地址

---

## 📝 总结

### ADMIN是"配置者+监控者"
- 负责**配置和管理**所有企业的上报
- 负责**监控和排查**全局上报问题
- 拥有**完全控制权**

### USER是"查看者+使用者"
- 只能**查看**自己企业的上报状态
- 可以**触发**手动上报
- **不能修改**配置,确保系统稳定

这种设计既保证了灵活性(ADMIN可以集中管理),又保证了安全性(USER不能误操作)! ✨
