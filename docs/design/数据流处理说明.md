# EMSæ•°æ®æµå¤„ç†è¯´æ˜æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

- **é¡¹ç›®**: EMS (Energy Management System)
- **ç‰ˆæœ¬**: 1.0
- **æ›´æ–°æ—¥æœŸ**: 2025-12-30
- **æ–‡æ¡£ç±»å‹**: æ•°æ®æµè¯´æ˜

---

## ğŸ”„ æ•°æ®æµæ¦‚è¿°

EMSç³»ç»Ÿçš„æ•°æ®æµä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š

1. **è®¾å¤‡æ•°æ®é‡‡é›†æµ**: IoTè®¾å¤‡ â†’ MQTT Broker â†’ Backend â†’ Database
2. **å®æ—¶æ¨é€æµ**: Database Event â†’ SSE â†’ Frontend
3. **æ•°æ®ä¸ŠæŠ¥æµ**: Device Event â†’ Report Service â†’ å¤–éƒ¨ç›‘ç®¡å¹³å°
4. **å‘Šè­¦å¤„ç†æµ**: Device Data â†’ Alert Service â†’ Frontend

---

## ğŸ“¡ è®¾å¤‡æ•°æ®é‡‡é›†æµç¨‹

### æµç¨‹å›¾

```
IoTè®¾å¤‡ (è¾å°„/ç¯å¢ƒ)
    â”‚
    â”‚ â‘  MQTT/HTTP å‘é€æ•°æ®
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Mosquitto MQTT Brokerâ”‚
â”‚ Topic:               â”‚
â”‚ ems/device/+/data/+ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ â‘¡ è®¢é˜…æ¶ˆæ¯
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MqttMessageListener         â”‚
â”‚ backend/mqtt/               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â–º è¾å°„è®¾å¤‡æ•°æ®
           â”‚   â””â”€â–º â‘¢ RadiationDeviceDataService
           â”‚       â”œâ”€â–º â‘£ æ•°æ®éªŒè¯
           â”‚       â”œâ”€â–º â‘¤ æ•°æ®è½¬æ¢
           â”‚       â”œâ”€â–º â‘¥ ä¿å­˜åˆ°MySQL
           â”‚       â”œâ”€â–º â‘¦ æ›´æ–°Redisç¼“å­˜
           â”‚       â””â”€â–º â‘§ å‘å¸ƒDeviceDataEvent
           â”‚
           â””â”€â–º ç¯å¢ƒè®¾å¤‡æ•°æ®
               â””â”€â–º EnvironmentDeviceDataService
                   â”œâ”€â–º æ•°æ®éªŒè¯
                   â”œâ”€â–º ä¿å­˜åˆ°MySQL
                   â””â”€â–º å‘å¸ƒDeviceDataEvent
```

### è¯¦ç»†æ­¥éª¤

#### 1. MQTTæ¶ˆæ¯æ¥æ”¶

**ç›‘å¬å™¨**: [MqttMessageListener.java](../backend/src/main/java/com/cdutetc/ems/mqtt/MqttMessageListener.java)

```java
@Component
@RequiredArgsConstructor
@Slf4j
public class MqttMessageListener {

    private final RadiationDeviceDataService radiationService;

    @MqttListener(topics = "${app.ems.mqtt.topic-prefix}/device/+/data/RADIATION")
    public void handleRadiationDeviceData(String message,
                                         @Header MqttHeaders headers) {
        // 1. è§£æMQTTä¸»é¢˜è·å–è®¾å¤‡ç¼–ç 
        String deviceCode = extractDeviceCode(headers.getTopic());

        // 2. è§£æJSONæ¶ˆæ¯
        RadiationDeviceData data = parseMessage(message);

        // 3. ä¿å­˜æ•°æ®
        radiationService.saveRadiationDeviceData(deviceCode, data);
    }
}
```

**è®¢é˜…çš„ä¸»é¢˜**:
- `ems/device/+/data/RADIATION` - è¾å°„è®¾å¤‡æ•°æ®
- `ems/device/+/data/ENVIRONMENT` - ç¯å¢ƒè®¾å¤‡æ•°æ®

#### 2. æ•°æ®è§£æä¸éªŒè¯

**åŸå§‹æ•°æ®æ ¼å¼**:
```json
{
  "src": 1,
  "msgtype": 1,
  "BDS": {
    "longitude": "12102.1465",
    "latitude": "3740.5073",
    "useful": 1,
    "UTC": "2025-12-30 00:00:00"
  },
  "CPM": 150,
  "Batvolt": 3950,
  "trigger": 1,
  "multi": 1,
  "way": 1,
  "time": "2025-12-30 00:00:00"
}
```

**æ•°æ®è½¬æ¢**:
```java
// 1. CPMå€¼è½¬æ¢ (åŸå§‹å€¼ * è½¬æ¢ç³»æ•°)
Double cpm = rawData.getCpm() * conversionFactor;

// 2. ç”µå‹è½¬æ¢ (mV â†’ V)
Double voltage = rawData.getBatvolt() / 1000.0;

// 3. GPSå¤„ç† (æ ¹æ®usefulå­—æ®µé€‰æ‹©BDSæˆ–LBS)
if (gpsData.getUseful() == 1) {
    // ä½¿ç”¨åŒ—æ–—GPS (BDS)
    selectedGps = gpsData.getBDS();
} else {
    // ä½¿ç”¨åŸºç«™å®šä½ (LBS)
    selectedGps = gpsData.getLBS();
}
```

#### 3. æ•°æ®æŒä¹…åŒ–

**Service**: [RadiationDeviceDataService.java](../backend/src/main/java/com/cdutetc/ems/service/RadiationDeviceDataService.java)

```java
@Service
@Transactional
public class RadiationDeviceDataService {

    public RadiationDeviceData saveRadiationDeviceData(
            String deviceCode, RadiationDeviceData data) {

        // 1. æŸ¥æ‰¾æˆ–åˆ›å»ºè®¾å¤‡
        Device device = findOrCreateDevice(deviceCode);

        // 2. ä¿å­˜æ•°æ®
        RadiationDeviceData savedData = repository.save(data);

        // 3. æ›´æ–°è®¾å¤‡çŠ¶æ€
        device.setStatus(DeviceStatus.ONLINE);
        device.setLastOnlineAt(LocalDateTime.now());
        deviceRepository.save(device);

        // 4. æ›´æ–°Redisç¼“å­˜
        deviceStatusCacheService.updateDeviceCpm(deviceCode, data.getCpm());

        // 5. å‘å¸ƒäº‹ä»¶ï¼ˆè§¦å‘åç»­æµç¨‹ï¼‰
        publishDeviceDataEvent(deviceCode, data);

        return savedData;
    }
}
```

**æ•°æ®åº“è¡¨**: [ems_radiation_device_data](../backend/src/main/java/com/cdutetc/ems/entity/RadiationDeviceData.java)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| id | BIGINT | ä¸»é”® |
| device_id | BIGINT | è®¾å¤‡IDï¼ˆå¤–é”®ï¼‰ |
| cpm | DOUBLE | å‰‚é‡ç‡ (å·²è½¬æ¢) |
| batvolt | DOUBLE | ç”µæ± ç”µå‹ (V) |
| gps_longitude | VARCHAR(20) | GPSç»åº¦ |
| gps_latitude | VARCHAR(20) | GPSçº¬åº¦ |
| gps_type | VARCHAR(10) | GPSç±»å‹ (BDS/LBS) |
| record_time | DATETIME | è®°å½•æ—¶é—´ |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ |

---

## ğŸ”” å®æ—¶æ•°æ®æ¨é€æµç¨‹ (SSE)

### æµç¨‹å›¾

```
æ•°æ®åº“å˜æ›´ (INSERT/UPDATE)
    â”‚
    â”‚ â‘  æ•°æ®ä¿å­˜æˆåŠŸ
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DeviceDataEvent             â”‚
â”‚ (Spring Event)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â–º â‘¡ EventListener ç›‘å¬
           â”‚   â””â”€â–º SseEmitterService
           â”‚       â”œâ”€â–º â‘¢ æ¨é€åˆ°å‰ç«¯
           â”‚       â””â”€â–º SSEæ ¼å¼
           â”‚
           â””â”€â–º â‘£ DataReportEventListener
               â””â”€â–º æ•°æ®ä¸ŠæŠ¥æµç¨‹
```

### è¯¦ç»†æ­¥éª¤

#### 1. äº‹ä»¶å‘å¸ƒ

**Event**: [DeviceDataEvent.java](../backend/src/main/java/com/cdutetc/ems/dto/event/DeviceDataEvent.java)

```java
public class DeviceDataEvent extends ApplicationEvent {
    private final String eventType;      // "radiation-data"
    private final String deviceCode;
    private final String deviceType;    // "RADIATION_MONITOR"
    private final LocalDateTime eventTime;

    public DeviceDataEvent(String eventType, String deviceCode,
                          String deviceType, Object data) {
        super(data);  // æ•°æ®ä½œä¸ºsource
        this.eventType = eventType;
        this.deviceCode = deviceCode;
        this.deviceType = deviceType;
        this.eventTime = LocalDateTime.now();
    }
}
```

#### 2. SSEå®æ—¶æ¨é€

**Service**: [SseEmitterService.java](../backend/src/main/java/com/cdutetc/ems/service/SseEmitterService.java)

```java
@Service
@Slf4j
public class SseEmitterService {

    private final Map<String, SseEmitter> emitters = new ConcurrentHashMap<>();

    @EventListener
    public void handleDeviceDataEvent(DeviceDataEvent event) {
        // 1. æ„å»ºæ¨é€æ•°æ®
        Map<String, Object> payload = new HashMap<>();
        payload.put("deviceCode", event.getDeviceCode());
        payload.put("deviceType", event.getDeviceType());
        payload.put("timestamp", event.getEventTime().toString());

        // 2. æ¨é€åˆ°æ‰€æœ‰è®¢é˜…çš„å®¢æˆ·ç«¯
        emitters.forEach((id, emitter) -> {
            try {
                emitter.send(SseEmitter.event()
                    .data(payload)
                    .build());
            } catch (IOException e) {
                // ç§»é™¤å¤±æ•ˆçš„è¿æ¥
                emitters.remove(id);
            }
        });
    }
}
```

**SSEè®¢é˜…**:
```http
GET /api/sse/subscribe
```

**å‰ç«¯æ¥æ”¶**:
```javascript
const eventSource = new EventSource('http://localhost:8080/api/sse/subscribe');

eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('è®¾å¤‡æ•°æ®æ›´æ–°:', data);
  // æ›´æ–°UI
  updateDeviceData(data);
};
```

---

## ğŸ“¤ æ•°æ®ä¸ŠæŠ¥æµç¨‹

### æµç¨‹å›¾

```
DeviceDataEvent (è®¾å¤‡æ•°æ®äº‹ä»¶)
    â”‚
    â”‚ â‘  äº‹ä»¶å‘å¸ƒ
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataReportEventListener      â”‚
â”‚ @EventListener              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ â‘¡ åˆ¤æ–­è®¾å¤‡ç±»å‹
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataReportRouterService      â”‚
â”‚ - è·å–è®¾å¤‡ä¸ŠæŠ¥é…ç½®            â”‚
â”‚ - åˆ¤æ–­ä¸ŠæŠ¥åè®®                â”‚
â”‚ - è·¯ç”±åˆ°å…·ä½“ä¸ŠæŠ¥æœåŠ¡          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â–º SHANDONG (å±±ä¸œåè®®)
           â”‚   â””â”€â–º ShandongDataReportService
           â”‚       â”œâ”€â–º æ„å»ºHJ/T212æ•°æ®åŒ…
           â”‚       â”œâ”€â–º å»ºç«‹TCPè¿æ¥
           â”‚       â”œâ”€â–º å‘é€æ•°æ®
           â”‚       â””â”€â–º è®°å½•ä¸ŠæŠ¥æ—¥å¿—
           â”‚
           â””â”€â–º SICHUAN (å››å·åè®®)
               â””â”€â–º SichuanDataReportService
                   â”œâ”€â–º æ„å»ºJSONæ•°æ®
                   â”œâ”€â–º SM2åŠ å¯†
                   â”œâ”€â–º HTTP POST
                   â””â”€â–º è®°å½•ä¸ŠæŠ¥æ—¥å¿—
```

### è¯¦ç»†æ­¥éª¤

#### 1. äº‹ä»¶ç›‘å¬

**Listener**: [DataReportEventListener.java](../backend/src/main/java/com/cdutetc/ems/listener/DataReportEventListener.java)

```java
@Component
@RequiredArgsConstructor
@Slf4j
public class DataReportEventListener {

    private final DataReportRouterService routerService;

    @EventListener(classes = DeviceDataEvent.class)
    public void handleDeviceDataReceivedEvent(DeviceDataEvent event) {
        try {
            String eventType = event.getEventType();
            String deviceType = event.getDeviceType();

            // åªå¤„ç†è¾å°„è®¾å¤‡æ•°æ®
            if ("radiation-data".equals(eventType) &&
                "RADIATION_MONITOR".equals(deviceType)) {

                // å¼‚æ­¥ä¸ŠæŠ¥
                routerService.reportAsync(
                    event.getDeviceCode(),
                    event.getRadiationDeviceData()
                );
            }
        } catch (Exception e) {
            log.error("å¤„ç†æ•°æ®ä¸ŠæŠ¥äº‹ä»¶å¤±è´¥", e);
        }
    }
}
```

#### 2. è·¯ç”±æœåŠ¡

**Service**: [DataReportRouterService.java](../backend/src/main/java/com/cdutetc/ems/service/report/DataReportRouterService.java)

```java
@Service
@Slf4j
public class DataReportRouterService {

    @Async("reportExecutor")
    public void reportAsync(String deviceCode, RadiationDeviceData data) {
        // 1. è·å–è®¾å¤‡ä¸ŠæŠ¥é…ç½®ï¼ˆä»Redisç¼“å­˜ï¼‰
        DeviceReportConfig config = cacheService.getReportConfig(deviceCode);

        // 2. æ£€æŸ¥æ˜¯å¦å¯ç”¨ä¸ŠæŠ¥
        if (!config.getDataReportEnabled()) {
            log.debug("è®¾å¤‡æœªå¯ç”¨ä¸ŠæŠ¥: {}", deviceCode);
            return;
        }

        // 3. æ ¹æ®åè®®è·¯ç”±
        String protocol = config.getReportProtocol();
        switch (protocol) {
            case "SICHUAN":
                sichuanService.report(config, data);
                break;
            case "SHANDONG":
                shandongService.report(config, data);
                break;
            default:
                log.warn("æœªçŸ¥çš„ä¸ŠæŠ¥åè®®: {}", protocol);
        }

        // 4. è®°å½•ä¸ŠæŠ¥æ—¥å¿—
        saveReportLog(deviceCode, protocol, true, null, null, startTime);
    }
}
```

#### 3. å±±ä¸œåè®®ä¸ŠæŠ¥

**Service**: [ShandongDataReportService.java](../backend/src/main/java/com/cdutetc/ems/service/report/ShandongDataReportService.java)

```java
@Service
@Slf4j
public class ShandongDataReportService {

    @Async("reportExecutor")
    public void report(DeviceReportConfig config, RadiationDeviceData data) {
        Socket socket = null;
        try {
            // 1. æ„å»ºHJ/T212æ•°æ®åŒ…
            String packet = protocolService.buildRealtimeDataPacket(
                config.getDeviceCode(),
                properties.getShandong().getPassword(),
                buildHJT212Data(config, data)
            );

            // 2. å»ºç«‹TCPè¿æ¥
            socket = new Socket(
                properties.getShandong().getHost(),  // 221.214.62.118
                properties.getShandong().getPort()   // 20050
            );

            // 3. æ¥æ”¶å¹¶å¿½ç•¥æœåŠ¡å™¨åˆå§‹CMæ¶ˆæ¯
            socket.setSoTimeout(1000);
            byte[] initialBuffer = new byte[1024];
            int initialRead = socket.getInputStream().read(initialBuffer);

            if (initialRead > 0) {
                log.info("æ”¶åˆ°æœåŠ¡å™¨åˆå§‹æ¶ˆæ¯: {} å­—èŠ‚", initialRead);
            }

            // 4. å‘é€æ•°æ®
            PrintWriter out = new PrintWriter(socket.getOutputStream(), true);
            out.println(packet);
            out.flush();

            // 5. æ¥æ”¶åº”ç­”
            BufferedReader in = new BufferedReader(
                new InputStreamReader(socket.getInputStream())
            );
            String response = in.readLine();

            // 6. å¤„ç†åº”ç­”
            boolean success = protocolService.parseResponse(response);

            if (success) {
                log.info("å±±ä¸œåè®®ä¸ŠæŠ¥æˆåŠŸ: {}", config.getDeviceCode());
            } else {
                log.warn("å±±ä¸œåè®®ä¸ŠæŠ¥å¤±è´¥: {}", config.getDeviceCode());
            }

        } catch (Exception e) {
            log.error("å±±ä¸œåè®®ä¸ŠæŠ¥å¼‚å¸¸", e);
        } finally {
            if (socket != null) {
                socket.close();
            }
        }
    }
}
```

**HJ/T212æ•°æ®åŒ…æ ¼å¼**:
```
##0252QN=2025122923372088371;ST=61;CN=3051;PW=123456;CP=&&MN=865229085145869;Ma=002162;Rno=DE25IR006722;Xtype=02;LastAct=5.530E012;NowAct=3.270E012;SourceTime=2025-07-03;DataTime=20251229233720;Xvalue=18.0;BattChar=3.975;LONG=12102.1465;LAT=3740.5073;Sig=A&&0E89
```

**æ•°æ®åŒ…ç»“æ„**:
- `##` - åŒ…å¤´
- `0252` - æ•°æ®æ®µé•¿åº¦ (4ä½)
- `QN=...` - è¯·æ±‚ç¼–å·
- `ST=61` - ç³»ç»Ÿç±»å‹ (ç°åœºæœº)
- `CN=3051` - å‘½ä»¤ç¼–å· (å®æ—¶æ•°æ®ä¸ŠæŠ¥)
- `PW=123456` - è®¿é—®å¯†ç 
- `CP=&&...&&` - æ•°æ®å†…å®¹
- `0E89` - CRC16æ ¡éªŒç 
- `\r\n` - åŒ…å°¾

---

## âš ï¸ å‘Šè­¦å¤„ç†æµç¨‹

### æµç¨‹å›¾

```
è®¾å¤‡æ•°æ®æ¥æ”¶
    â”‚
    â”‚ â‘  æ•°æ®ä¿å­˜æˆåŠŸ
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AlertService                 â”‚
â”‚ - æ£€æŸ¥æ•°æ®æ˜¯å¦è¶…è¿‡é˜ˆå€¼        â”‚
â”‚ - åˆ¤æ–­å‘Šè­¦ç±»å‹                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”œâ”€â–º â‘¡ åˆ›å»ºå‘Šè­¦è®°å½•
           â”‚   â””â”€â–º ä¿å­˜åˆ°æ•°æ®åº“
           â”‚
           â””â”€â–º â‘¢ å‘å¸ƒå‘Šè­¦äº‹ä»¶
               â””â”€â–º SSEæ¨é€åˆ°å‰ç«¯
```

### è¯¦ç»†æ­¥éª¤

#### 1. å‘Šè­¦æ£€æŸ¥

**Service**: [AlertService.java](../backend/src/main/java/com/cdutetc/ems/service/AlertService.java)

```java
@Service
@Slf4j
public class AlertService {

    @EventListener
    public void checkRadiationData(DeviceDataEvent event) {
        RadiationDeviceData data = event.getRadiationDeviceData();

        // 1. è·å–è®¾å¤‡é˜ˆå€¼é…ç½®
        Device device = deviceRepository.findByDeviceCode(event.getDeviceCode())
            .orElse(null);

        if (device == null || device.getAlertThreshold() == null) {
            return;
        }

        // 2. æ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼
        Double threshold = device.getAlertThreshold();
        Double currentValue = data.getCpm();

        if (currentValue > threshold) {
            // 3. åˆ›å»ºå‘Šè­¦
            Alert alert = Alert.builder()
                .device(device)
                .alertType(AlertType.HIGH_CPM)
                .alertValue(currentValue)
                .threshold(threshold)
                .handled(false)
                .alertTime(LocalDateTime.now())
                .build();

            alertRepository.save(alert);

            // 4. æ¨é€å‘Šè­¦é€šçŸ¥
            sseEmitterService.sendAlertNotification(alert);
        }
    }
}
```

---

## ğŸ“Š ç¼“å­˜ç­–ç•¥

### Redisç¼“å­˜

#### 1. è®¾å¤‡çŠ¶æ€ç¼“å­˜

**Service**: [DeviceStatusCacheService.java](../backend/src/main/java/com/cdutetc/ems/service/DeviceStatusCacheService.java)

```java
@Service
@Slf4j
public class DeviceStatusCacheService {

    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    // ç¼“å­˜è®¾å¤‡CPMå€¼ (TTL: 5åˆ†é’Ÿ)
    public void updateDeviceCpm(String deviceCode, Double cpm) {
        String key = "device:cpm:" + deviceCode;
        redisTemplate.opsForValue().set(key, cpm, 5, TimeUnit.MINUTES);
    }

    // ç¼“å­˜è®¾å¤‡ç”µå‹å€¼ (TTL: 5åˆ†é’Ÿ)
    public void updateDeviceVoltage(String deviceCode, Double voltage) {
        String key = "device:voltage:" + deviceCode;
        redisTemplate.opsForValue().set(key, voltage, 5, TimeUnit.MINUTES);
    }

    // è·å–è®¾å¤‡çŠ¶æ€
    public Map<String, Object> getDeviceStatus(String deviceCode) {
        Map<String, Object> status = new HashMap<>();
        status.put("cpm", redisTemplate.opsForValue().get("device:cpm:" + deviceCode));
        status.put("voltage", redisTemplate.opsForValue().get("device:voltage:" + deviceCode));
        return status;
    }
}
```

#### 2. ä¸ŠæŠ¥é…ç½®ç¼“å­˜

**Service**: [DeviceReportConfigCacheService.java](../backend/src/main/java/com/cdutetc/ems/service/DeviceReportConfigCacheService.java)

```java
@Service
@Slf4j
public class DeviceReportConfigCacheService {

    @Autowired
    private RedisTemplate<String, DeviceReportConfig> redisTemplate;

    // ç¼“å­˜è®¾å¤‡ä¸ŠæŠ¥é…ç½® (TTL: 10åˆ†é’Ÿ)
    public DeviceReportConfig getReportConfig(String deviceCode) {
        String key = "device:report-config:" + deviceCode;

        // 1. å…ˆä»Redisè·å–
        DeviceReportConfig config = redisTemplate.opsForValue().get(key);

        if (config != null) {
            return config;
        }

        // 2. Redisæœªå‘½ä¸­ï¼Œä»æ•°æ®åº“åŠ è½½
        Device device = deviceRepository.findByDeviceCode(deviceCode)
            .orElseThrow(() -> new RuntimeException("è®¾å¤‡ä¸å­˜åœ¨"));

        config = DeviceReportConfig.builder()
            .deviceCode(device.getDeviceCode())
            .dataReportEnabled(device.getDataReportEnabled())
            .reportProtocol(device.getReportProtocol())
            .inspectionMachineNumber(device.getInspectionMachineNumber())
            .sourceNumber(device.getSourceNumber())
            .sourceType(device.getSourceType())
            .originalActivity(device.getOriginalActivity())
            .currentActivity(device.getCurrentActivity())
            .sourceProductionDate(device.getSourceProductionDate())
            .build();

        // 3. å†™å…¥Redisç¼“å­˜
        redisTemplate.opsForValue().set(key, config, 10, TimeUnit.MINUTES);

        return config;
    }
}
```

---

## ğŸ”„ å®Œæ•´æ•°æ®æµç¤ºä¾‹

### ç¤ºä¾‹ï¼šè¾å°„è®¾å¤‡æ•°æ®ä¸ŠæŠ¥

```
æ—¶é—´çº¿: 2025-12-30 00:00:00

â‘  [MQTT] è®¾å¤‡å‘é€æ•°æ®
   Topic: ems/device/865229085145869/data/RADIATION
   Payload: {"CPM":150,"Batvolt":3950,...}

â‘¡ [Listener] MqttMessageListeneræ¥æ”¶æ¶ˆæ¯
   â””â”€â–º è§£æè®¾å¤‡ç¼–ç : 865229085145869

â‘¢ [Service] RadiationDeviceDataServiceå¤„ç†æ•°æ®
   â”œâ”€â–º æ•°æ®éªŒè¯: âœ… é€šè¿‡
   â”œâ”€â–º CPMè½¬æ¢: 150 â†’ 15.0 (ç³»æ•°0.1)
   â”œâ”€â–º ç”µå‹è½¬æ¢: 3950mV â†’ 3.95V
   â”œâ”€â–º GPSé€‰æ‹©: BDS (useful=1)

â‘£ [Database] ä¿å­˜æ•°æ®
   INSERT INTO ems_radiation_device_data
   (device_id, cpm, batvolt, gps_longitude, gps_latitude, ...)
   VALUES (12, 15.0, 3.95, '12102.1465', '3740.5073', ...)

â‘¤ [Redis] æ›´æ–°ç¼“å­˜
   SET device:cpm:865229085145869 = 15.0 (EXPIRE 300s)
   SET device:voltage:865229085145869 = 3.95 (EXPIRE 300s)

â‘¥ [Event] å‘å¸ƒDeviceDataEvent
   eventType = "radiation-data"
   deviceCode = "865229085145869"
   deviceType = "RADIATION_MONITOR"

â‘¦ [SSE] SseEmitterServiceæ¨é€åˆ°å‰ç«¯
   event: message
   data: {"deviceCode":"865229085145869","cpm":15.0,...}

â‘§ [Report] DataReportEventListenerè§¦å‘ä¸ŠæŠ¥
   â”œâ”€â–º æ£€æŸ¥è®¾å¤‡é…ç½®: dataReportEnabled=true, reportProtocol=SHANDONG
   â”œâ”€â–º æ„å»ºHJ/T212æ•°æ®åŒ…
   â”œâ”€â–º è¿æ¥åˆ°å±±ä¸œæœåŠ¡å™¨: 221.214.62.118:20050
   â”œâ”€â–º å‘é€æ•°æ®åŒ…
   â”œâ”€â–º æ¥æ”¶å“åº”: 0x01 (æˆåŠŸ)
   â””â”€â–º è®°å½•ä¸ŠæŠ¥æ—¥å¿—åˆ° ems_data_report_log

â‘§ [Alert] AlertServiceæ£€æŸ¥å‘Šè­¦
   â”œâ”€â–º å½“å‰CPM: 15.0
   â”œâ”€â–º é˜ˆå€¼: 100.0
   â””â”€â–º æœªè¶…è¿‡é˜ˆå€¼ï¼Œä¸åˆ›å»ºå‘Šè­¦

æ€»è€—æ—¶: ~100ms
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥å¤„ç†

- **@Asyncæ³¨è§£**: æ•°æ®ä¸ŠæŠ¥ã€äº‹ä»¶ç›‘å¬ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œ
- **çº¿ç¨‹æ± é…ç½®**: `reportExecutor` (æ ¸å¿ƒ5çº¿ç¨‹, æœ€å¤§10çº¿ç¨‹)

### 2. ç¼“å­˜ç­–ç•¥

- **Redisç¼“å­˜**: è®¾å¤‡çŠ¶æ€ã€ä¸ŠæŠ¥é…ç½®ã€ç”¨æˆ·ä¼šè¯
- **TTLè®¾ç½®**: çŸ­æœŸç¼“å­˜ï¼ˆ5-10åˆ†é’Ÿï¼‰

### 3. æ‰¹é‡å¤„ç†

- **æ‰¹é‡æ¥å£**: `/api/device-data/radiation/batch`
- **æ‰¹é‡æ’å…¥**: JPA `saveAll()` æ–¹æ³•

---

## ğŸ§ª æ•°æ®æµæµ‹è¯•

### æµ‹è¯•è„šæœ¬ä½ç½®

è§ [tests/README.md](../tests/README.md)

### æµ‹è¯•æ­¥éª¤

1. **å¯åŠ¨æµ‹è¯•ç¯å¢ƒ**
   ```bash
   docker-compose up -d
   mvn spring-boot:run
   ```

2. **å‘é€MQTTæµ‹è¯•æ•°æ®**
   ```bash
   python3 tests/protocol/test_shandong_quick.py
   ```

3. **éªŒè¯æ•°æ®æµ**
   - æ£€æŸ¥MySQL: `SELECT * FROM ems_radiation_device_data ORDER BY id DESC LIMIT 1;`
   - æ£€æŸ¥Redis: `GET device:cpm:865229085145869`
   - æ£€æŸ¥æ—¥å¿—: `tail -f /tmp/ems-backend.log | grep "865229085145869"`

---

## ğŸ“ æ€»ç»“

### æ•°æ®æµç‰¹ç‚¹

1. **å®æ—¶æ€§**: MQTTä¿è¯æ•°æ®å®æ—¶æ¥æ”¶
2. **å¯é æ€§**: äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
3. **å¼‚æ­¥æ€§**: ä¸ŠæŠ¥æµç¨‹å¼‚æ­¥æ‰§è¡Œï¼Œä¸å½±å“ä¸»æµç¨‹
4. **å¯æ‰©å±•**: äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œæ˜“äºæ‰©å±•æ–°åŠŸèƒ½

### å…³é”®ç»„ä»¶

| ç»„ä»¶ | èŒè´£ | æŠ€æœ¯ |
|-----|------|------|
| MqttMessageListener | MQTTæ¶ˆæ¯æ¥æ”¶ | Eclipse Paho |
| RadiationDeviceDataService | æ•°æ®å¤„ç† | JPA + Transaction |
| DeviceDataEvent | äº‹ä»¶å‘å¸ƒ | Spring Event |
| SseEmitterService | å®æ—¶æ¨é€ | SSE |
| DataReportEventListener | ä¸ŠæŠ¥ç›‘å¬ | @EventListener |
| ShandongDataReportService | å±±ä¸œåè®®ä¸ŠæŠ¥ | TCP + HJ/T212 |
| DeviceStatusCacheService | ç¼“å­˜ç®¡ç† | Redis |

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0*
*æœ€åæ›´æ–°: 2025-12-30*
