# EMS系统架构设计文档

## 📋 文档信息

- **项目名称**: EMS (Energy Management System)
- **版本**: 1.0
- **更新日期**: 2025-12-30
- **文档类型**: 系统架构设计

---

## 🏗️ 系统概述

EMS是一个基于微服务架构的辐射环境监控系统，用于实时监控辐射设备和环境设备的数据，并支持向多个监管平台进行数据上报。

### 核心功能

1. **设备管理**: 辐射设备和环境设备的注册、配置、状态监控
2. **实时数据采集**: 通过MQTT和HTTP接收设备数据
3. **数据可视化**: SSE实时推送、图表展示、告警通知
4. **数据上报**: 支持四川协议（HTTP+SM2加密）和山东协议（TCP+HJ/T212）
5. **用户权限管理**: 基于角色的访问控制（ADMIN/USER）

---

## 🏛️ 技术架构

### 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        EMS 系统架构                          │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────┐      ┌──────────────┐                   │
│  │   Vue.js     │──────│   Nginx      │                   │
│  │   Frontend   │      │  (Optional)  │                   │
│  │   Port: 5173 │      │   Port: 80   │                   │
│  └──────────────┘      └──────────────┘                   │
│         │                                                   │
│         ▼                                                   │
│  ┌──────────────────────────────────────────────┐         │
│  │         Spring Boot Backend               │         │
│  │         Port: 8080 (Context: /api)        │         │
│  │  ┌────────────────────────────────────────┐ │         │
│  │  │  Controllers                          │ │         │
│  │  │  - AuthController                    │ │         │
│  │  │  - DeviceController                  │ │         │
│  │  │  - DeviceDataReceiverController       │ │         │
│  │  │  - AlertController                   │ │         │
│  │  │  - CompanyController                  │ │         │
│  │  │  - UserController                    │ │         │
│  │  │  - SseController (实时推送)           │ │         │
│  │  └────────────────────────────────────────┘ │         │
│  │  ┌────────────────────────────────────────┐ │         │
│  │  │  Services                            │ │         │
│  │  │  - DeviceService                     │ │         │
│  │  │  - RadiationDeviceDataService        │ │         │
│  │  │  - AlertService                       │ │         │
│  │  │  - SseEmitterService                  │ │         │
│  │  │  - DeviceReportConfigCacheService    │ │         │
│  │  │  - DataReportRouterService            │ │         │
│  │  │  - ShandongDataReportService          │ │         │
│  │  │  - SichuanDataReportService           │ │         │
│  │  └────────────────────────────────────────┘ │         │
│  │  ┌────────────────────────────────────────┐ │         │
│  │  │  Data Layer                          │ │         │
│  │  │  - JPA Entities                       │ │         │
│  │  │  - JpaRepository                     │ │         │
│  │  │  - Redis Cache                        │ │         │
│  │  └────────────────────────────────────────┘ │         │
│  └──────────────────────────────────────────────┘         │
│         │                                                   │
│         ▼                                                   │
│  ┌──────────────────────────────────────────────┐         │
│  │         Infrastructure                   │         │
│  │  ┌─────────┐ ┌──────────┐ ┌──────────┐    │         │
│  │  │  MySQL  │ │  Redis   │ │ MQTT     │    │         │
│  │  │ :3306   │ │ :6379    │ │ Mosquitto│    │         │
│  │  └─────────┘ └──────────┘ │ :1883    │    │         │
│  │                             └──────────┘    │         │
│  └──────────────────────────────────────────────┘         │
│                                                               │
│  ┌──────────────────────────────────────────────┐         │
│  │         External Services                  │         │
│  │  ┌──────────────┐  ┌──────────────┐        │         │
│  │  │ 四川监管平台  │  │ 山东监管平台  │        │         │
│  │  │ :18085       │  │ 221.214...   │        │         │
│  │  │ HTTP + SM2   │  │ :20050       │        │         │
│  │  └──────────────┘  │ TCP + HJ/T212│        │         │
│  │                    └──────────────┘        │         │
│  └──────────────────────────────────────────────┘         │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 🐳 Docker容器架构

### 当前运行的容器

| 容器名 | 镜像 | 端口 | 状态 | 说明 |
|-------|------|------|------|------|
| ems-mysql | mysql:8.0 | 3306 | ✅ 运行中 | MySQL数据库 |
| ems-redis | redis:latest | 6379 | ✅ 运行中 | Redis缓存 |
| ems-mosquitto | eclipse-mosquitto:latest | 1883, 9001 | ✅ 运行中 | MQTT消息代理 |
| ems-nodered | nodered/node-red:latest | 1880 | ✅ 运行中 | 设备模拟器 |

### 网络架构

```
┌──────────────────────────────────────────────────────┐
│            ems-network (172.22.0.0/16)              │
│                                                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────┐│
│  │ Mosquitto│  │Node-RED  │  │  MySQL   │  │Redis ││
│  │ :1883    │  │ :1880    │  │ :3306    │  │:6379 ││
│  └─────┬────┘  └─────┬────┘  └──────────┘  └──────┘│
│        │             │                             │
└────────┼─────────────┼─────────────────────────────┘
         │             │
         ▼             ▼
    ┌──────────────────────────┐
    │  Backend (本地运行)       │
    │  :8080                   │
    └──────────────────────────┘
```

**注意**: Spring Boot后端当前在本地运行（非Docker容器）

---

## 📦 后端模块结构

### 核心包结构

```
com.cdutetc.ems
├── config/              # 配置类
│   ├── SecurityConfig                    # Spring Security配置
│   ├── DataReportProperties             # 数据上报配置
│   ├── MqttConfig                        # MQTT配置
│   └── ...
├── controller/          # REST控制器
│   ├── AuthController                     # 认证接口
│   ├── DeviceController                   # 设备管理
│   ├── DeviceDataReceiverController        # 数据接收
│   ├── AlertController                    # 告警管理
│   ├── CompanyController                  # 公司管理
│   ├── UserController                     # 用户管理
│   ├── SseController                      # SSE实时推送
│   └── ...
├── service/            # 业务逻辑
│   ├── impl/
│   │   ├── CompanyServiceImpl
│   │   └── UserServiceImpl
│   ├── DeviceService                      # 设备业务
│   ├── RadiationDeviceDataService         # 辐射数据处理
│   ├── AlertService                        # 告警业务
│   ├── SseEmitterService                   # SSE推送服务
│   ├── DeviceStatusCacheService            # 设备状态缓存
│   ├── DeviceReportConfigCacheService      # 上报配置缓存
│   ├── report/
│   │   ├── DataReportRouterService        # 上报路由
│   │   ├── ShandongDataReportService      # 山东协议上报
│   │   └── SichuanDataReportService       # 四川协议上报
│   └── HJT212ProtocolService              # HJ/T212协议服务
├── repository/          # 数据访问层
│   ├── DeviceRepository
│   ├── RadiationDeviceDataRepository
│   ├── CompanyRepository
│   └── ...
├── entity/             # JPA实体
│   ├── Device                              # 设备实体
│   ├── RadiationDeviceData                # 辐射设备数据
│   ├── EnvironmentDeviceData              # 环境设备数据
│   ├── Company                             # 公司实体
│   ├── User                                # 用户实体
│   ├── Alert                               # 告警实体
│   ├── DataReportLog                      # 上报日志
│   └── ...
├── dto/                # 数据传输对象
│   ├── event/
│   │   └── DeviceDataEvent                # 设备数据事件
│   └── ...
├── listener/           # 事件监听器
│   └── DataReportEventListener             # 数据上报监听器
├── mqtt/               # MQTT集成
│   └── MqttMessageListener                 # MQTT消息监听器
├── security/           # 安全模块
│   ├── JwtTokenProvider                    # JWT工具
│   └── SecurityConfig                      # 安全配置
├── exception/         # 异常处理
│   └── GlobalExceptionHandler              # 全局异常处理
└── util/              # 工具类
    └── TestDataBuilder                     # 测试数据构建器
```

---

## 🎨 前端模块结构

### 目录结构

```
frontend/src/
├── api/                # API调用封装
├── assets/            # 静态资源
├── components/        # Vue组件
├── constants/         # 常量定义
├── router/            # 路由配置
├── store/             # Vuex状态管理
├── utils/             # 工具函数
├── views/             # 页面视图
│   ├── Dashboard.vue                    # 仪表板
│   ├── admin/                            # 管理员功能
│   ├── alerts/                          # 告警管理
│   ├── auth/                            # 认证页面
│   ├── companies/                       # 公司管理
│   ├── data/                            # 数据管理
│   ├── devices/                         # 设备管理
│   ├── users/                           # 用户管理
│   ├── video-devices/                   # 视频设备
│   └── visualization/                  # 数据可视化
├── App.vue            # 根组件
└── main.js            # 入口文件
```

---

## 🔄 数据流架构

### 1. 设备数据采集流程

```
┌─────────────┐
│  IoT设备     │
│ (辐射/环境)  │
└──────┬──────┘
       │
       │ MQTT/HTTP
       ▼
┌────────────────────────────────┐
│  MQTT Broker (Mosquitto)      │
│  Topic: ems/device/+/data/+   │
└──────┬─────────────────────────┘
       │
       │ 订阅
       ▼
┌────────────────────────────────┐
│  MqttMessageListener          │
│  - 接收MQTT消息                │
│  - 数据解析                    │
│  - 实时数据处理                │
└──────┬─────────────────────────┘
       │
       ▼
┌────────────────────────────────┐
│  RadiationDeviceDataService    │
│  - 数据验证                    │
│  - 数据转换                    │
│  - 保存到数据库                │
└──────┬─────────────────────────┘
       │
       ├──────────────────────┬─────────────────┐
       │                      │                 │
       ▼                      ▼                 ▼
┌──────────┐          ┌──────────┐    ┌──────────┐
│ MySQL DB │          │ Redis    │    │  Event   │
│ (持久化) │          │ (缓存)   │    │  System  │
└──────────┘          └──────────┘    └─────┬────┘
                                           │
                                           ▼
                              ┌─────────────────────┐
                              │ SseEmitterService   │
                              │ - SSE实时推送       │
                              └─────────────────────┘
```

### 2. 数据上报流程

```
┌─────────────────────┐
│ DeviceDataEvent     │  设备数据事件
│ (数据接收后发布)     │
└──────┬──────────────┘
       │
       │ @EventListener
       ▼
┌─────────────────────────────┐
│ DataReportEventListener    │
│ - 监听设备数据事件          │
│ - 判断设备类型              │
│ - 触发上报                  │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ DataReportRouterService    │
│ - 获取设备上报配置          │
│ - 判断上报协议              │
│ - 路由到具体上报服务        │
└──────┬──────────────────────┘
       │
       ├──────────────┬──────────────┐
       │              │              │
       ▼              ▼              ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│ Shandong │  │ Sichuan  │  │ 其他     │
│ Service  │  │ Service  │  │ 处理     │
└─────┬────┘  └─────┬────┘  └──────────┘
      │             │
      │ TCP + HJ/T212 │ HTTP + SM2
      ▼             ▼
┌──────────────┐ ┌──────────────┐
│ 山东监管平台  │ │ 四川监管平台  │
│ :20050       │ │ :18085       │
└──────────────┘ └──────────────┘
```

---

## 🔐 安全架构

### 认证与授权

```
┌──────────┐
│ 前端     │
│ Vue.js   │
└────┬─────┘
     │
     │ JWT Token
     ▼
┌─────────────────────┐
│ Spring Security     │
│ - JWT认证过滤器      │
│ - 权限验证           │
│ - CORS配置           │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│ Controller          │
│ - @PreAuthorize     │
│ - 角色检查           │
└─────────────────────┘
```

### 用户角色

| 角色 | 权限 | 说明 |
|-----|------|------|
| ADMIN | 所有权限 | 系统管理员 |
| USER | 有限权限 | 普通用户（仅查看所属公司数据） |

---

## 📊 数据库设计

### 核心表结构

| 表名 | 说明 | 主要字段 |
|-----|------|---------|
| ems_user | 用户表 | id, username, password, role, company_id |
| ems_company | 公司表 | id, name, address, contact |
| ems_device | 设备表 | id, device_code, device_type, status, data_report_enabled |
| ems_radiation_device_data | 辐射设备数据表 | id, device_id, cpm, batvolt, gps_longitude, gps_latitude |
| ems_environment_device_data | 环境设备数据表 | id, device_id, temperature, humidity |
| ems_alert | 告警表 | id, device_id, alert_type, alert_value, handled |
| ems_data_report_log | 上报日志表 | id, device_code, report_protocol, status, duration_ms |

---

## 🔧 配置管理

### 环境变量

| 变量名 | 说明 | 默认值 |
|-------|------|--------|
| EMS_SECURITY_JWT_SECRET | JWT密钥 | - |
| EMS_SECURITY_JWT_EXPIRATION | Token过期时间 | 86400000 |
| EMS_MQTT_HOST | MQTT服务器地址 | localhost |
| EMS_MQTT_PORT | MQTT端口 | 1883 |
| EMS_REPORT_SHANDONG_HOST | 山东服务器地址 | 221.214.62.118 |
| EMS_REPORT_SHANDONG_PORT | 山东服务器端口 | 20050 |
| EMS_REPORT_SICHUAN_URL | 四川服务器URL | http://59.225.208.12:18085 |

### 配置文件

- `backend/src/main/resources/application.yaml` - 主配置文件
- `docker-compose.yml` - Docker编排配置
- `mosquitto-config/config/mosquitto.conf` - MQTT Broker配置

---

## 🚀 部署架构

### 开发环境

```
本地开发机
├── Backend (Spring Boot)  :8080  [本地运行]
├── Frontend (Vue.js dev server) :5173  [本地运行]
└── Docker Containers
    ├── MySQL :3306
    ├── Redis :6379
    ├── Mosquitto :1883
    └── Node-RED :1880
```

### 生产环境（建议）

```
生产服务器
├── Nginx (反向代理) :80/443
│   ├── /api -> Backend:8080
│   └── / -> Frontend静态文件
├── Backend (Docker) :8080
├── Frontend (Docker/Nginx)
└── 基础设施容器
    ├── MySQL
    ├── Redis
    └── Mosquitto
```

---

## 📈 性能优化

### 缓存策略

1. **Redis缓存**:
   - 设备状态缓存
   - 上报配置缓存
   - 用户会话缓存

2. **连接池**:
   - HikariCP数据库连接池
   - Lettuce Redis连接池

### 异步处理

1. **@Async注解**:
   - 数据上报（异步线程池）
   - 事件监听（异步执行）

2. **消息队列** (未来):
   - MQTT消息队列
   - 上报任务队列

---

## 🧪 测试架构

### 测试类型

| 测试类型 | 工具 | 说明 |
|---------|------|------|
| 单元测试 | JUnit 5 | Service层测试 |
| 集成测试 | Spring Boot Test | API测试 |
| 协议测试 | Python脚本 | HJ/T212协议测试 |
| MQTT测试 | Mosquitto Pub/Sub | MQTT消息测试 |

### 测试脚本位置

```
tests/
├── protocol/          # 协议测试脚本
│   ├── test_final.py
│   ├── test_shandong_quick.py
│   └── ...
├── mqtt/             # MQTT测试脚本
│   ├── test_mqtt_sim_device.sh
│   └── ...
└── sql/              # SQL测试脚本
    └── create_shandong_test_device.sql
```

---

## 📝 总结

### 系统特点

1. **模块化设计**: 前后端分离，职责清晰
2. **双协议支持**: 四川协议和山东协议
3. **实时推送**: SSE实时数据推送
4. **灵活配置**: 支持按设备配置上报协议
5. **缓存优化**: Redis缓存提升性能

### 技术栈

- **前端**: Vue.js 3 + Vue Router + Vuex + Axios
- **后端**: Spring Boot 3.5 + Spring Security + JPA + MySQL
- **消息队列**: MQTT (Eclipse Paho)
- **缓存**: Redis
- **容器化**: Docker + Docker Compose

---

*文档版本: 1.0*
*最后更新: 2025-12-30*
