# åŒä¸ŠæŠ¥æ¨¡å¼ç»¼åˆè®¾è®¡æ–¹æ¡ˆ V2.0ï¼ˆç®€åŒ–ç‰ˆï¼‰

## ğŸ“‹ ä¸¤ç§ä¸ŠæŠ¥æ–¹å¼å¯¹æ¯”

### æ–¹å¼ä¸€ï¼šå››å·ä¸ŠæŠ¥ï¼ˆHTTP + SM2åŠ å¯†ï¼‰

**åŸºæœ¬ä¿¡æ¯**:
- **ä¸ŠæŠ¥åœ°å€**: `http://59.225.208.12:18085/access/data/report`
- **API Key**: `AK-9lKIK7RZrHxPsxq9eYzb2BWBCq8WeSwIPC2e`
- **åŠ å¯†æ–¹å¼**: SM2å›½å¯†åŠ å¯†
- **åè®®**: HTTP POST

**æ•°æ®æ ¼å¼**:
```json
{
  "deviceCode": "TEST10001",
  "paramType": "MIN",           // å›ºå®šä¸ºMINï¼ˆæ¯åˆ†é’Ÿç²’åº¦ï¼‰
  "dataType": "MIN",
  "timestamp": 1754387006225,
  "signature": "db93fe67cd...",
  "data": [{
    "dataTime": "2025-08-05 17:43:26",
    "dataStr": "{\"CODE\":\"abcd\",\"Nuclide\":\"Cs-137\",\"GPS\":1,\"Vbat\":\"3.7V\",\"LNG\":\"11700.5398\",\"LAT\":\"3637.2522\",\"FSY\":100.0}"
  }]
}
```

**ç‰¹ç‚¹**:
- âœ… SM2å›½å¯†åŠ å¯†
- âœ… å›ºå®šMINç²’åº¦ï¼ˆæ¯åˆ†é’Ÿï¼‰
- âœ… JSONæ ¼å¼çµæ´»

### æ–¹å¼äºŒï¼šå±±ä¸œä¸ŠæŠ¥ï¼ˆTCPåè®® + è‡ªå®šä¹‰æ ¼å¼ï¼‰

**åŸºæœ¬ä¿¡æ¯**:
- **åè®®**: TCP
- **å¹³å°åœ°å€**: `117.73.252.128:8091`
- **å‚è€ƒæ ‡å‡†**: HJ/T212-2005
- **ç¼–ç **: ASCIIç 

**é€šè®¯åŒ…æ ¼å¼**:
```
##æ•°æ®æ®µé•¿åº¦CRCæ ¡éªŒ<CR><LF>
```

**æ•°æ®æ®µç»“æ„** (3051å®æ—¶æ•°æ®ä¸ŠæŠ¥):
```
QN=20101201010101001;ST=61;CN=3051;PW=123456;CP=&&MN=01010101010101;Ma=000001;Rno=010101010101;Xtype=01;LastAct=2.700E004;NowAct=1.300E004;SourceTime=20120101;DataTime=20101201010501;LONG=11225.1333;LAT=3705.4300;Xvalue=1000000.000;Thres=100000.000;AlertType=01;BattChar=1000.0;Sig=1;&&
```

**å…³é”®å‘½ä»¤**:
- **3051**: å®æ—¶æ•°æ®ä¸ŠæŠ¥ï¼ˆæŠ¥è­¦/æ•…éšœæ—¶10~20ç§’1æ¡ï¼Œæ­£å¸¸5åˆ†é’Ÿ1æ¡ï¼‰
- **3052**: GPRSæ–­å¼€æ—¶æ•°æ®è¡¥ä¼ 

**ç‰¹ç‚¹**:
- âœ… æ ‡å‡†è¡Œä¸šåè®®ï¼ˆHJ/T212-2005ï¼‰
- âœ… æ”¯æŒå®æ—¶ä¸ŠæŠ¥å’Œè¡¥ä¼ 
- âœ… TCPé•¿è¿æ¥
- âœ… ASCIIç¼–ç 

---

## ğŸ¯ ç®€åŒ–è®¾è®¡ç†å¿µ

### æ ¸å¿ƒç­–ç•¥ï¼š**æœ‰æ–°æ•°æ®å°±ä¸ŠæŠ¥**

- âŒ **ä¸ä½¿ç”¨**ï¼šå®šæ—¶è°ƒåº¦ã€æ•°æ®ç²’åº¦é€‰æ‹©ã€æ•°æ®èšåˆ
- âœ… **é‡‡ç”¨**ï¼šäº‹ä»¶é©±åŠ¨ã€å®æ—¶ä¸ŠæŠ¥
- ğŸ“Š **è§¦å‘æ—¶æœº**ï¼šè®¾å¤‡MQTTæ•°æ®æ¥æ”¶æ—¶ç«‹å³è§¦å‘ä¸ŠæŠ¥

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ‰©å±•Deviceè¡¨ï¼ˆæ¨èï¼‰

```sql
-- æ·»åŠ ä¸ŠæŠ¥é…ç½®å­—æ®µåˆ°ems_deviceè¡¨
ALTER TABLE ems_device
ADD COLUMN data_report_enabled BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å¯ç”¨æ•°æ®ä¸ŠæŠ¥',
ADD COLUMN report_protocol VARCHAR(20) DEFAULT 'SICHUAN' COMMENT 'ä¸ŠæŠ¥åè®®: SICHUAN/SHANDONG',
ADD COLUMN gps_priority VARCHAR(20) DEFAULT 'BDS' COMMENT 'GPSä¼˜å…ˆçº§: BDS/LBS/BDS_THEN_LBS',
ADD COLUMN last_report_time DATETIME COMMENT 'æœ€åä¸ŠæŠ¥æ—¶é—´',
ADD COLUMN last_report_status VARCHAR(20) COMMENT 'æœ€åä¸ŠæŠ¥çŠ¶æ€: SUCCESS/FAILED',
ADD COLUMN last_report_error TEXT COMMENT 'æœ€åä¸ŠæŠ¥é”™è¯¯ä¿¡æ¯',
ADD COLUMN total_report_count INT DEFAULT 0 COMMENT 'æ€»ä¸ŠæŠ¥æ¬¡æ•°',
ADD COLUMN success_report_count INT DEFAULT 0 COMMENT 'æˆåŠŸä¸ŠæŠ¥æ¬¡æ•°';
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| data_report_enabled | BOOLEAN | FALSE | æ˜¯å¦å¯ç”¨æ•°æ®ä¸ŠæŠ¥ |
| report_protocol | VARCHAR(20) | SICHUAN | ä¸ŠæŠ¥åè®®ï¼šSICHUAN/SHANDONG |
| gps_priority | VARCHAR(20) | BDS | GPSä¼˜å…ˆçº§ |
| last_report_time | DATETIME | - | æœ€åä¸ŠæŠ¥æ—¶é—´ |
| last_report_status | VARCHAR(20) | - | æœ€åä¸ŠæŠ¥çŠ¶æ€ |
| last_report_error | TEXT | - | æœ€åä¸ŠæŠ¥é”™è¯¯ä¿¡æ¯ |
| total_report_count | INT | 0 | æ€»ä¸ŠæŠ¥æ¬¡æ•° |
| success_report_count | INT | 0 | æˆåŠŸä¸ŠæŠ¥æ¬¡æ•° |

### ä¸ŠæŠ¥æ—¥å¿—è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºè¯¦ç»†æ—¥å¿—è¿½è¸ªï¼‰

```sql
CREATE TABLE ems_data_report_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    device_code VARCHAR(50) NOT NULL COMMENT 'è®¾å¤‡ç¼–å·',
    report_protocol VARCHAR(20) NOT NULL COMMENT 'ä¸ŠæŠ¥åè®®',
    report_time DATETIME NOT NULL COMMENT 'ä¸ŠæŠ¥æ—¶é—´',

    -- è¯·æ±‚ä¿¡æ¯
    request_payload TEXT COMMENT 'è¯·æ±‚å†…å®¹',
    response_body TEXT COMMENT 'å“åº”å†…å®¹',

    -- çŠ¶æ€ä¿¡æ¯
    status VARCHAR(20) NOT NULL COMMENT 'çŠ¶æ€: SUCCESS/FAILED',
    http_status INT COMMENT 'HTTPçŠ¶æ€ç ',
    error_message TEXT COMMENT 'é”™è¯¯ä¿¡æ¯',

    -- æ€§èƒ½æŒ‡æ ‡
    duration_ms BIGINT COMMENT 'è€—æ—¶(æ¯«ç§’)',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_device_time (device_code, report_time),
    INDEX idx_status (status)
) COMMENT='æ•°æ®ä¸ŠæŠ¥æ—¥å¿—è¡¨';
```

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EMS åç«¯ç³»ç»Ÿ                            â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚            MQTT Message Listener                      â”‚    â”‚
â”‚  â”‚  (æ¥æ”¶è®¾å¤‡æ•°æ®)                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           æ•°æ®å¤„ç† + å­˜å‚¨åˆ°æ•°æ®åº“                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                      â”‚                                       â”‚
â”‚                      â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         äº‹ä»¶å‘å¸ƒï¼šDeviceDataReceivedEvent             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                      â”‚                                       â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚        â”‚                            â”‚                    â”‚
â”‚        â–¼                            â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ SSEæ¨é€       â”‚        â”‚ ä¸ŠæŠ¥ç›‘å¬å™¨    â”‚            â”‚
â”‚  â”‚ (å‰ç«¯å®æ—¶æ˜¾ç¤º) â”‚        â”‚ (è§¦å‘ä¸ŠæŠ¥)     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                     â”‚                     â”‚
â”‚                                     â–¼                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                    â”‚ æŸ¥è¯¢è®¾å¤‡ä¸ŠæŠ¥é…ç½®      â”‚               â”‚
â”‚                    â”‚ dataReportEnabled?    â”‚               â”‚
â”‚                    â”‚ reportProtocol?       â”‚               â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                â”‚                            â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                   â”‚                         â”‚               â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚           â”‚ å››å·ä¸ŠæŠ¥æœåŠ¡    â”‚    â”‚ å±±ä¸œä¸ŠæŠ¥æœåŠ¡      â”‚          â”‚
â”‚           â”‚ SichuanService â”‚    â”‚ ShandongService  â”‚          â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â”‚                         â”‚                   â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚           â”‚ HTTP POST      â”‚    â”‚ TCP Socket       â”‚          â”‚
â”‚           â”‚ + SM2åŠ å¯†      â”‚    â”‚ + HJ/T212åè®®    â”‚          â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                   â”‚                         â”‚                   â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                â”‚                             â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚                   â”‚     è®°å½•ä¸ŠæŠ¥æ—¥å¿—        â”‚                   â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                              â”‚
                    â–¼                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  å››å·ç›‘ç®¡å¹³å°    â”‚          â”‚  å±±ä¸œç›‘ç®¡å¹³å°    â”‚
        â”‚  59.225.208.12   â”‚          â”‚ 117.73.252.128  â”‚
        â”‚     :18085       â”‚          â”‚     :8091        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 1. ä¸ŠæŠ¥äº‹ä»¶ç›‘å¬å™¨

**æ–‡ä»¶**: `backend/src/main/java/com/cdutetc/ems/listener/DataReportEventListener.java`

**åŠŸèƒ½**: ç›‘å¬è®¾å¤‡æ•°æ®æ¥æ”¶äº‹ä»¶ï¼Œè§¦å‘ä¸ŠæŠ¥

```java
@Component
@RequiredArgsConstructor
public class DataReportEventListener {

    private final DataReportRouterService routerService;

    @EventListener
    public void handleDeviceDataReceived(DeviceDataReceivedEvent event) {
        try {
            // å¼‚æ­¥ä¸ŠæŠ¥ï¼Œä¸é˜»å¡ä¸»æµç¨‹
            routerService.reportAsync(event.getDeviceCode(), event.getData());
        } catch (Exception e) {
            log.error("æ•°æ®ä¸ŠæŠ¥å¤±è´¥: deviceCode={}", event.getDeviceCode(), e);
        }
    }
}
```

### 2. åè®®è·¯ç”±æœåŠ¡

**æ–‡ä»¶**: `backend/src/main/java/com/cdutetc/ems/service/report/DataReportRouterService.java`

**åŠŸèƒ½**: æ ¹æ®è®¾å¤‡é…ç½®é€‰æ‹©ä¸ŠæŠ¥åè®®

```java
@Service
@RequiredArgsConstructor
public class DataReportRouterService {

    private final SichuanDataReportService sichuanService;
    private final ShandongDataReportService shandongService;
    private final DeviceService deviceService;

    @Async("reportExecutor")
    public void reportAsync(String deviceCode, Object data) {
        Device device = deviceService.findByDeviceCode(deviceCode);

        // æ£€æŸ¥æ˜¯å¦å¯ç”¨ä¸ŠæŠ¥
        if (!device.isDataReportEnabled()) {
            log.debug("è®¾å¤‡æœªå¯ç”¨ä¸ŠæŠ¥: {}", deviceCode);
            return;
        }

        try {
            switch (device.getReportProtocol()) {
                case "SICHUAN":
                    sichuanService.report(device, data);
                    break;

                case "SHANDONG":
                    shandongService.report(device, data);
                    break;

                default:
                    log.warn("æœªçŸ¥çš„ä¸ŠæŠ¥åè®®: {}", device.getReportProtocol());
            }
        } catch (Exception e) {
            log.error("æ•°æ®ä¸ŠæŠ¥å¼‚å¸¸: deviceCode={}", deviceCode, e);
            updateDeviceReportStatus(device, "FAILED", e.getMessage());
        }
    }

    // åŒæ­¥ä¸ŠæŠ¥ï¼ˆç”¨äºæµ‹è¯•ï¼‰
    public ReportResult reportSync(String deviceCode, Object data) {
        // åŒæ­¥å®ç°
    }
}
```

### 3. å››å·ä¸ŠæŠ¥æœåŠ¡

**æ–‡ä»¶**: `backend/src/main/java/com/cdutetc/ems/service/report/SichuanDataReportService.java`

**åŠŸèƒ½**: HTTP POST + SM2åŠ å¯†

```java
@Service
@RequiredArgsConstructor
public class SichuanDataReportService {

    private final Sm2EncryptionService sm2EncryptionService;
    private final RestTemplate restTemplate;

    @Value("${app.data-report.sichuan.url}")
    private String reportUrl;

    @Value("${app.data-report.sichuan.api-key}")
    private String apiKey;

    public void report(Device device, RadiationDeviceData data) {
        try {
            // 1. æ„å»ºpayload
            SichuanReportPayload payload = buildPayload(device, data);

            // 2. SM2åŠ å¯†æ•´ä¸ªJSON
            String encryptedPayload = sm2EncryptionService.encrypt(
                objectMapper.writeValueAsString(payload)
            );

            // 3. HTTP POST
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);

            HttpEntity<String> request = new HttpEntity<>(encryptedPayload, headers);
            ResponseEntity<String> response = restTemplate.postForEntity(
                reportUrl + "?apiKey=" + apiKey,
                request,
                String.class
            );

            // 4. è®°å½•ç»“æœ
            if (response.getStatusCode().is2xxSuccessful()) {
                updateDeviceReportStatus(device, "SUCCESS", null);
                log.info("å››å·ä¸ŠæŠ¥æˆåŠŸ: deviceCode={}", device.getDeviceCode());
            } else {
                updateDeviceReportStatus(device, "FAILED",
                    "HTTP " + response.getStatusCode());
            }

        } catch (Exception e) {
            updateDeviceReportStatus(device, "FAILED", e.getMessage());
            throw e;
        }
    }

    private SichuanReportPayload buildPayload(Device device, RadiationDeviceData data) {
        // æ„å»ºdataStr
        Map<String, Object> dataStr = new HashMap<>();
        dataStr.put("CODE", device.getDeviceCode());
        dataStr.put("Nuclide", device.getDescription() != null ? device.getDescription() : "Cs-137");
        dataStr.put("GPS", isGpsAvailable(data) ? 1 : 0);
        dataStr.put("Vbat", String.format("%.1fV", data.getBatvolt()));
        dataStr.put("LNG", formatLongitude(data));
        dataStr.put("LAT", formatLatitude(data));
        dataStr.put("FSY", data.getCpm());

        // æ„å»ºdataæ•°ç»„
        Map<String, String> dataItem = new HashMap<>();
        dataItem.put("dataTime", formatDateTime(data.getRecordTime()));
        dataItem.put("dataStr", objectMapper.writeValueAsString(dataStr));

        // æ„å»ºå®Œæ•´payload
        SichuanReportPayload payload = new SichuanReportPayload();
        payload.setDeviceCode(device.getDeviceCode());
        payload.setParamType("MIN");  // å›ºå®šMIN
        payload.setDataType("MIN");
        payload.setTimestamp(System.currentTimeMillis());
        payload.setData(List.of(dataItem));

        // ç”Ÿæˆç­¾å
        payload.setSignature(generateSignature(payload));

        return payload;
    }
}
```

### 4. å±±ä¸œä¸ŠæŠ¥æœåŠ¡

**æ–‡ä»¶**: `backend/src/main/java/com/cdutetc/ems/service/report/ShandongDataReportService.java`

**åŠŸèƒ½**: TCP + HJ/T212åè®®

```java
@Service
@RequiredArgsConstructor
public class ShandongDataReportService {

    private final HJT212ProtocolService hjt212Service;
    private final ShandongTcpConnectionManager tcpManager;

    @Value("${app.data-report.shandong.host}")
    private String host;

    @Value("${app.data-report.shandong.port}")
    private int port;

    @PostConstruct
    public void init() {
        // åˆå§‹åŒ–TCPè¿æ¥
        tcpManager.connect(host, port);
    }

    public void report(Device device, RadiationDeviceData data) {
        try {
            // 1. æ„å»ºHJ/T212åè®®åŒ…
            String packet = hjt212Service.build3051Packet(device, data);

            // 2. å‘é€TCPåŒ…
            tcpManager.send(packet);

            // 3. ç­‰å¾…åº”ç­”ï¼ˆå¯é€‰ï¼Œè¶…æ—¶5ç§’ï¼‰
            String response = tcpManager.receive(5000);

            // 4. è®°å½•ç»“æœ
            if (response != null && response.contains("CN=3051")) {
                updateDeviceReportStatus(device, "SUCCESS", null);
                log.info("å±±ä¸œä¸ŠæŠ¥æˆåŠŸ: deviceCode={}", device.getDeviceCode());
            } else {
                updateDeviceReportStatus(device, "FAILED", "æ— åº”ç­”æˆ–åº”ç­”æ ¼å¼é”™è¯¯");
            }

        } catch (Exception e) {
            updateDeviceReportStatus(device, "FAILED", e.getMessage());
            throw e;
        }
    }
}
```

### 5. é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `backend/src/main/resources/application.yaml`

```yaml
app:
  data-report:
    # å››å·ä¸ŠæŠ¥é…ç½®
    sichuan:
      url: http://59.225.208.12:18085/access/data/report
      api-key: AK-9lKIK7RZrHxPsxq9eYzb2BWBCq8WeSwIPC2e
      enabled: true

    # å±±ä¸œä¸ŠæŠ¥é…ç½®
    shandong:
      host: 117.73.252.128
      port: 8091
      enabled: true
      password: 123456  # è®¿é—®å¯†ç 

    # å¼‚æ­¥ä¸ŠæŠ¥çº¿ç¨‹æ± é…ç½®
    async:
      core-pool-size: 5
      max-pool-size: 10
      queue-capacity: 100
```

---

## ğŸ¨ å‰ç«¯é…ç½®ç•Œé¢

### è®¾å¤‡è¡¨å•æ‰©å±•

**æ–‡ä»¶**: `frontend/src/views/devices/DeviceForm.vue`

```vue
<el-card class="report-config" v-if="formData.deviceType === 'RADIATION'">
  <template #header>
    <span>æ•°æ®ä¸ŠæŠ¥é…ç½®</span>
  </template>

  <el-form-item label="å¯ç”¨ä¸ŠæŠ¥">
    <el-switch
      v-model="formData.dataReportEnabled"
      active-text="å·²å¯ç”¨"
      inactive-text="æœªå¯ç”¨"
    />
    <span class="ml-2 text-gray-500 text-sm">
      å¯ç”¨åï¼Œè®¾å¤‡æ•°æ®å°†è‡ªåŠ¨ä¸ŠæŠ¥åˆ°ç›‘ç®¡å¹³å°
    </span>
  </el-form-item>

  <template v-if="formData.dataReportEnabled">
    <el-form-item label="ä¸ŠæŠ¥åè®®" required>
      <el-radio-group v-model="formData.reportProtocol">
        <el-radio value="SICHUAN">
          <div class="radio-content">
            <div class="radio-title">å››å·åè®®</div>
            <div class="radio-desc">HTTP + SM2åŠ å¯†ï¼Œå®æ—¶ä¸ŠæŠ¥</div>
          </div>
        </el-radio>
        <el-radio value="SHANDONG">
          <div class="radio-content">
            <div class="radio-title">å±±ä¸œåè®®</div>
            <div class="radio-desc">TCP + HJ/T212-2005ï¼Œæ ‡å‡†è¡Œä¸šåè®®</div>
          </div>
        </el-radio>
      </el-radio-group>
    </el-form-item>

    <el-form-item label="GPSä¼˜å…ˆçº§">
      <el-select v-model="formData.gpsPriority" placeholder="é€‰æ‹©GPSä¼˜å…ˆçº§">
        <el-option value="BDS" label="åŒ—æ–—ä¼˜å…ˆ" />
        <el-option value="LBS" label="åŸºç«™ä¼˜å…ˆ" />
        <el-option value="BDS_THEN_LBS" label="åŒ—æ–—ç„¶ååŸºç«™" />
      </el-select>
    </el-form-item>

    <!-- çŠ¶æ€æ˜¾ç¤º -->
    <el-form-item label="ä¸ŠæŠ¥ç»Ÿè®¡">
      <div v-if="formData.totalReportCount > 0" class="report-stats">
        <el-row :gutter="20">
          <el-col :span="8">
            <el-statistic title="æ€»ä¸ŠæŠ¥æ¬¡æ•°" :value="formData.totalReportCount" />
          </el-col>
          <el-col :span="8">
            <el-statistic title="æˆåŠŸæ¬¡æ•°" :value="formData.successReportCount" />
          </el-col>
          <el-col :span="8">
            <el-statistic
              title="æˆåŠŸç‡"
              :value="successRate"
              suffix="%"
              :precision="1"
            />
          </el-col>
        </el-row>
      </div>
      <div v-else class="text-gray-500">æš‚æ— ä¸ŠæŠ¥è®°å½•</div>
    </el-form-item>

    <el-form-item label="æœ€åä¸ŠæŠ¥">
      <div v-if="formData.lastReportTime">
        <span>{{ formData.lastReportTime }}</span>
        <el-tag
          :type="formData.lastReportStatus === 'SUCCESS' ? 'success' : 'danger'"
          class="ml-2"
        >
          {{ formData.lastReportStatus === 'SUCCESS' ? 'æˆåŠŸ' : 'å¤±è´¥' }}
        </el-tag>
      </div>
      <div v-else class="text-gray-500">æš‚æ— ä¸ŠæŠ¥è®°å½•</div>
    </el-form-item>

    <el-form-item v-if="formData.lastReportError" label="é”™è¯¯ä¿¡æ¯">
      <el-alert
        :title="formData.lastReportError"
        type="error"
        :closable="false"
        show-icon
      />
    </el-form-item>

    <!-- æ“ä½œæŒ‰é’® -->
    <el-form-item>
      <el-button
        type="primary"
        @click="testReport"
        :loading="testing"
      >
        æµ‹è¯•ä¸ŠæŠ¥
      </el-button>
      <el-button @click="viewLogs">æŸ¥çœ‹æ—¥å¿—</el-button>
    </el-form-item>
  </template>
</el-card>
```

---

## ğŸ“Š æ•°æ®ä¸ŠæŠ¥æµç¨‹

### å®æ—¶ä¸ŠæŠ¥æµç¨‹

```
1. è®¾å¤‡é€šè¿‡MQTTå‘é€æ•°æ®
   â†“
2. MqttMessageListeneræ¥æ”¶å¹¶ä¿å­˜æ•°æ®
   â†“
3. å‘å¸ƒDeviceDataReceivedEventäº‹ä»¶
   â†“
4. DataReportEventListenerç›‘å¬åˆ°äº‹ä»¶
   â†“
5. æŸ¥è¯¢è®¾å¤‡ä¸ŠæŠ¥é…ç½®
   â†“
6a. å¦‚æœåè®®=SICHUAN
    â”œâ”€ æ„å»ºJSON payload
    â”œâ”€ SM2åŠ å¯†
    â”œâ”€ HTTP POSTåˆ°å››å·å¹³å°
    â””â”€ è®°å½•æ—¥å¿—
   â”‚
   â†“
6b. å¦‚æœåè®®=SHANDONG
    â”œâ”€ æ„å»ºHJ/T212åè®®åŒ…
    â”œâ”€ TCPå‘é€
    â”œâ”€ æ¥æ”¶åº”ç­”
    â””â”€ è®°å½•æ—¥å¿—
   â†“
7. æ›´æ–°è®¾å¤‡ä¸ŠæŠ¥çŠ¶æ€
```

---

## ğŸ›ï¸ é…ç½®ç¤ºä¾‹

### ç¤ºä¾‹1: è®¾å¤‡ä½¿ç”¨å››å·åè®®

```json
{
  "deviceCode": "GM5-A001",
  "deviceName": "è¾å°„ç›‘æµ‹è®¾å¤‡A",
  "deviceType": "RADIATION",
  "dataReportEnabled": true,
  "reportProtocol": "SICHUAN",
  "gpsPriority": "BDS"
}
```

### ç¤ºä¾‹2: è®¾å¤‡ä½¿ç”¨å±±ä¸œåè®®

```json
{
  "deviceCode": "GM5-B001",
  "deviceName": "è¾å°„ç›‘æµ‹è®¾å¤‡B",
  "deviceType": "RADIATION",
  "dataReportEnabled": true,
  "reportProtocol": "SHANDONG",
  "gpsPriority": "BDS_THEN_LBS"
}
```

### ç¤ºä¾‹3: è®¾å¤‡ä¸ä¸ŠæŠ¥

```json
{
  "deviceCode": "GM5-C001",
  "deviceName": "è¾å°„ç›‘æµ‹è®¾å¤‡C",
  "deviceType": "RADIATION",
  "dataReportEnabled": false
}
```

---

## ğŸ› ï¸ æ ¸å¿ƒæœåŠ¡æ¸…å•

### å¿…é¡»å®ç°çš„æœåŠ¡

1. **DataReportRouterService** - åè®®è·¯ç”±å™¨
2. **SichuanDataReportService** - å››å·ä¸ŠæŠ¥æœåŠ¡
3. **ShandongDataReportService** - å±±ä¸œä¸ŠæŠ¥æœåŠ¡
4. **Sm2EncryptionService** - SM2åŠ å¯†æœåŠ¡
5. **HJT212ProtocolService** - HJ/T212åè®®ç¼–è§£ç æœåŠ¡
6. **ShandongTcpConnectionManager** - TCPè¿æ¥ç®¡ç†å™¨
7. **DataReportEventListener** - ä¸ŠæŠ¥äº‹ä»¶ç›‘å¬å™¨

### DTOç±»

1. **SichuanReportPayload** - å››å·ä¸ŠæŠ¥payload
2. **ReportResult** - ä¸ŠæŠ¥ç»“æœ
3. **DataReportConfigRequest** - é…ç½®æ›´æ–°è¯·æ±‚

### é…ç½®ç±»

1. **DataReportProperties** - ä¸ŠæŠ¥é…ç½®å±æ€§
2. **AsyncReportConfig** - å¼‚æ­¥çº¿ç¨‹æ± é…ç½®

---

## ğŸ“ å®æ–½æ­¥éª¤

### é˜¶æ®µä¸€ï¼šåŸºç¡€æ¶æ„ï¼ˆç¬¬1å¤©ï¼‰
- âœ… æ‰©å±•Deviceè¡¨ï¼ˆ7ä¸ªå­—æ®µï¼‰
- âœ… æ·»åŠ ä¾èµ–ï¼ˆSM2ã€TCPã€å¼‚æ­¥ï¼‰
- âœ… åˆ›å»ºé…ç½®ç±»

### é˜¶æ®µäºŒï¼šå››å·åè®®ï¼ˆç¬¬2-3å¤©ï¼‰
- âœ… å®ç°SM2åŠ å¯†æœåŠ¡
- âœ… å®ç°SichuanDataReportService
- âœ… å•å…ƒæµ‹è¯•

### é˜¶æ®µä¸‰ï¼šå±±ä¸œåè®®ï¼ˆç¬¬4-5å¤©ï¼‰
- âœ… å®ç°TCPè¿æ¥ç®¡ç†å™¨
- âœ… å®ç°HJ/T212åè®®ç¼–è§£ç 
- âœ… å®ç°ShandongDataReportService
- âœ… å•å…ƒæµ‹è¯•

### é˜¶æ®µå››ï¼šé›†æˆå’Œç®¡ç†ï¼ˆç¬¬6å¤©ï¼‰
- âœ… å®ç°DataReportRouterService
- âœ… å®ç°DataReportEventListener
- âœ… å‰ç«¯é…ç½®ç•Œé¢
- âœ… APIæ¥å£

### é˜¶æ®µäº”ï¼šæµ‹è¯•ï¼ˆç¬¬7å¤©ï¼‰
- âœ… é›†æˆæµ‹è¯•
- âœ… ç«¯åˆ°ç«¯æµ‹è¯•
- âœ… æ€§èƒ½ä¼˜åŒ–

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¼‚æ­¥å¤„ç†
- ä¸ŠæŠ¥ä¸èƒ½é˜»å¡ä¸»æµç¨‹
- ä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹æ± 
- å¼‚å¸¸ä¸èƒ½å½±å“æ•°æ®æ¥æ”¶

### 2. é”™è¯¯å¤„ç†
- ä¸ŠæŠ¥å¤±è´¥ä¸å½±å“æ•°æ®å­˜å‚¨
- è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
- è‡ªåŠ¨é‡è¿ï¼ˆå±±ä¸œTCPï¼‰

### 3. æ€§èƒ½è€ƒè™‘
- æ‰¹é‡ä¸ŠæŠ¥ï¼ˆå¦‚æœè®¾å¤‡å¾ˆé¢‘ç¹ï¼‰
- è¿æ¥æ± å¤ç”¨
- å¼‚æ­¥éé˜»å¡

### 4. é…ç½®ç®¡ç†
- æ”¯æŒçƒ­æ›´æ–°ï¼ˆåŠ¨æ€å¯ç”¨/ç¦ç”¨ï¼‰
- åè®®åˆ‡æ¢éœ€è°¨æ…

---

## âœ… éªŒæ”¶æ ‡å‡†

1. âœ… æ”¯æŒå››å·å’Œå±±ä¸œä¸¤ç§åè®®
2. âœ… è®¾å¤‡æ¥æ”¶æ•°æ®åè‡ªåŠ¨è§¦å‘ä¸ŠæŠ¥
3. âœ… è®¾å¤‡çº§é…ç½®å¼€å…³
4. âœ… å‰ç«¯é…ç½®ç•Œé¢
5. âœ… æŸ¥çœ‹ä¸ŠæŠ¥çŠ¶æ€å’Œæ—¥å¿—
6. âœ… æµ‹è¯•ä¸ŠæŠ¥åŠŸèƒ½
7. âœ… ä¸ŠæŠ¥å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
8. âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
