# åŒä¸ŠæŠ¥æ¨¡å¼ç»¼åˆè®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ ä¸¤ç§ä¸ŠæŠ¥æ–¹å¼å¯¹æ¯”

### æ–¹å¼ä¸€ï¼šå››å·ä¸ŠæŠ¥ï¼ˆHTTP + SM2åŠ å¯†ï¼‰

**åŸºæœ¬ä¿¡æ¯**:
- **ä¸ŠæŠ¥åœ°å€**: `http://59.225.208.12:18085/access/data/report`
- **212åè®®åœ°å€**: `59.225.208.12:18086`
- **API Key**: `AK-9lKIK7RZrHxPsxq9eYzb2BWBCq8WeSwIPC2e`
- **åŠ å¯†æ–¹å¼**: SM2å›½å¯†åŠ å¯†
- **åè®®**: HTTP POST

**æ•°æ®æ ¼å¼**:
```json
{
  "deviceCode": "TEST10001",
  "paramType": "HOUR",           // MIN/HOUR/DAY/OTHER
  "dataType": "HOUR",
  "timestamp": 1754387006225,
  "signature": "db93fe67cd...",
  "data": [{
    "dataTime": "2025-08-05 17:43:26",
    "dataStr": "{\"CODE\":\"abcd\",\"Nuclide\":\"abcd\",\"GPS\":1,\"Vbat\":\"3.7V\",\"LNG\":\"11700.5398\",\"LAT\":\"3637.2522\",\"FSY\":100.0}"
  }]
}
```

**ç‰¹ç‚¹**:
- âœ… æ”¯æŒHTTPå’Œ212åè®®ä¸¤ç§æ–¹å¼
- âœ… SM2å›½å¯†åŠ å¯†
- âœ… æ”¯æŒå¤šç§æ•°æ®ç²’åº¦ï¼ˆMIN/HOUR/DAYï¼‰
- âœ… çµæ´»çš„JSONæ ¼å¼

### æ–¹å¼äºŒï¼šå±±ä¸œä¸ŠæŠ¥ï¼ˆTCPåè®® + è‡ªå®šä¹‰æ ¼å¼ï¼‰

**åŸºæœ¬ä¿¡æ¯**:
- **åè®®**: TCP
- **å¹³å°åœ°å€**: `117.73.252.128:8091`
- **å‚è€ƒæ ‡å‡†**: HJ/T212-2005
- **ç¼–ç **: ASCIIç 

**é€šè®¯åŒ…æ ¼å¼**:
```
##æ•°æ®æ®µé•¿åº¦CRCæ ¡éªŒ<CR><LF>
```

**æ•°æ®æ®µç»“æ„** (3051å®æ—¶æ•°æ®ä¸ŠæŠ¥):
```
QN=20101201010101001;ST=61;CN=3051;PW=123456;CP=&&MN=01010101010101;Ma=000001;Rno=010101010101;Xtype=01;LastAct=2.700E004;NowAct=1.300E004;SourceTime=20120101;DataTime=20101201010501;LONG=11225.1333;LAT=3705.4300;Xvalue=1000000.000;Thres=100000.000;AlertType=01;BattChar=1000.0;Sig=1;&&
```

**å…³é”®å‘½ä»¤**:
- **3051**: å®æ—¶æ•°æ®ä¸ŠæŠ¥ï¼ˆæŠ¥è­¦/æ•…éšœæ—¶10~20ç§’1æ¡ï¼Œæ­£å¸¸5åˆ†é’Ÿ1æ¡ï¼‰
- **3052**: GPRSæ–­å¼€æ—¶æ•°æ®è¡¥ä¼ 
- **2011**: å†å²æ•°æ®ä¸»åŠ¨æå–

**ç‰¹ç‚¹**:
- âœ… æ ‡å‡†è¡Œä¸šåè®®ï¼ˆHJ/T212-2005ï¼‰
- âœ… æ”¯æŒå®æ—¶ä¸ŠæŠ¥å’Œè¡¥ä¼ 
- âœ… TCPé•¿è¿æ¥
- âœ… ASCIIç¼–ç 

---

## ğŸ¯ ç»¼åˆè®¾è®¡æ–¹æ¡ˆ

### è®¾è®¡ç†å¿µ

**å¤šåè®®é€‚é… + è®¾å¤‡çº§é…ç½® + ä¼ä¸šçº§ç®¡ç†**

### æ•°æ®åº“è®¾è®¡

#### æ–¹æ¡ˆï¼šæ‰©å±•Deviceè¡¨ï¼ˆæ¨èï¼‰

ä¸ºæ¯ä¸ªè¾å°„è®¾å¤‡æ·»åŠ ä¸ŠæŠ¥é…ç½®å­—æ®µï¼š

```sql
ALTER TABLE ems_device ADD COLUMN data_report_enabled BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å¯ç”¨æ•°æ®ä¸ŠæŠ¥';
ALTER TABLE ems_device ADD COLUMN report_protocol VARCHAR(20) DEFAULT 'SICHUAN' COMMENT 'ä¸ŠæŠ¥åè®®: SICHUAN/SHANDONG';
ALTER TABLE ems_device ADD COLUMN report_granularity VARCHAR(20) DEFAULT 'HOUR' COMMENT 'ä¸ŠæŠ¥ç²’åº¦: MIN/HOUR/DAY';
ALTER TABLE ems_device ADD COLUMN report_interval INT DEFAULT 1 COMMENT 'ä¸ŠæŠ¥é—´éš”(åˆ†é’Ÿ)';
ALTER TABLE ems_device ADD COLUMN gps_priority VARCHAR(20) DEFAULT 'BDS' COMMENT 'GPSä¼˜å…ˆçº§: BDS/LBS/BDS_THEN_LBS';
ALTER TABLE ems_device ADD COLUMN last_report_time DATETIME COMMENT 'æœ€åä¸ŠæŠ¥æ—¶é—´';
ALTER TABLE ems_device ADD COLUMN last_report_status VARCHAR(20) COMMENT 'æœ€åä¸ŠæŠ¥çŠ¶æ€: SUCCESS/FAILED';
```

**ä¼˜ç‚¹**:
- âœ… æ¯ä¸ªè®¾å¤‡ç‹¬ç«‹é…ç½®
- âœ… æ”¯æŒä¸åŒè®¾å¤‡ä½¿ç”¨ä¸åŒä¸ŠæŠ¥åè®®
- âœ… ç®€å•ç›´è§‚ï¼Œæ˜“äºç®¡ç†
- âœ… æ— éœ€åˆ›å»ºæ–°è¡¨

### é…ç½®é¡¹è¯´æ˜

#### 1. ä¸ŠæŠ¥åè®®é€‰æ‹© (report_protocol)

| åè®® | å€¼ | è¯´æ˜ |
|------|---|------|
| å››å·ä¸ŠæŠ¥ | SICHUAN | HTTP + SM2åŠ å¯†ï¼Œæ”¯æŒå¤šç²’åº¦ |
| å±±ä¸œä¸ŠæŠ¥ | SHANDONG | TCP + HJ/T212-2005ï¼Œå®æ—¶ä¸ŠæŠ¥ |

#### 2. ä¸ŠæŠ¥ç²’åº¦ (report_granularity)

| ç²’åº¦ | å€¼ | è¯´æ˜ | é€‚ç”¨åè®® |
|------|---|------|---------|
| æ¯åˆ†é’Ÿ | MIN | æ¯åˆ†é’Ÿä¸ŠæŠ¥ä¸€æ¬¡ | SICHUAN |
| æ¯å°æ—¶ | HOUR | æ¯å°æ—¶ä¸ŠæŠ¥ä¸€æ¬¡ | SICHUAN |
| æ¯å¤© | DAY | æ¯å¤©ä¸ŠæŠ¥ä¸€æ¬¡ | SICHUAN |
| å®æ—¶ | REALTIME | æŠ¥è­¦æ—¶10~20ç§’ï¼Œæ­£å¸¸5åˆ†é’Ÿ | SHANDONG |

#### 3. GPSä¼˜å…ˆçº§ (gps_priority)

| ä¼˜å…ˆçº§ | å€¼ | è¯´æ˜ |
|--------|---|------|
| åŒ—æ–—ä¼˜å…ˆ | BDS | ä¼˜å…ˆä½¿ç”¨åŒ—æ–—å®šä½ |
| åŸºç«™ä¼˜å…ˆ | LBS | ä¼˜å…ˆä½¿ç”¨åŸºç«™å®šä½ |
| åŒ—æ–—ç„¶ååŸºç«™ | BDS_THEN_LBS | å…ˆç”¨åŒ—æ–—ï¼Œå¤±è´¥åˆ™ç”¨åŸºç«™ |

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      EMS åç«¯ç³»ç»Ÿ                            â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  æ•°æ®é‡‡é›†æœåŠ¡       â”‚         â”‚
â”‚  â”‚  @Scheduled    â”‚         â”‚  DataCollection     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                        â”‚                     â”‚
â”‚                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                               â”‚ è®¾å¤‡é…ç½®æŸ¥è¯¢     â”‚            â”‚
â”‚                               â”‚ report_protocol â”‚            â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                        â”‚                     â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                    â”‚                   â”‚                   â”‚  â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚           â”‚  å››å·ä¸ŠæŠ¥æœåŠ¡    â”‚  â”‚  å±±ä¸œä¸ŠæŠ¥æœåŠ¡    â”‚          â”‚  â”‚
â”‚           â”‚  SichuanReport   â”‚  â”‚  ShandongReport  â”‚          â”‚  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚                    â”‚                   â”‚                   â”‚  â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚           â”‚  HTTP POST      â”‚  â”‚  TCP Socket     â”‚          â”‚  â”‚
â”‚           â”‚  + SM2åŠ å¯†      â”‚  â”‚  + ASCIIç¼–ç     â”‚          â”‚  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚                    â”‚                   â”‚                   â”‚  â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚           â”‚         ä¸ŠæŠ¥æ—¥å¿—è®°å½•                â”‚          â”‚  â”‚
â”‚           â”‚      DataReportLogService          â”‚          â”‚  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                              â”‚
                    â–¼                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  å››å·ç›‘ç®¡å¹³å°    â”‚          â”‚  å±±ä¸œç›‘ç®¡å¹³å°    â”‚
        â”‚  59.225.208.12   â”‚          â”‚ 117.73.252.128  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚     :8091        â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### 1. å››å·ä¸ŠæŠ¥æœåŠ¡

**æ–‡ä»¶**: `backend/src/main/java/com/cdutetc/ems/service/report/SichuanDataReportService.java`

**åŠŸèƒ½**:
- æ•°æ®é‡‡é›†å’Œèšåˆï¼ˆæŒ‰MIN/HOUR/DAYï¼‰
- SM2åŠ å¯†
- HTTP POSTåˆ°å››å·å¹³å°
- ç­¾åç”Ÿæˆ
- é”™è¯¯é‡è¯•

**å…³é”®æ–¹æ³•**:
```java
public class SichuanDataReportService {

    // ä¸ŠæŠ¥æ•°æ®
    public ReportResult reportData(Device device, ReportGranularity granularity) {
        // 1. é‡‡é›†æ•°æ®
        List<RadiationDeviceData> dataList = collectData(device, granularity);

        // 2. è½¬æ¢æ ¼å¼
        String payload = buildPayload(device, dataList);

        // 3. SM2åŠ å¯†
        String encryptedPayload = sm2EncryptionService.encrypt(payload);

        // 4. HTTP POST
        HttpResponse response = httpClient.post(url, encryptedPayload);

        // 5. è®°å½•æ—¥å¿—
        return logReport(device, response);
    }

    // æ„å»ºä¸ŠæŠ¥Payload
    private String buildPayload(Device device, List<RadiationDeviceData> dataList) {
        // è½¬æ¢ä¸ºå››å·æ ¼å¼
        Map<String, Object> payload = new HashMap<>();
        payload.put("deviceCode", device.getDeviceCode());
        payload.put("paramType", granularity.name());
        payload.put("timestamp", System.currentTimeMillis());

        List<Map<String, String>> data = dataList.stream()
            .map(this::convertToSichuanFormat)
            .collect(Collectors.toList());

        payload.put("data", data);
        payload.put("signature", generateSignature(payload));

        return objectMapper.writeValueAsString(payload);
    }
}
```

#### 2. å±±ä¸œä¸ŠæŠ¥æœåŠ¡

**æ–‡ä»¶**: `backend/src/main/java/com/cdutetc/ems/service/report/ShandongDataReportService.java`

**åŠŸèƒ½**:
- TCPè¿æ¥ç®¡ç†
- æ•°æ®æ ¼å¼è½¬æ¢ï¼ˆHJ/T212-2005ï¼‰
- ASCIIç¼–ç 
- å®æ—¶ä¸ŠæŠ¥ï¼ˆ3051å‘½ä»¤ï¼‰
- è¡¥ä¼ åŠŸèƒ½ï¼ˆ3052å‘½ä»¤ï¼‰

**å…³é”®æ–¹æ³•**:
```java
public class ShandongDataReportService {

    private TcpConnectionManager tcpManager;

    // ä¸ŠæŠ¥å®æ—¶æ•°æ®ï¼ˆ3051å‘½ä»¤ï¼‰
    public ReportResult reportRealtimeData(Device device, RadiationDeviceData data) {
        // 1. æ„å»ºHJ/T212åè®®æ•°æ®åŒ…
        String packet = buildHJT212Packet(device, data, "3051");

        // 2. ASCIIç¼–ç 
        byte[] encodedData = packet.getBytes(StandardCharsets.US_ASCII);

        // 3. TCPå‘é€
        tcpManager.send(encodedData);

        // 4. ç­‰å¾…åº”ç­”
        String response = tcpManager.receive();

        // 5. è®°å½•æ—¥å¿—
        return logReport(device, response);
    }

    // æ„å»ºHJ/T212åè®®åŒ…
    private String buildHJT212Packet(Device device, RadiationDeviceData data, String commandNo) {
        StringBuilder sb = new StringBuilder();
        sb.append("QN=").append(generateQN()).append(";");
        sb.append("ST=61;CN=").append(commandNo).append(";PW=123456;CP=&&");
        sb.append("MN=").append(device.getDeviceCode()).append(";");
        sb.append("Ma=").append(getMaValue()).append(";");
        sb.append("Rno=").append(getRnoValue()).append(";");
        sb.append("Xtype=01;");
        sb.append("LastAct=2.700E004;");
        sb.append("NowAct=1.300E004;");
        sb.append("SourceTime=20120101;");
        sb.append("DataTime=").append(formatDateTime(data.getRecordTime())).append(";");
        sb.append("LONG=").append(formatLng(data.getBdsLongitude())).append(";");
        sb.append("LAT=").append(formatLat(data.getBdsLatitude())).append(";");
        sb.append("Xvalue=").append(data.getCpm()).append(";");
        sb.append("Thres=100000.000;");
        sb.append("AlertType=01;");
        sb.append("BattChar=").append(data.getBatvolt()).append(";");
        sb.append("Sig=").append(getGpsFlag()).append(";");
        sb.append("&&");

        // æ·»åŠ åŒ…å¤´ã€é•¿åº¦ã€CRCã€åŒ…å°¾
        return wrapPacket(sb.toString());
    }
}
```

#### 3. åè®®è·¯ç”±æœåŠ¡

**æ–‡ä»¶**: `backend/src/main/java/com/cdutetc/ems/service/report/DataReportRouterService.java`

**åŠŸèƒ½**: æ ¹æ®è®¾å¤‡é…ç½®é€‰æ‹©ä¸ŠæŠ¥åè®®

```java
@Service
public class DataReportRouterService {

    @Autowired
    private SichuanDataReportService sichuanService;

    @Autowired
    private ShandongDataReportService shandongService;

    public ReportResult report(Device device, ReportGranularity granularity) {
        if (!device.isDataReportEnabled()) {
            return ReportResult.disabled();
        }

        switch (device.getReportProtocol()) {
            case "SICHUAN":
                return sichuanService.reportData(device, granularity);

            case "SHANDONG":
                return shandongService.reportRealtimeData(device, getCurrentData(device));

            default:
                log.warn("Unknown report protocol: {}", device.getReportProtocol());
                return ReportResult.failed("Unknown protocol");
        }
    }
}
```

#### 4. å®šæ—¶ä»»åŠ¡è°ƒåº¦

**æ–‡ä»¶**: `backend/src/main/java/com/cdutetc/ems/scheduler/DataReportScheduler.java`

```java
@Component
public class DataReportScheduler {

    @Autowired
    private DataReportRouterService routerService;

    // å››å·åè®® - æ¯å°æ—¶ä¸ŠæŠ¥
    @Scheduled(cron = "0 0 * * * ?")
    public void sichuanHourlyReport() {
        List<Device> devices = deviceService.findEnabledReportDevices("SICHUAN", "HOUR");
        devices.forEach(device ->
            routerService.report(device, ReportGranularity.HOUR)
        );
    }

    // å››å·åè®® - æ¯å¤©ä¸ŠæŠ¥
    @Scheduled(cron = "0 0 0 * * ?")
    public void sichuanDailyReport() {
        List<Device> devices = deviceService.findEnabledReportDevices("SICHUAN", "DAY");
        devices.forEach(device ->
            routerService.report(device, ReportGranularity.DAY)
        );
    }

    // å±±ä¸œåè®® - å®æ—¶ä¸ŠæŠ¥ï¼ˆ5åˆ†é’Ÿï¼‰
    @Scheduled(fixedRate = 300000) // 5åˆ†é’Ÿ
    public void shandongRealtimeReport() {
        List<Device> devices = deviceService.findEnabledReportDevices("SHANDONG", "REALTIME");
        devices.forEach(device ->
            routerService.report(device, ReportGranularity.REALTIME)
        );
    }
}
```

### å‰ç«¯é…ç½®ç•Œé¢

#### è®¾å¤‡ç¼–è¾‘é¡µé¢æ‰©å±•

åœ¨ `DeviceForm.vue` ä¸­æ·»åŠ ä¸ŠæŠ¥é…ç½®å¡ç‰‡ï¼š

```vue
<el-card class="report-config" v-if="formData.deviceType === 'RADIATION'">
  <template #header>
    <span>æ•°æ®ä¸ŠæŠ¥é…ç½®</span>
  </template>

  <el-form-item label="å¯ç”¨ä¸ŠæŠ¥">
    <el-switch v-model="formData.dataReportEnabled" />
  </el-form-item>

  <el-form-item label="ä¸ŠæŠ¥åè®®">
    <el-radio-group v-model="formData.reportProtocol">
      <el-radio value="SICHUAN">å››å·åè®®ï¼ˆHTTP+SM2ï¼‰</el-radio>
      <el-radio value="SHANDONG">å±±ä¸œåè®®ï¼ˆTCP+HJ/T212ï¼‰</el-radio>
    </el-radio-group>
  </el-form-item>

  <el-form-item label="ä¸ŠæŠ¥ç²’åº¦" v-if="formData.reportProtocol === 'SICHUAN'">
    <el-select v-model="formData.reportGranularity">
      <el-option value="MIN" label="æ¯åˆ†é’Ÿ" />
      <el-option value="HOUR" label="æ¯å°æ—¶" />
      <el-option value="DAY" label="æ¯å¤©" />
    </el-select>
  </el-form-item>

  <el-form-item label="GPSä¼˜å…ˆçº§">
    <el-select v-model="formData.gpsPriority">
      <el-option value="BDS" label="åŒ—æ–—ä¼˜å…ˆ" />
      <el-option value="LBS" label="åŸºç«™ä¼˜å…ˆ" />
      <el-option value="BDS_THEN_LBS" label="åŒ—æ–—ç„¶ååŸºç«™" />
    </el-select>
  </el-form-item>

  <!-- çŠ¶æ€æ˜¾ç¤º -->
  <el-form-item label="æœ€åä¸ŠæŠ¥">
    <span v-if="formData.lastReportTime">
      {{ formData.lastReportTime }} -
      <el-tag :type="formData.lastReportStatus === 'SUCCESS' ? 'success' : 'danger'">
        {{ formData.lastReportStatus }}
      </el-tag>
    </span>
    <span v-else>æš‚æ— ä¸ŠæŠ¥è®°å½•</span>
  </el-form-item>
</el-card>
```

### APIæ¥å£

#### è®¾å¤‡ä¸ŠæŠ¥é…ç½®

```java
@RestController
@RequestMapping("/api/devices")
public class DeviceDataReportController {

    // æ›´æ–°ä¸ŠæŠ¥é…ç½®
    @PutMapping("/{id}/report-config")
    public ResponseEntity<ApiResponse<Device>> updateReportConfig(
        @PathVariable Long id,
        @RequestBody DataReportConfigRequest request
    ) {
        Device device = deviceService.updateReportConfig(id, request);
        return ResponseEntity.ok(ApiResponse.success(device));
    }

    // æµ‹è¯•ä¸ŠæŠ¥
    @PostMapping("/{id}/report/test")
    public ResponseEntity<ApiResponse<ReportResult>> testReport(
        @PathVariable Long id,
        @RequestParam(required = false) ReportGranularity granularity
    ) {
        ReportResult result = dataReportService.testReport(id, granularity);
        return ResponseEntity.ok(ApiResponse.success(result));
    }

    // è·å–ä¸ŠæŠ¥æ—¥å¿—
    @GetMapping("/{id}/report-logs")
    public ResponseEntity<ApiResponse<Page<DataReportLog>>> getReportLogs(
        @PathVariable Long id,
        @RequestParam(defaultValue = "0") int page,
        @RequestParam(defaultValue = "10") int size
    ) {
        Page<DataReportLog> logs = dataReportService.getReportLogs(id, page, size);
        return ResponseEntity.ok(ApiResponse.success(logs));
    }
}
```

---

## ğŸ›ï¸ é…ç½®ç¤ºä¾‹

### åœºæ™¯1: è®¾å¤‡Aä½¿ç”¨å››å·åè®®ï¼Œæ¯å°æ—¶ä¸ŠæŠ¥

```json
{
  "deviceCode": "GM5-A001",
  "dataReportEnabled": true,
  "reportProtocol": "SICHUAN",
  "reportGranularity": "HOUR",
  "gpsPriority": "BDS"
}
```

### åœºæ™¯2: è®¾å¤‡Bä½¿ç”¨å±±ä¸œåè®®ï¼Œå®æ—¶ä¸ŠæŠ¥

```json
{
  "deviceCode": "GM5-B001",
  "dataReportEnabled": true,
  "reportProtocol": "SHANDONG",
  "reportGranularity": "REALTIME",
  "gpsPriority": "BDS_THEN_LBS"
}
```

### åœºæ™¯3: è®¾å¤‡Cä¸ä¸ŠæŠ¥

```json
{
  "deviceCode": "GM5-C001",
  "dataReportEnabled": false
}
```

---

## ğŸ“ å®æ–½æ­¥éª¤

### é˜¶æ®µä¸€ï¼šåŸºç¡€æ¶æ„ï¼ˆç¬¬1-2å¤©ï¼‰
1. âœ… æ‰©å±•Deviceè¡¨ï¼Œæ·»åŠ ä¸ŠæŠ¥é…ç½®å­—æ®µ
2. âœ… æ·»åŠ SM2åŠ å¯†ä¾èµ–
3. âœ… åˆ›å»ºä¸ŠæŠ¥æœåŠ¡åŸºç¡€æ¶æ„
4. âœ… å®ç°åè®®è·¯ç”±æœåŠ¡

### é˜¶æ®µäºŒï¼šå››å·åè®®å®ç°ï¼ˆç¬¬3-4å¤©ï¼‰
5. âœ… å®ç°SichuanDataReportService
6. âœ… æ•°æ®é‡‡é›†å’Œèšåˆé€»è¾‘
7. âœ… SM2åŠ å¯†é›†æˆ
8. âœ… HTTP POSTå®ç°

### é˜¶æ®µä¸‰ï¼šå±±ä¸œåè®®å®ç°ï¼ˆç¬¬5-6å¤©ï¼‰
9. âœ… å®ç°ShandongDataReportService
10. âœ… TCPè¿æ¥ç®¡ç†å™¨
11. âœ… HJ/T212åè®®ç¼–è§£ç 
12. âœ… å®æ—¶ä¸ŠæŠ¥å’Œè¡¥ä¼ 

### é˜¶æ®µå››ï¼šç®¡ç†å’Œæµ‹è¯•ï¼ˆç¬¬7-8å¤©ï¼‰
13. âœ… å‰ç«¯é…ç½®ç•Œé¢
14. âœ… å®šæ—¶ä»»åŠ¡é…ç½®
15. âœ… æµ‹è¯•ä¸¤ç§åè®®
16. âœ… æ—¥å¿—å’Œç›‘æ§

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. åè®®åˆ‡æ¢
- è®¾å¤‡ä»å››å·åè®®åˆ‡æ¢åˆ°å±±ä¸œåè®®æ—¶ï¼Œéœ€è¦é‡æ–°è¿æ¥
- å»ºè®®åœ¨ä½å³°æœŸåˆ‡æ¢åè®®

### 2. æ•°æ®ä¸€è‡´æ€§
- ä¸¤ç§åè®®æ•°æ®æ ¼å¼ä¸åŒï¼Œè½¬æ¢æ—¶æ³¨æ„ç²¾åº¦
- GPSåæ ‡æ ¼å¼è½¬æ¢ï¼ˆåº¦åˆ†æ ¼å¼ vs åè¿›åˆ¶åº¦ï¼‰

### 3. é”™è¯¯å¤„ç†
- TCPè¿æ¥æ–­å¼€åè‡ªåŠ¨é‡è¿
- HTTPè¯·æ±‚å¤±è´¥åé‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- è¯¦ç»†è®°å½•å¤±è´¥åŸå› 

### 4. æ€§èƒ½ä¼˜åŒ–
- å±±ä¸œåè®®ï¼šä¿æŒTCPé•¿è¿æ¥ï¼Œé¿å…é¢‘ç¹è¿æ¥
- å››å·åè®®ï¼šæ‰¹é‡ä¸ŠæŠ¥ï¼Œå‡å°‘HTTPè¯·æ±‚
- ä½¿ç”¨å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹

---

## âœ… éªŒæ”¶æ ‡å‡†

1. âœ… æ”¯æŒå››å·å’Œå±±ä¸œä¸¤ç§ä¸ŠæŠ¥åè®®
2. âœ… è®¾å¤‡çº§é…ç½®ï¼Œæ¯ä¸ªè®¾å¤‡ç‹¬ç«‹é€‰æ‹©åè®®
3. âœ… æ”¯æŒå¯ç”¨/ç¦ç”¨ä¸ŠæŠ¥
4. âœ… å‰ç«¯é…ç½®ç•Œé¢å‹å¥½
5. âœ… è¯¦ç»†çš„æ—¥å¿—è®°å½•
6. âœ… é”™è¯¯é‡è¯•æœºåˆ¶
7. âœ… å®šæ—¶ä»»åŠ¡æ­£å¸¸æ‰§è¡Œ
8. âœ… æµ‹è¯•ä¸ŠæŠ¥åŠŸèƒ½æ­£å¸¸
