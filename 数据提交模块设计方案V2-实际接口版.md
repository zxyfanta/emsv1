# æ•°æ®æäº¤æ¨¡å—è®¾è®¡æ–¹æ¡ˆ V2.0 (åŸºäºå®é™…æ¥å£æ–‡æ¡£)

## ğŸ“‹ æ¥å£æ–‡æ¡£åˆ†æ

### æ ¸å¿ƒä¿¡æ¯
- **HTTPä¸ŠæŠ¥åœ°å€**: `http://59.225.208.12:18085/access/data/report?apiKey=AK-9lKIK7RZrHxPsxq9eYzb2BWBCq8WeSwIPC2e`
- **212åè®®åœ°å€**: `59.225.208.12:18086`
- **è®¤è¯æ–¹å¼**: API Key (AK-9lKIK7RZrHxPsxq9eYzb2BWBCq8WeSwIPC2e)
- **åŠ å¯†æ–¹å¼**: SM2å›½å¯†åŠ å¯†
- **å…¬é’¥è·å–**: `http://59.225.208.12:18085/system/openApi/getPublicKey`

### æ•°æ®æ ¼å¼è¦æ±‚

```json
{
  "deviceCode": "TEST10001",        // è®¾å¤‡ç¼–å·
  "paramType": "HOUR",              // æ•°æ®ç²’åº¦: MIN/HOUR/DAY/OTHER
  "dataType": "HOUR",               // æ•°æ®ç±»å‹
  "timestamp": 1754387006225,        // æ—¶é—´æˆ³
  "signature": "db93fe67cd...",     // ç­¾å
  "data": [
    {
      "dataTime": "2025-08-05 17:43:26",  // æ•°æ®æ—¶é—´ yyyy-MM-dd HH:mm:ss
      "dataStr": "{\"CODE\":\"abcd\",\"Nuclide\":\"abcd\",\"GPS\":1234,\"Vbat\":\"abcd\",\"LNG\":\"abcd\",\"LAT\":\"abcd\",\"FSY\":1234.223}"
    }
  ]
}
```

### dataStrå†…éƒ¨å­—æ®µ (è¾å°„ç›‘æµ‹æ•°æ®)
| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¯¹åº”EMSç³»ç»Ÿ |
|-----|------|------|------------|
| CODE | string | è¾å°„æºç¼–å· | device.deviceCode |
| Nuclide | string | æ ¸ç´  | device.description |
| GPS | int | GPSå®šä½Flag | (bdsUseful || lbsUseful) ? 1 : 0 |
| Vbat | string | å‰©ä½™ç”µé‡ | (Batvolt / 1000) + "V" |
| LNG | string | ç»åº¦ | bdsLongitude æˆ– lbsLongitude |
| LAT | string | çº¬åº¦ | bdsLatitude æˆ– lbsLatitude |
| FSY | float | è¾å°„å€¼ | cpm |

---

## ğŸ—ï¸ é‡æ–°è®¾è®¡æ–¹æ¡ˆ

### æ–¹æ¡ˆç‰¹ç‚¹
1. **ç®€åŒ–è®¾è®¡** - å›ºå®šä¸ŠæŠ¥ç›®æ ‡,ä¸éœ€è¦å¤æ‚é…ç½®
2. **SM2åŠ å¯†** - é›†æˆå›½å¯†åŠ å¯†
3. **æ•°æ®è½¬æ¢** - è‡ªåŠ¨æ˜ å°„EMSæ•°æ®åˆ°æ¥å£æ ¼å¼
4. **çµæ´»è°ƒåº¦** - æ”¯æŒMIN/HOUR/DAYä¸‰ç§ç²’åº¦
5. **ä¼ä¸šçº§éš”ç¦»** - æ¯ä¸ªä¼ä¸šç‹¬ç«‹å¼€å…³å’Œé…ç½®

---

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### 1. ä¸ŠæŠ¥é…ç½®è¡¨

```sql
CREATE TABLE ems_data_report_config (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    company_id BIGINT NOT NULL COMMENT 'ä¼ä¸šID',

    -- åŸºç¡€é…ç½®
    enabled BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å¯ç”¨ä¸ŠæŠ¥',
    config_name VARCHAR(100) COMMENT 'é…ç½®åç§°',

    -- ä¸ŠæŠ¥ç›®æ ‡(å›ºå®š,ä¸å¯ä¿®æ”¹)
    report_url VARCHAR(200) DEFAULT 'http://59.225.208.12:18085/access/data/report' COMMENT 'ä¸ŠæŠ¥åœ°å€',
    api_key VARCHAR(200) DEFAULT 'AK-9lKIK7RZrHxPsxq9eYzb2BWBCq8WeSwIPC2e' COMMENT 'API Key',
    public_key_url VARCHAR(200) DEFAULT 'http://59.225.208.12:18085/system/openApi/getPublicKey' COMMENT 'å…¬é’¥è·å–åœ°å€',

    -- è°ƒåº¦é…ç½®
    report_granularity VARCHAR(20) DEFAULT 'HOUR' COMMENT 'ä¸ŠæŠ¥ç²’åº¦: MIN/HOUR/DAY',
    report_interval INT DEFAULT 1 COMMENT 'ä¸ŠæŠ¥é—´éš”(ç²’åº¦å€æ•°)',
    cron_expression VARCHAR(100) COMMENT 'è‡ªå®šä¹‰cronè¡¨è¾¾å¼',

    -- æ•°æ®é…ç½®
    device_filter VARCHAR(500) COMMENT 'è®¾å¤‡è¿‡æ»¤æ¡ä»¶(JSON)',
    include_offline BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦åŒ…å«ç¦»çº¿è®¾å¤‡',
    batch_size INT DEFAULT 100 COMMENT 'æ¯æ‰¹ä¸ŠæŠ¥æ•°é‡',

    -- GPSæ•°æ®é…ç½®
    gps_priority VARCHAR(20) DEFAULT 'BDS' COMMENT 'GPSä¼˜å…ˆçº§: BDS/LBS/BDS_THEN_LBS',
    coordinate_format VARCHAR(20) DEFAULT 'DECIMAL' COMMENT 'åæ ‡æ ¼å¼: DECIMAL/DEGREE_MINUTE',

    -- çŠ¶æ€è¿½è¸ª
    last_report_time DATETIME COMMENT 'æœ€åä¸ŠæŠ¥æ—¶é—´',
    last_report_count INT DEFAULT 0 COMMENT 'æœ€åä¸ŠæŠ¥æ•°é‡',
    next_report_time DATETIME COMMENT 'ä¸‹æ¬¡ä¸ŠæŠ¥æ—¶é—´',
    total_reports INT DEFAULT 0 COMMENT 'æ€»ä¸ŠæŠ¥æ¬¡æ•°',
    success_count INT DEFAULT 0 COMMENT 'æˆåŠŸæ¬¡æ•°',
    failure_count INT DEFAULT 0 COMMENT 'å¤±è´¥æ¬¡æ•°',
    last_error TEXT COMMENT 'æœ€åé”™è¯¯ä¿¡æ¯',

    -- å®¡è®¡å­—æ®µ
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by VARCHAR(50),
    updated_by VARCHAR(50),

    FOREIGN KEY (company_id) REFERENCES ems_company(id),
    INDEX idx_company (company_id),
    INDEX idx_enabled (enabled)
) COMMENT='æ•°æ®ä¸ŠæŠ¥é…ç½®è¡¨';
```

### 2. ä¸ŠæŠ¥æ—¥å¿—è¡¨

```sql
CREATE TABLE ems_data_report_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    company_id BIGINT NOT NULL COMMENT 'ä¼ä¸šID',
    config_id BIGINT NOT NULL COMMENT 'é…ç½®ID',

    -- ä¸ŠæŠ¥ä¿¡æ¯
    report_time DATETIME NOT NULL COMMENT 'ä¸ŠæŠ¥æ—¶é—´',
    granularity VARCHAR(20) COMMENT 'ä¸ŠæŠ¥ç²’åº¦: MIN/HOUR/DAY',
    record_count INT COMMENT 'ä¸ŠæŠ¥è®°å½•æ•°',
    status VARCHAR(20) COMMENT 'çŠ¶æ€: SUCCESS/FAILED/PARTIAL',

    -- è¯·æ±‚ä¿¡æ¯
    device_code VARCHAR(50) COMMENT 'è®¾å¤‡ç¼–å·',
    request_url VARCHAR(500) COMMENT 'è¯·æ±‚URL',
    request_body TEXT COMMENT 'è¯·æ±‚ä½“(åŸå§‹)',
    encrypted_data TEXT COMMENT 'åŠ å¯†åæ•°æ®',
    auth_key VARCHAR(100) COMMENT 'è®¤è¯Key',

    -- å“åº”ä¿¡æ¯
    http_status INT COMMENT 'HTTPçŠ¶æ€ç ',
    response_body TEXT COMMENT 'å“åº”ä½“',
    success BOOLEAN COMMENT 'æ˜¯å¦æˆåŠŸ',
    status_code INT COMMENT 'ä¸šåŠ¡çŠ¶æ€ç ',
    message VARCHAR(500) COMMENT 'å“åº”æ¶ˆæ¯',

    -- æ€§èƒ½æŒ‡æ ‡
    duration BIGINT COMMENT 'è€—æ—¶(ms)',
    retry_count INT DEFAULT 0 COMMENT 'é‡è¯•æ¬¡æ•°',

    -- é”™è¯¯ä¿¡æ¯
    error_type VARCHAR(50) COMMENT 'é”™è¯¯ç±»å‹',
    error_message TEXT COMMENT 'é”™è¯¯è¯¦æƒ…',
    stack_trace TEXT COMMENT 'å¼‚å¸¸å †æ ˆ',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (config_id) REFERENCES ems_data_report_config(id),
    INDEX idx_company_time (company_id, report_time),
    INDEX idx_status (status),
    INDEX idx_device_time (device_code, report_time)
) COMMENT='æ•°æ®ä¸ŠæŠ¥æ—¥å¿—è¡¨';
```

---

## ğŸ”§ åç«¯å®ç°

### 1. å®ä½“ç±»

```java
package com.cdutetc.ems.entity;

import jakarta.persistence.*;
import lombok.Data;
import java.time.LocalDateTime;
import java.util.Map;

/**
 * æ•°æ®ä¸ŠæŠ¥é…ç½®å®ä½“
 */
@Data
@Entity
@Table(name = "ems_data_report_config")
public class DataReportConfig {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "company_id", nullable = false)
    private Company company;

    @Column(name = "enabled")
    private Boolean enabled = false;

    @Column(name = "config_name")
    private String configName;

    @Column(name = "report_url")
    private String reportUrl = "http://59.225.208.12:18085/access/data/report";

    @Column(name = "api_key")
    private String apiKey = "AK-9lKIK7RZrHxPsxq9eYzb2BWBCq8WeSwIPC2e";

    @Column(name = "public_key_url")
    private String publicKeyUrl = "http://59.225.208.12:18085/system/openApi/getPublicKey";

    @Enumerated(EnumType.STRING)
    @Column(name = "report_granularity")
    private ReportGranularity granularity = ReportGranularity.HOUR;

    @Column(name = "report_interval")
    private Integer reportInterval = 1;

    @Column(name = "cron_expression")
    private String cronExpression;

    @Column(name = "device_filter")
    private String deviceFilter;

    @Column(name = "include_offline")
    private Boolean includeOffline = false;

    @Column(name = "batch_size")
    private Integer batchSize = 100;

    @Enumerated(EnumType.STRING)
    @Column(name = "gps_priority")
    private GpsPriority gpsPriority = GpsPriority.BDS;

    @Column(name = "coordinate_format")
    private String coordinateFormat = "DECIMAL";

    @Column(name = "last_report_time")
    private LocalDateTime lastReportTime;

    @Column(name = "last_report_count")
    private Integer lastReportCount = 0;

    @Column(name = "next_report_time")
    private LocalDateTime nextReportTime;

    @Column(name = "total_reports")
    private Integer totalReports = 0;

    @Column(name = "success_count")
    private Integer successCount = 0;

    @Column(name = "failure_count")
    private Integer failureCount = 0;

    @Column(name = "last_error", columnDefinition = "TEXT")
    private String lastError;

    @Column(name = "created_at")
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;

    @Column(name = "created_by")
    private String createdBy;

    @Column(name = "updated_by")
    private String updatedBy;

    @PrePersist
    protected void onCreate() {
        createdAt = LocalDateTime.now();
        updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        updatedAt = LocalDateTime.now();
    }
}

/**
 * ä¸ŠæŠ¥ç²’åº¦æšä¸¾
 */
public enum ReportGranularity {
    MIN,    // åˆ†é’Ÿçº§
    HOUR,   // å°æ—¶çº§
    DAY     // å¤©çº§
}

/**
 * GPSä¼˜å…ˆçº§æšä¸¾
 */
public enum GpsPriority {
    BDS,             // ä»…BDS
    LBS,             // ä»…LBS
    BDS_THEN_LBS     // BDSä¼˜å…ˆ,æ— BDSæ—¶ç”¨LBS
}
```

### 2. ä¸ŠæŠ¥è¯·æ±‚DTO

```java
package com.cdutetc.ems.dto.request;

import lombok.Data;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import java.util.List;

/**
 * æ•°æ®ä¸ŠæŠ¥è¯·æ±‚DTO
 */
@Data
public class DataReportRequest {

    @NotBlank(message = "è®¾å¤‡ç¼–å·ä¸èƒ½ä¸ºç©º")
    private String deviceCode;

    @NotBlank(message = "æ•°æ®æ ¼å¼ä¸èƒ½ä¸ºç©º")
    private String paramType = "HTTP";  // HTTP æˆ– 212

    @NotNull(message = "æ•°æ®ç±»å‹ä¸èƒ½ä¸ºç©º")
    private String dataType;  // MIN/HOUR/DAY/OTHER

    @NotNull(message = "æ—¶é—´æˆ³ä¸èƒ½ä¸ºç©º")
    private Long timestamp;

    private String signature;  // ç­¾å(å¯é€‰)

    @NotNull(message = "æ•°æ®ä¸èƒ½ä¸ºç©º")
    private List<DataItem> data;

    @Data
    public static class DataItem {
        @NotBlank(message = "æ•°æ®æ—¶é—´ä¸èƒ½ä¸ºç©º")
        private String dataTime;  // yyyy-MM-dd HH:mm:ss

        @NotBlank(message = "æ•°æ®å†…å®¹ä¸èƒ½ä¸ºç©º")
        private String dataStr;   // JSONå­—ç¬¦ä¸²
    }
}
```

### 3. SM2åŠ å¯†å·¥å…·

```java
package com.cdutetc.ems.util;

import org.springframework.stereotype.Component;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import java.security.PublicKey;
import java.util.Map;

/**
 * SM2åŠ å¯†å·¥å…·
 * éœ€è¦å¼•å…¥ä¾èµ–:
 * <dependency>
 *   <groupId>org.bouncycastle</groupId>
 *   <artifactId>bcprov-jdk15on</artifactId>
 *   <version>1.70</version>
 * </dependency>
 */
@Component
public class SM2EncryptUtil {

    private static final Logger log = LoggerFactory.getLogger(SM2EncryptUtil.class);

    private String cachedPublicKey;
    private long publicKeyCacheTime;
    private static final long PUBLIC_KEY_CACHE_DURATION = 3600000; // 1å°æ—¶

    /**
     * è·å–å…¬é’¥
     */
    public String getPublicKey(String publicKeyUrl) {
        // æ£€æŸ¥ç¼“å­˜
        if (cachedPublicKey != null &&
            System.currentTimeMillis() - publicKeyCacheTime < PUBLIC_KEY_CACHE_DURATION) {
            return cachedPublicKey;
        }

        try {
            // è°ƒç”¨æ¥å£è·å–å…¬é’¥
            String response = RestUtil.get(publicKeyUrl);
            Map<String, Object> result = JsonUtil.parseMap(response);
            String publicKey = (String) result.get("publicKey");

            // ç¼“å­˜å…¬é’¥
            cachedPublicKey = publicKey;
            publicKeyCacheTime = System.currentTimeMillis();

            return publicKey;
        } catch (Exception e) {
            log.error("è·å–å…¬é’¥å¤±è´¥", e);
            throw new RuntimeException("è·å–å…¬é’¥å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * SM2åŠ å¯†
     * @param data åŸå§‹æ•°æ®(JSONå­—ç¬¦ä¸²)
     * @param publicKey å…¬é’¥
     * @return Base64ç¼–ç çš„å¯†æ–‡
     */
    public String encrypt(String data, String publicKey) {
        try {
            // ä½¿ç”¨Bouncy Castleå®ç°SM2åŠ å¯†
            // è¿™é‡Œéœ€è¦å®é™…çš„SM2åŠ å¯†å®ç°
            SM2 sm2 = SmUtil.sm2(null, publicKey);
            String encryptStr = sm2.encryptBase64(data, KeyType.PublicKey);
            return encryptStr;
        } catch (Exception e) {
            log.error("SM2åŠ å¯†å¤±è´¥", e);
            throw new RuntimeException("SM2åŠ å¯†å¤±è´¥: " + e.getMessage());
        }
    }

    /**
     * åŠ å¯†å¹¶æ„å»ºä¸ŠæŠ¥è¯·æ±‚ä½“
     */
    public Map<String, String> buildEncryptedRequest(DataReportRequest request, String publicKey) {
        // 1. å°†è¯·æ±‚å¯¹è±¡è½¬ä¸ºJSONå­—ç¬¦ä¸²
        String jsonData = JsonUtil.toJson(request);

        // 2. SM2åŠ å¯†
        String encryptedData = encrypt(jsonData, publicKey);

        // 3. æ„å»ºè¯·æ±‚å¤´
        Map<String, String> headers = new HashMap<>();
        headers.put("Content-Type", "application/json");
        headers.put("X-Key-ID", "AK-9lKIK7RZrHxPsxq9eYzb2BWBCq8WeSwIPC2e");

        // 4. æ„å»ºè¯·æ±‚ä½“
        Map<String, String> requestBody = new HashMap<>();
        requestBody.put("data", encryptedData);

        return Map.of("headers", headers, "body", requestBody);
    }
}
```

### 4. æ•°æ®è½¬æ¢æœåŠ¡

```java
package com.cdutetc.ems.service;

import com.cdutetc.ems.dto.request.DataReportRequest;
import com.cdutetc.ems.dto.request.DataReportRequest.DataItem;
import com.cdutetc.ems.entity.DataReportConfig;
import com.cdutetc.ems.entity.RadiationDeviceData;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.stereotype.Service;
import lombok.RequiredArgsConstructor;

import java.time.format.DateTimeFormatter;
import java.util.*;

/**
 * æ•°æ®è½¬æ¢æœåŠ¡
 * å°†EMSç³»ç»Ÿæ•°æ®è½¬æ¢ä¸ºä¸ŠæŠ¥æ¥å£æ ¼å¼
 */
@Service
@RequiredArgsConstructor
public class DataTransformService {

    private final ObjectMapper objectMapper;
    private static final DateTimeFormatter DATE_FORMATTER =
        DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

    /**
     * è½¬æ¢è¾å°„è®¾å¤‡æ•°æ®ä¸ºä¸ŠæŠ¥æ ¼å¼
     */
    public DataReportRequest transformRadiationData(
        List<RadiationDeviceData> dataList,
        DataReportConfig config
    ) {
        if (dataList == null || dataList.isEmpty()) {
            return null;
        }

        // è·å–è®¾å¤‡ä¿¡æ¯(å‡è®¾ç¬¬ä¸€æ¡æ•°æ®çš„è®¾å¤‡ä¿¡æ¯ä¸€è‡´)
        RadiationDeviceData firstData = dataList.get(0);
        String deviceCode = firstData.getDevice().getDeviceCode();

        // æ„å»ºè¯·æ±‚
        DataReportRequest request = new DataReportRequest();
        request.setDeviceCode(deviceCode);
        request.setParamType("HTTP");
        request.setDataType(config.getGranularity().name());
        request.setTimestamp(System.currentTimeMillis());

        // è½¬æ¢æ•°æ®é¡¹
        List<DataItem> items = new ArrayList<>();
        for (RadiationDeviceData data : dataList) {
            DataItem item = new DataItem();
            item.setDataTime(data.getRecordTime().format(DATE_FORMATTER));
            item.setDataStr(buildDataStr(data, config));
            items.add(item);
        }
        request.setData(items);

        return request;
    }

    /**
     * æ„å»ºdataStrå­—æ®µå†…å®¹
     */
    private String buildDataStr(RadiationDeviceData data, DataReportConfig config) {
        Map<String, Object> map = new HashMap<>();

        // è®¾å¤‡ç¼–å·
        map.put("CODE", data.getDevice().getDeviceCode());

        // æ ¸ç´ (ä»è®¾å¤‡æè¿°ä¸­è·å–)
        map.put("Nuclide", data.getDevice().getDescription() != null ?
            data.getDevice().getDescription() : "æœªçŸ¥");

        // GPSå®šä½Flag
        map.put("GPS", hasValidGps(data) ? 1 : 0);

        // ç”µæ± ç”µå‹(è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ ¼å¼)
        if (data.getBatvolt() != null) {
            map.put("Vbat", String.format("%.2fV", data.getBatvolt() / 1000));
        }

        // ç»çº¬åº¦(æ ¹æ®ä¼˜å…ˆçº§é€‰æ‹©)
        GpsCoordinate coord = selectGpsCoordinate(data, config);
        if (coord != null) {
            map.put("LNG", coord.getLongitude());
            map.put("LAT", coord.getLatitude());
        }

        // è¾å°„å€¼(CPM)
        map.put("FSY", data.getCpm());

        try {
            return objectMapper.writeValueAsString(map);
        } catch (Exception e) {
            return "{}";
        }
    }

    /**
     * åˆ¤æ–­æ˜¯å¦æœ‰æœ‰æ•ˆGPS
     */
    private boolean hasValidGps(RadiationDeviceData data) {
        return (data.getBdsUseful() != null && data.getBdsUseful() == 1) ||
               (data.getLbsUseful() != null && data.getLbsUseful() == 1);
    }

    /**
     * æ ¹æ®é…ç½®é€‰æ‹©GPSåæ ‡
     */
    private GpsCoordinate selectGpsCoordinate(RadiationDeviceData data, DataReportConfig config) {
        switch (config.getGpsPriority()) {
            case BDS:
                if (data.getBdsUseful() != null && data.getBdsUseful() == 1) {
                    return new GpsCoordinate(data.getBdsLongitude(), data.getBdsLatitude());
                }
                return null;

            case LBS:
                if (data.getLbsUseful() != null && data.getLbsUseful() == 1) {
                    return new GpsCoordinate(data.getLbsLongitude(), data.getLbsLatitude());
                }
                return null;

            case BDS_THEN_LBS:
                if (data.getBdsUseful() != null && data.getBdsUseful() == 1) {
                    return new GpsCoordinate(data.getBdsLongitude(), data.getBdsLatitude());
                }
                if (data.getLbsUseful() != null && data.getLbsUseful() == 1) {
                    return new GpsCoordinate(data.getLbsLongitude(), data.getLbsLatitude());
                }
                return null;

            default:
                return null;
        }
    }

    /**
     * GPSåæ ‡å†…éƒ¨ç±»
     */
    @Data
    @AllArgsConstructor
    private static class GpsCoordinate {
        private String longitude;
        private String latitude;
    }
}
```

### 5. ä¸ŠæŠ¥æœåŠ¡

```java
package com.cdutetc.ems.service;

import com.cdutetc.ems.dto.request.DataReportRequest;
import com.cdutetc.ems.entity.DataReportConfig;
import com.cdutetc.ems.entity.DataReportLog;
import com.cdutetc.ems.repository.DataReportConfigRepository;
import com.cdutetc.ems.repository.DataReportLogRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.*;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.time.LocalDateTime;
import java.util.List;

/**
 * æ•°æ®ä¸ŠæŠ¥æœåŠ¡
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class DataReportService {

    private final DataReportConfigRepository configRepository;
    private final DataReportLogRepository logRepository;
    private final DataTransformService transformService;
    private final SM2EncryptUtil encryptUtil;
    private final RestTemplate restTemplate;

    /**
     * å®šæ—¶æ‰«æå¹¶ä¸ŠæŠ¥æ•°æ®
     * æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
     */
    @Scheduled(cron = "0 */5 * * * ?")
    public void scanAndReport() {
        log.debug("å¼€å§‹æ‰«ææ•°æ®ä¸ŠæŠ¥ä»»åŠ¡...");

        // è·å–æ‰€æœ‰å¯ç”¨çš„é…ç½®
        List<DataReportConfig> configs = configRepository.findByEnabledTrue();

        for (DataReportConfig config : configs) {
            try {
                // æ£€æŸ¥æ˜¯å¦åˆ°ä¸ŠæŠ¥æ—¶é—´
                if (shouldReport(config)) {
                    reportData(config);
                }
            } catch (Exception e) {
                log.error("ä¸ŠæŠ¥æ•°æ®å¤±è´¥, é…ç½®ID: {}", config.getId(), e);
                updateFailureCount(config, e.getMessage());
            }
        }
    }

    /**
     * åˆ¤æ–­æ˜¯å¦åº”è¯¥ä¸ŠæŠ¥
     */
    private boolean shouldReport(DataReportConfig config) {
        LocalDateTime now = LocalDateTime.now();

        // å¦‚æœä»æœªä¸ŠæŠ¥è¿‡,ç«‹å³ä¸ŠæŠ¥
        if (config.getLastReportTime() == null) {
            return true;
        }

        // æ£€æŸ¥ä¸‹æ¬¡ä¸ŠæŠ¥æ—¶é—´
        if (config.getNextReportTime() != null) {
            return now.isAfter(config.getNextReportTime());
        }

        // æ ¹æ®ç²’åº¦è®¡ç®—
        return true;
    }

    /**
     * æ‰§è¡Œæ•°æ®ä¸ŠæŠ¥
     */
    public void reportData(DataReportConfig config) {
        long startTime = System.currentTimeMillis();

        try {
            log.info("å¼€å§‹ä¸ŠæŠ¥æ•°æ®, ä¼ä¸šID: {}, è®¾å¤‡: {}",
                config.getCompany().getId(), config.getConfigName());

            // 1. è·å–å…¬é’¥
            String publicKey = encryptUtil.getPublicKey(config.getPublicKeyUrl());

            // 2. æŸ¥è¯¢éœ€è¦ä¸ŠæŠ¥çš„æ•°æ®
            LocalDateTime startTime = getReportStartTime(config);
            LocalDateTime endTime = LocalDateTime.now();

            List<RadiationDeviceData> dataList = queryReportData(config, startTime, endTime);

            if (dataList.isEmpty()) {
                log.warn("æ²¡æœ‰éœ€è¦ä¸ŠæŠ¥çš„æ•°æ®");
                return;
            }

            // 3. è½¬æ¢æ•°æ®æ ¼å¼
            DataReportRequest request = transformService.transformRadiationData(dataList, config);

            // 4. åŠ å¯†æ•°æ®
            Map<String, String> encryptedRequest = encryptUtil.buildEncryptedRequest(request, publicKey);

            // 5. å‘é€HTTPè¯·æ±‚
            HttpHeaders headers = new HttpHeaders();
            headers.setContentType(MediaType.APPLICATION_JSON);
            headers.set("X-Key-ID", config.getApiKey());

            HttpEntity<String> entity = new HttpEntity<>(
                encryptedRequest.get("body"),
                headers
            );

            ResponseEntity<String> response = restTemplate.exchange(
                config.getReportUrl(),
                HttpMethod.POST,
                entity,
                String.class
            );

            // 6. è®°å½•æ—¥å¿—
            long duration = System.currentTimeMillis() - startTime;
            boolean success = response.getStatusCode().is2xxSuccessful();

            DataReportLog log = buildReportLog(config, request, response, duration, success);
            logRepository.save(log);

            // 7. æ›´æ–°é…ç½®çŠ¶æ€
            updateSuccessCount(config, dataList.size());

            log.info("æ•°æ®ä¸ŠæŠ¥æˆåŠŸ, è®°å½•æ•°: {}, è€—æ—¶: {}ms", dataList.size(), duration);

        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            log.error("æ•°æ®ä¸ŠæŠ¥å¤±è´¥", e);

            DataReportLog log = buildErrorLog(config, e, duration);
            logRepository.save(log);

            updateFailureCount(config, e.getMessage());
        }
    }

    /**
     * æŸ¥è¯¢éœ€è¦ä¸ŠæŠ¥çš„æ•°æ®
     */
    private List<RadiationDeviceData> queryReportData(
        DataReportConfig config,
        LocalDateTime startTime,
        LocalDateTime endTime
    ) {
        // æ ¹æ®é…ç½®æŸ¥è¯¢è®¾å¤‡æ•°æ®
        // å®ç°çœç•¥...
    }

    /**
     * è·å–ä¸ŠæŠ¥èµ·å§‹æ—¶é—´
     */
    private LocalDateTime getReportStartTime(DataReportConfig config) {
        if (config.getLastReportTime() == null) {
            // é»˜è®¤æŸ¥è¯¢æœ€è¿‘1å°æ—¶æ•°æ®
            return LocalDateTime.now().minusHours(1);
        }
        return config.getLastReportTime();
    }

    /**
     * æ„å»ºä¸ŠæŠ¥æ—¥å¿—
     */
    private DataReportLog buildReportLog(
        DataReportConfig config,
        DataReportRequest request,
        ResponseEntity<String> response,
        long duration,
        boolean success
    ) {
        DataReportLog log = new DataReportLog();
        log.setCompany(config.getCompany());
        log.setConfig(config);
        log.setReportTime(LocalDateTime.now());
        log.setGranularity(config.getGranularity().name());
        log.setRecordCount(request.getData().size());
        log.setStatus(success ? "SUCCESS" : "FAILED");
        log.setDeviceCode(request.getDeviceCode());
        log.setRequestUrl(config.getReportUrl());
        log.setRequestBody(JsonUtil.toJson(request));
        log.setHttpStatus(response.getStatusCode().value());
        log.setResponseBody(response.getBody());
        log.setSuccess(success);
        log.setDuration(duration);

        return log;
    }

    /**
     * æ›´æ–°æˆåŠŸè®¡æ•°
     */
    private void updateSuccessCount(DataReportConfig config, int count) {
        config.setLastReportTime(LocalDateTime.now());
        config.setLastReportCount(count);
        config.setTotalReports(config.getTotalReports() + 1);
        config.setSuccessCount(config.getSuccessCount() + 1);
        config.setLastError(null);

        // è®¡ç®—ä¸‹æ¬¡ä¸ŠæŠ¥æ—¶é—´
        config.setNextReportTime(calculateNextReportTime(config));

        configRepository.save(config);
    }

    /**
     * æ›´æ–°å¤±è´¥è®¡æ•°
     */
    private void updateFailureCount(DataReportConfig config, String error) {
        config.setFailureCount(config.getFailureCount() + 1);
        config.setLastError(error);
        configRepository.save(config);
    }

    /**
     * è®¡ç®—ä¸‹æ¬¡ä¸ŠæŠ¥æ—¶é—´
     */
    private LocalDateTime calculateNextReportTime(DataReportConfig config) {
        LocalDateTime now = LocalDateTime.now();

        switch (config.getGranularity()) {
            case MIN:
                return now.plusMinutes(config.getReportInterval());
            case HOUR:
                return now.plusHours(config.getReportInterval());
            case DAY:
                return now.plusDays(config.getReportInterval());
            default:
                return now.plusHours(1);
        }
    }
}
```

---

## ğŸ¨ å‰ç«¯å®ç°

### 1. ä¸ŠæŠ¥é…ç½®é¡µé¢ (ç®¡ç†å‘˜)

```vue
<!-- src/views/data-report/ReportConfigList.vue -->
<template>
  <div class="report-config-list">
    <el-card>
      <template #header>
        <div class="card-header">
          <span>æ•°æ®ä¸ŠæŠ¥é…ç½®ç®¡ç†</span>
          <el-button type="primary" @click="handleCreate">
            æ–°å¢é…ç½®
          </el-button>
        </div>
      </template>

      <el-table :data="tableData" v-loading="loading">
        <el-table-column prop="companyName" label="ä¼ä¸š" width="150" />
        <el-table-column prop="configName" label="é…ç½®åç§°" width="150" />
        <el-table-column prop="granularity" label="ä¸ŠæŠ¥ç²’åº¦" width="100">
          <template #default="{ row }">
            <el-tag :type="getGranularityType(row.granularity)">
              {{ row.granularity }}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column prop="enabled" label="çŠ¶æ€" width="80">
          <template #default="{ row }">
            <el-switch
              v-model="row.enabled"
              @change="handleToggleEnabled(row)"
            />
          </template>
        </el-table-column>
        <el-table-column prop="lastReportTime" label="æœ€åä¸ŠæŠ¥" width="160" />
        <el-table-column prop="successRate" label="æˆåŠŸç‡" width="100">
          <template #default="{ row }">
            {{ calculateSuccessRate(row) }}%
          </template>
        </el-table-column>
        <el-table-column label="æ“ä½œ" width="200">
          <template #default="{ row }">
            <el-button size="small" @click="handleViewLog(row)">
              æŸ¥çœ‹æ—¥å¿—
            </el-button>
            <el-button size="small" @click="handleEdit(row)">
              ç¼–è¾‘
            </el-button>
            <el-button size="small" type="danger" @click="handleDelete(row)">
              åˆ é™¤
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-card>
  </div>
</template>
```

### 2. æˆ‘çš„ä¸ŠæŠ¥é…ç½® (æ™®é€šç”¨æˆ·)

```vue
<!-- src/views/data-report/MyReportConfig.vue -->
<template>
  <div class="my-report-config">
    <el-card>
      <template #header>
        <span>æˆ‘çš„æ•°æ®ä¸ŠæŠ¥é…ç½®</span>
      </template>

      <el-descriptions :column="2" border>
        <el-descriptions-item label="é…ç½®åç§°">
          {{ config.configName || 'æœªé…ç½®' }}
        </el-descriptions-item>
        <el-descriptions-item label="ä¸ŠæŠ¥çŠ¶æ€">
          <el-tag :type="config.enabled ? 'success' : 'info'">
            {{ config.enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨' }}
          </el-tag>
        </el-descriptions-item>
        <el-descriptions-item label="ä¸ŠæŠ¥ç²’åº¦">
          {{ config.granularity || 'HOUR' }}
        </el-descriptions-item>
        <el-descriptions-item label="GPSä¼˜å…ˆçº§">
          {{ config.gpsPriority || 'BDS' }}
        </el-descriptions-item>
        <el-descriptions-item label="æœ€åä¸ŠæŠ¥æ—¶é—´">
          {{ config.lastReportTime || 'ä»æœªä¸ŠæŠ¥' }}
        </el-descriptions-item>
        <el-descriptions-item label="æˆåŠŸç‡">
          {{ calculateSuccessRate(config) }}%
        </el-descriptions-item>
      </el-descriptions>

      <el-divider />

      <el-space>
        <el-button type="primary" @click="handleEdit">
          ç¼–è¾‘é…ç½®
        </el-button>
        <el-button @click="handleTriggerReport" :loading="reporting">
          ç«‹å³ä¸ŠæŠ¥
        </el-button>
        <el-button @click="handleViewLog">
          æŸ¥çœ‹æ—¥å¿—
        </el-button>
      </el-space>
    </el-card>
  </div>
</template>
```

---

## ğŸ“‹ é…ç½®ç¤ºä¾‹

### application.yaml

```yaml
app:
  ems:
    features:
      data-report-enabled: ${EMS_FEATURE_DATA_REPORT:true}  # åŠŸèƒ½å¼€å…³

    data-report:
      # é»˜è®¤é…ç½®
      default-url: "http://59.225.208.12:18085/access/data/report"
      default-api-key: "AK-9lKIK7RZrHxPsxq9eYzb2BWBCq8WeSwIPC2e"
      public-key-url: "http://59.225.208.12:18085/system/openApi/getPublicKey"

      # SM2åŠ å¯†é…ç½®
      sm2:
        enabled: true
        public-key-cache-duration: 3600000  # 1å°æ—¶

      # ä¸ŠæŠ¥é…ç½®
      default-granularity: "HOUR"
      default-batch-size: 100
      max-retry-times: 3
      timeout-seconds: 30
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### Phase 1: åŸºç¡€è®¾æ–½ (1-2å¤©)
1. æ·»åŠ Bouncy Castleä¾èµ–(SM2åŠ å¯†)
2. åˆ›å»ºæ•°æ®åº“è¡¨
3. åˆ›å»ºå®ä½“ç±»å’ŒRepository
4. å®ç°åŸºç¡€çš„CRUDæœåŠ¡

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ (2-3å¤©)
1. å®ç°SM2åŠ å¯†å·¥å…·
2. å®ç°æ•°æ®è½¬æ¢æœåŠ¡
3. å®ç°HTTPä¸ŠæŠ¥é€»è¾‘
4. å®ç°å®šæ—¶ä»»åŠ¡

### Phase 3: å‰ç«¯é¡µé¢ (1-2å¤©)
1. é…ç½®ç®¡ç†é¡µé¢(ç®¡ç†å‘˜)
2. æˆ‘çš„é…ç½®é¡µé¢(æ™®é€šç”¨æˆ·)
3. æ—¥å¿—æŸ¥è¯¢é¡µé¢
4. ç»Ÿè®¡æŠ¥è¡¨é¡µé¢

### Phase 4: æµ‹è¯•ä¼˜åŒ– (1-2å¤©)
1. å•å…ƒæµ‹è¯•
2. é›†æˆæµ‹è¯•
3. æ€§èƒ½ä¼˜åŒ–
4. é”™è¯¯å¤„ç†ä¼˜åŒ–

---

## ğŸ“Š ä¸æ–¹æ¡ˆAçš„åŒºåˆ«

| ç‰¹æ€§ | æ–¹æ¡ˆA (é€šç”¨) | æ–¹æ¡ˆB (å®é™…æ¥å£) |
|-----|------------|----------------|
| é…ç½®å¤æ‚åº¦ | é«˜(å®Œå…¨è‡ªå®šä¹‰) | ä½(å›ºå®šç›®æ ‡) |
| ä¸ŠæŠ¥åœ°å€ | å¯é…ç½® | å›ºå®š |
| è®¤è¯æ–¹å¼ | çµæ´» | å›ºå®š(API Key) |
| æ•°æ®åŠ å¯† | å¯é€‰ | å¿…éœ€(SM2) |
| æ•°æ®æ ¼å¼ | çµæ´»æ¨¡æ¿ | å›ºå®šæ ¼å¼ |
| é€‚ç”¨åœºæ™¯ | å¤šæœºæ„ | å•ä¸€æœºæ„ |
| å®æ–½éš¾åº¦ | é«˜ | ä¸­ |

---

## âœ… æ¨èé‡‡ç”¨æ–¹æ¡ˆB

**ç†ç”±:**
1. âœ… ç¬¦åˆå®é™…æ¥å£æ–‡æ¡£è¦æ±‚
2. âœ… ç®€åŒ–é…ç½®,é™ä½å‡ºé”™å¯èƒ½
3. âœ… é›†æˆSM2å›½å¯†åŠ å¯†
4. âœ… ä¿æŒä¼ä¸šçº§éš”ç¦»
5. âœ… å®æ–½éš¾åº¦é€‚ä¸­

**æ˜¯å¦éœ€è¦ç®¡ç†å‘˜ç®¡ç†?**
- âœ… **éœ€è¦**,å› ä¸º:
  - éœ€è¦ä¸ºæ¯ä¸ªä¼ä¸šé…ç½®ä¸ŠæŠ¥å¼€å…³
  - éœ€è¦å…¨å±€ç›‘æ§ä¸ŠæŠ¥çŠ¶æ€
  - éœ€è¦æ’æŸ¥ä¸ŠæŠ¥å¤±è´¥é—®é¢˜
  - æ™®é€šç”¨æˆ·åªèƒ½æŸ¥çœ‹å’Œè§¦å‘è‡ªå·±çš„ä¸ŠæŠ¥
