# EMS系统测试指南

## 测试框架概述

本项目已经建立了完整的测试框架，包括：

### 1. 基础设施

- **测试配置**: `application-test.yaml` - 专用的测试配置文件
- **基础测试类**: `BaseIntegrationTest.java` - 提供通用的测试工具和配置
- **测试数据构建器**: `TestDataBuilder.java` - 用于生成测试数据

### 2. 测试类型

#### 集成测试
- 使用Spring Boot Test框架
- 使用H2内存数据库进行测试
- 自动回滚事务，确保测试之间的独立性

#### 单元测试
- 针对Service层逻辑测试
- Mock外部依赖
- 覆盖核心业务逻辑

#### API测试
- 使用MockMvc进行HTTP请求测试
- 完整的请求-响应周期测试
- 包含认证和权限测试

### 3. 已创建的测试用例

1. **DeviceDataReceiverControllerTest.java**
   - 测试设备数据接收API的各种场景
   - 包括成功案例、验证失败、设备不存在等
   - 测试批量数据接收功能
   - 验证API无需认证访问

2. **DeviceServiceTest.java**
   - 测试设备管理的CRUD操作
   - 测试设备查询和统计功能
   - 验证业务逻辑正确性

### 4. 运行测试

#### 运行所有测试
```bash
mvn test
```

#### 运行特定测试类
```bash
mvn test -Dtest=DeviceDataReceiverControllerTest
mvn test -Dtest=DeviceServiceTest
```

#### 运行特定测试方法
```bash
mvn test -Dtest=DeviceServiceTest#testCreateDevice_Success
```

### 5. 测试配置特性

#### 数据库配置
- 使用H2内存数据库，测试速度快
- 每次测试前自动重建表结构
- 测试数据自动回滚

#### 日志配置
- 详细的SQL日志输出
- DEBUG级别的业务日志
- 便于调试和问题定位

#### 数据初始化
- 测试环境下关闭自动数据初始化
- 使用TestDataBuilder创建测试数据
- 保证测试数据的可控性和可预测性

### 6. 测试覆盖范围

#### 控制器层测试
- ✅ 设备数据接收API
- ✅ 数据验证
- ✅ 错误处理
- ✅ 权限验证

#### 服务层测试
- ✅ 设备CRUD操作
- ✅ 数据查询
- ✅ 业务逻辑验证
- ✅ 异常处理

#### TODO: 待测试项目
- 企业管理API测试
- 用户管理API测试
- 数据查询API测试
- JWT认证相关测试
- 权限控制测试

### 7. 测试最佳实践

1. **测试命名规范**
   - 使用`[MethodName]_[Scenario]`格式
   - 中文描述清晰表达测试意图

2. **测试数据管理**
   - 使用TestDataBuilder创建测试数据
   - 避免硬编码测试数据
   - 确保测试数据的独立性

3. **断言验证**
   - 验证返回状态码
   - 验证返回数据内容
   - 验证数据库状态变化

4. **异常测试**
   - 测试各种异常场景
   - 验证错误消息正确性
   - 确保系统健壮性

### 8. 持续集成

建议在CI/CD流水线中包含以下测试步骤：

1. 编译检查
2. 单元测试执行
3. 集成测试执行
4. 测试覆盖率报告
5. 测试结果归档

### 9. 测试数据清理

测试框架使用`@Transactional`注解确保：
- 每个测试方法执行后自动回滚
- 测试之间数据完全隔离
- 不影响测试环境的数据状态

### 10. 性能测试建议

对于性能关键的功能，建议：
1. 使用JMeter进行压力测试
2. 监控数据库性能指标
3. 测试并发场景
4. 验证响应时间要求

## 下一步计划

1. 完善API覆盖率测试
2. 添加性能测试用例
3. 实现安全测试
4. 建立测试报告机制
5. 设置自动化测试流水线