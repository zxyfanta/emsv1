# HJ/T 212-2005 协议对比分析

## 当前实现 vs 官方协议

### 1. 通讯包结构

#### 官方协议要求（PDF第6.3.1节）
```
通讯包结构：
┌─────────────────────────────────────────────────┐
│ 包头 (2)  │ ## (固定标识)                          │
├─────────────────────────────────────────────────┤
│ 数据段长度 (4) │ 四位十进制数，表示数据段长度        │
├─────────────────────────────────────────────────┤
│ 数据段 (变长) │ 具体数据内容                       │
├─────────────────────────────────────────────────┤
│ CRC校验 (4)  │ 四位十六进制数，数据段校验码        │
├─────────────────────────────────────────────────┤
│ 包尾 (2)  │ <CR><LF> (回车换行)                   │
└─────────────────────────────────────────────────┘
```

#### 我们当前实现
```python
packet = f"##{data_length}{data_segment}{crc}\r\n"
```
✅ **符合协议**

---

### 2. 数据段结构（PDF第6.3.2节）

#### 官方协议字段顺序
```
QN=请求编号;ST=系统编号;CN=命令编号;PW=访问密码;CP=&&数据内容&&
```

#### 我们当前实现
```python
data_segment = f"QN={qn};ST=61;CN=3051;PW={password};CP=&&{cp_content}&&"
```
✅ **符合协议**

---

### 3. 实时数据上报（命令CN=3051）

#### 官方协议示例
根据PDF文档，实时数据上报的CP字段应包含：
```
CP=&&MN=设备编号;Pol=采样时间;CP=实时数据...&&
```

⚠️ **注意**：PDF中提到了**Pol（采样时间）**字段！

#### 我们当前实现
```python
cp_content = (
    f"MN={device_mn};"
    f"Ma=000001;"
    f"Rno=010101010101;"
    # ... 其他字段
)
```

❌ **可能缺少Pol字段** - 需要进一步确认

---

### 4. CRC校验计算

#### 官方协议（PDF第6.4节）
CRC16-CCITT算法：
- 多项式：0xA001
- 初始值：0xFFFF
- 计算范围：整个数据段

#### 我们当前实现
```python
def calculate_crc16(self, data):
    crc = 0xFFFF
    bytes_data = data.encode('ascii')
    for byte in bytes_data:
        crc ^= (byte & 0xFF)
        for _ in range(8):
            if (crc & 0x0001) != 0:
                crc >>= 1
                crc ^= 0xA001
            else:
                crc >>= 1
    return f"{crc:04X}"
```
✅ **符合协议**

---

### 5. 字段编码要求

#### 我们当前的字段
| 字段 | 值 | 协议要求 | 状态 |
|-----|---|---------|------|
| MN (设备编号) | 53386530019073 | 14位数字 | ✅ |
| Ma (探伤机编号) | 002162 | 6位数字 | ✅ |
| Rno (放射源编号) | DE25IR006722 | 12位？ | ⚠️ 包含字母 |
| Xtype (放射源类型) | 02 | 2位数字 | ✅ |
| LastAct (原始活度) | 5.530E012 | 科学计数法 | ✅ |
| NowAct (当前活度) | 3.270E012 | 科学计数法 | ✅ |
| SourceTime (出厂日期) | 20250703 | YYYYMMDD | ✅ |
| DataTime (数据时间) | 20251229140311 | YYYYMMDDHHmmss | ✅ |
| LONG (GPS经度) | 12102.1465 | 度分格式 | ✅ |
| LAT (GPS纬度) | 3740.5073 | 度分格式 | ✅ |

⚠️ **放射源编号包含字母** - 可能不符合纯数字要求

---

### 6. 服务器响应分析

#### 我们收到的响应
```
原始数据: E6 97 A0 E6 B3 95 E8 AF 86 E5 88 AB E7 9A 84 E6 95 B0 E6 8D AE E7 B1 BB E5 9E 8B
UTF-8解码: "无法识别的数据类型"
```

#### 官方协议响应格式（PDF第6.6节）
标准响应应该是：
```
##QN=...;ST=91;CN=3051;...&&CRC\r\n  (成功)
##QN=...;ST=92;CN=3051;...&&CRC\r\n  (失败)
```

❌ **问题**：服务器返回了纯文本错误消息，而不是协议格式的响应

---

## 结论与建议

### ✅ 符合协议的部分
1. 通讯包结构
2. CRC16校验算法
3. 基本字段格式
4. 数据段长度计算

### ⚠️ 可能的问题
1. **放射源编号包含字母**（DE25IR006722）
2. **可能缺少Pol（采样时间）字段**
3. **设备未在服务器注册**
4. **密码不正确**

### 🔍 建议的排查步骤

1. **确认放射源编号格式**
   - 检查是否必须为纯数字
   - 如果包含字母，转换为数字编码

2. **添加Pol字段**
   - 在CP中添加Pol=DataTime

3. **联系服务器管理员**
   - 确认设备是否已注册
   - 获取正确的访问密码
   - 查看服务器日志

4. **对比成功案例**
   - 获取其他设备成功的上报数据包
   - 逐字段对比差异

---

**文档版本**: v1.0
**更新日期**: 2024-12-29
**协议版本**: HJ/T 212-2005
